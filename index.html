<!doctype html>
<html lang="pt-BR" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestão de Estoque - COENG | DETEC</title>

    <!-- Favicon & Apple Touch Icon (Logótipo Azul) -->
    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml,%3Csvg version='1.1' id='Capa_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' viewBox='0 0 101.968 101.968' style='enable-background:new 0 0 101.968 101.968;' xml:space='preserve' fill='%233b82f6'%3E%3Cg%3E%3Cg%3E%3Cpath d='M24.715,47.432L7.968,64.86v29.406c0,0.828,0.671,1.5,1.5,1.5h20.334c0.828,0,1.5-0.672,1.5-1.5V49.158l-4.69-1.726H24.715z'/%3E%3Cpath d='M66.135,61.1H45.801c-0.828,0-1.5,0.672-1.5,1.5v31.666c0,0.828,0.672,1.5,1.5,1.5h20.334c0.829,0,1.5-0.672,1.5-1.5V62.6C67.635,61.772,66.964,61.1,66.135,61.1z'/%3E%3Cpath d='M101.724,29.49c-0.777,0.406-1.652,0.621-2.53,0.621c-1.276,0-2.521-0.45-3.5-1.27l-3.694-3.088l-13.365,14.58v53.934c0,0.828,0.672,1.5,1.5,1.5h20.334c0.829,0,1.5-0.672,1.5-1.5v-64.93C101.885,29.387,101.81,29.445,101.724,29.49z'/%3E%3Cpath d='M57.797,54.094c1.144,0.419,2.424,0.108,3.248-0.788l30.839-33.643l7.217,6.032c0.353,0.294,0.847,0.349,1.254,0.136c0.407-0.214,0.646-0.648,0.605-1.107L99.396,7.235c-0.055-0.625-0.606-1.086-1.231-1.029l-17.49,1.563c-0.458,0.041-0.846,0.354-0.982,0.791C79.646,8.706,79.631,8.854,79.644,9c0.026,0.294,0.167,0.572,0.403,0.769l7.229,6.043L57.98,47.769L24.535,35.463c-1.118-0.41-2.373-0.121-3.198,0.735l-20.5,21.333c-1.148,1.195-1.11,3.095,0.084,4.242c0.583,0.561,1.332,0.837,2.079,0.837c0.788,0,1.574-0.309,2.164-0.921l19.141-19.92L57.797,54.094z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"
    />
    <link
      rel="apple-touch-icon"
      href="data:image/svg+xml,%3Csvg version='1.1' id='Capa_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' viewBox='0 0 101.968 101.968' style='enable-background:new 0 0 101.968 101.968;' xml:space='preserve' fill='%233b82f6'%3E%3Cg%3E%3Cg%3E%3Cpath d='M24.715,47.432L7.968,64.86v29.406c0,0.828,0.671,1.5,1.5,1.5h20.334c0.828,0,1.5-0.672,1.5-1.5V49.158l-4.69-1.726H24.715z'/%3E%3Cpath d='M66.135,61.1H45.801c-0.828,0-1.5,0.672-1.5,1.5v31.666c0,0.828,0.672,1.5,1.5,1.5h20.334c0.829,0,1.5-0.672,1.5-1.5V62.6C67.635,61.772,66.964,61.1,66.135,61.1z'/%3E%3Cpath d='M101.724,29.49c-0.777,0.406-1.652,0.621-2.53,0.621c-1.276,0-2.521-0.45-3.5-1.27l-3.694-3.088l-13.365,14.58v53.934c0,0.828,0.672,1.5,1.5,1.5h20.334c0.829,0,1.5-0.672,1.5-1.5v-64.93C101.885,29.387,101.81,29.445,101.724,29.49z'/%3E%3Cpath d='M57.797,54.094c1.144,0.419,2.424,0.108,3.248-0.788l30.839-33.643l7.217,6.032c0.353,0.294,0.847,0.349,1.254,0.136c0.407-0.214,0.646-0.648,0.605-1.107L99.396,7.235c-0.055-0.625-0.606-1.086-1.231-1.029l-17.49,1.563c-0.458,0.041-0.846,0.354-0.982,0.791C79.646,8.706,79.631,8.854,79.644,9c0.026,0.294,0.167,0.572,0.403,0.769l7.229,6.043L57.98,47.769L24.535,35.463c-1.118-0.41-2.373-0.121-3.198,0.735l-20.5,21.333c-1.148,1.195-1.11,3.095,0.084,4.242c0.583,0.561,1.332,0.837,2.079,0.837c0.788,0,1.574-0.309,2.164-0.921l19.141-19.92L57.797,54.094z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"
    />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts: Inter -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Configurações Tailwind -->
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: { sans: ["Inter", "sans-serif"] },
            colors: {
              brand: {
                50: "#eff6ff",
                100: "#dbeafe",
                500: "#3b82f6",
                600: "#2563eb",
                700: "#1d4ed8",
                900: "#1e3a8a",
              },
              dark: {
                bg: "#0f172a", // Slate 900
                surface: "#1e293b", // Slate 800
                border: "#334155", // Slate 700
                text: "#f1f5f9", // Slate 100
                textMuted: "#94a3b8", // Slate 400
              },
            },
          },
        },
      };
    </script>

    <style>
      /* CSS Base e Utilitários */
      body {
        font-family: "Inter", sans-serif;
        -webkit-font-smoothing: antialiased;
      }

      /* Animações */
      .animate-fade-in {
        animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      }
      .animate-slide-up {
        animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      }
      .animate-scale-in {
        animation: scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      }
      .animate-spin-slow {
        animation: spin 2s linear infinite;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes scaleIn {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      /* Scrollbar Customizada Dark */
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #475569;
        border-radius: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #64748b;
      }

      /* Toast Notifications Container */
      #toast-container {
        position: fixed;
        top: 1.5rem;
        right: 1.5rem;
        z-index: 100;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        pointer-events: none;
      }
      .toast {
        pointer-events: auto;
        box-shadow:
          0 10px 15px -3px rgba(0, 0, 0, 0.5),
          0 4px 6px -2px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
      }
    </style>
  </head>
  <body
    class="bg-dark-bg text-dark-text h-screen overflow-hidden selection:bg-brand-500 selection:text-white"
  >
    <!-- Container de Notificações (Toasts) -->
    <div id="toast-container"></div>

    <!-- Tela de Carregamento Inicial -->
    <div
      id="loading-screen"
      class="fixed inset-0 bg-dark-bg z-[60] flex flex-col items-center justify-center"
    >
      <div class="relative w-16 h-16 mb-4">
        <div
          class="absolute inset-0 rounded-full border-4 border-slate-700"
        ></div>
        <div
          class="absolute inset-0 rounded-full border-4 border-brand-500 border-t-transparent animate-spin"
        ></div>
      </div>
      <h2 class="text-lg font-bold text-white">Conectando ao Firebase...</h2>
      <p class="text-sm text-slate-400 mt-2" id="loading-text">
        Sincronizando dados em tempo real
      </p>
    </div>

    <!-- ================== TELA DE LOGIN ================== -->
    <div
      id="login-layout"
      class="hidden flex h-full w-full items-center justify-center bg-dark-bg p-4"
    >
      <div
        class="w-full max-w-md bg-dark-surface rounded-2xl shadow-2xl p-8 animate-slide-up border border-dark-border"
      >
        <div class="text-center mb-8">
          <div
            class="bg-brand-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-brand-900/50 transform transition-transform hover:scale-105 duration-300"
          >
            <!-- SVG Personalizado: Increasing Stocks -->
            <svg
              class="w-8 h-8 text-white fill-current"
              version="1.1"
              id="Capa_1"
              xmlns="http://www.w3.org/2000/svg"
              xmlns:xlink="http://www.w3.org/1999/xlink"
              x="0px"
              y="0px"
              width="101.968px"
              height="101.968px"
              viewBox="0 0 101.968 101.968"
              style="enable-background: new 0 0 101.968 101.968"
              xml:space="preserve"
            >
              <g>
                <g>
                  <path
                    d="M24.715,47.432L7.968,64.86v29.406c0,0.828,0.671,1.5,1.5,1.5h20.334c0.828,0,1.5-0.672,1.5-1.5V49.158l-4.69-1.726H24.715z"
                  />
                  <path
                    d="M66.135,61.1H45.801c-0.828,0-1.5,0.672-1.5,1.5v31.666c0,0.828,0.672,1.5,1.5,1.5h20.334c0.829,0,1.5-0.672,1.5-1.5V62.6C67.635,61.772,66.964,61.1,66.135,61.1z"
                  />
                  <path
                    d="M101.724,29.49c-0.777,0.406-1.652,0.621-2.53,0.621c-1.276,0-2.521-0.45-3.5-1.27l-3.694-3.088l-13.365,14.58v53.934c0,0.828,0.672,1.5,1.5,1.5h20.334c0.829,0,1.5-0.672,1.5-1.5v-64.93C101.885,29.387,101.81,29.445,101.724,29.49z"
                  />
                  <path
                    d="M57.797,54.094c1.144,0.419,2.424,0.108,3.248-0.788l30.839-33.643l7.217,6.032c0.353,0.294,0.847,0.349,1.254,0.136c0.407-0.214,0.646-0.648,0.605-1.107L99.396,7.235c-0.055-0.625-0.606-1.086-1.231-1.029l-17.49,1.563c-0.458,0.041-0.846,0.354-0.982,0.791C79.646,8.706,79.631,8.854,79.644,9c0.026,0.294,0.167,0.572,0.403,0.769l7.229,6.043L57.98,47.769L24.535,35.463c-1.118-0.41-2.373-0.121-3.198,0.735l-20.5,21.333c-1.148,1.195-1.11,3.095,0.084,4.242c0.583,0.561,1.332,0.837,2.079,0.837c0.788,0,1.574-0.309,2.164-0.921l19.141-19.92L57.797,54.094z"
                  />
                </g>
              </g>
            </svg>
          </div>
          <h1 class="text-2xl font-bold text-white tracking-tight">
            Gestão de Estoque
          </h1>
          <p class="text-slate-400 mt-2 text-sm">
            Faça login para gerenciar o almoxarifado
          </p>
        </div>

        <form id="login-form" class="space-y-5">
          <div>
            <label
              class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-1.5"
              >Usuário</label
            >
            <div class="relative group">
              <i
                data-lucide="user"
                class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-500 group-focus-within:text-brand-500 transition-colors"
              ></i>
              <input
                type="text"
                id="login-username"
                placeholder="Digite seu usuário"
                class="w-full pl-10 pr-4 py-3 border border-dark-border bg-dark-bg text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-500/50 focus:border-brand-500 transition-all placeholder-slate-600"
                required
              />
            </div>
          </div>

          <div>
            <label
              class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-1.5"
              >Senha</label
            >
            <div class="relative group">
              <i
                data-lucide="lock"
                class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-500 group-focus-within:text-brand-500 transition-colors"
              ></i>
              <input
                type="password"
                id="login-password"
                placeholder="••••••••"
                class="w-full pl-10 pr-4 py-3 border border-dark-border bg-dark-bg text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-500/50 focus:border-brand-500 transition-all placeholder-slate-600"
                required
              />
            </div>
          </div>

          <div
            id="login-error"
            class="hidden p-3 bg-red-900/20 border border-red-900/50 text-red-400 text-sm rounded-lg flex items-center gap-2 animate-pulse"
          >
            <i data-lucide="alert-circle" class="w-4 h-4 flex-shrink-0"></i>
            <span>Usuário ou senha incorretos.</span>
          </div>

          <button
            type="submit"
            class="w-full bg-brand-600 text-white font-semibold py-3.5 rounded-xl hover:bg-brand-500 active:bg-brand-700 transition-all shadow-lg shadow-brand-900/30 flex items-center justify-center gap-2 group"
          >
            <span>Entrar no Sistema</span>
            <i
              data-lucide="arrow-right"
              class="w-5 h-5 group-hover:translate-x-1 transition-transform"
            ></i>
          </button>
        </form>

        <p class="text-center text-xs text-slate-600 mt-8 font-medium">
          Versão 7.1 History Features
        </p>
      </div>
    </div>

    <!-- ================== LAYOUT DA APLICAÇÃO (LATERAL) ================== -->
    <div id="app-layout" class="hidden h-full flex overflow-hidden bg-dark-bg">
      <!-- Mobile Overlay -->
      <div
        id="mobile-overlay"
        class="fixed inset-0 bg-black/50 z-20 hidden lg:hidden backdrop-blur-sm transition-opacity"
        onclick="App.toggleSidebar()"
      ></div>

      <!-- Sidebar -->
      <aside
        id="sidebar"
        class="fixed lg:static inset-y-0 left-0 z-30 w-72 bg-dark-surface border-r border-dark-border transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col shadow-2xl lg:shadow-none"
      >
        <!-- Sidebar Header (Logo) -->
        <div
          class="p-6 border-b border-dark-border flex items-center gap-3 bg-dark-bg/30"
        >
          <div class="bg-brand-600 p-2.5 rounded-xl shadow-sm">
            <svg
              class="w-6 h-6 text-white fill-current"
              version="1.1"
              id="Capa_1"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 101.968 101.968"
              style="enable-background: new 0 0 101.968 101.968"
              xml:space="preserve"
            >
              <g>
                <g>
                  <path
                    d="M24.715,47.432L7.968,64.86v29.406c0,0.828,0.671,1.5,1.5,1.5h20.334c0.828,0,1.5-0.672,1.5-1.5V49.158l-4.69-1.726H24.715z"
                  />
                  <path
                    d="M66.135,61.1H45.801c-0.828,0-1.5,0.672-1.5,1.5v31.666c0,0.828,0.672,1.5,1.5,1.5h20.334c0.829,0,1.5-0.672,1.5-1.5V62.6C67.635,61.772,66.964,61.1,66.135,61.1z"
                  />
                  <path
                    d="M101.724,29.49c-0.777,0.406-1.652,0.621-2.53,0.621c-1.276,0-2.521-0.45-3.5-1.27l-3.694-3.088l-13.365,14.58v53.934c0,0.828,0.672,1.5,1.5,1.5h20.334c0.829,0,1.5-0.672,1.5-1.5v-64.93C101.885,29.387,101.81,29.445,101.724,29.49z"
                  />
                  <path
                    d="M57.797,54.094c1.144,0.419,2.424,0.108,3.248-0.788l30.839-33.643l7.217,6.032c0.353,0.294,0.847,0.349,1.254,0.136c0.407-0.214,0.646-0.648,0.605-1.107L99.396,7.235c-0.055-0.625-0.606-1.086-1.231-1.029l-17.49,1.563c-0.458,0.041-0.846,0.354-0.982,0.791C79.646,8.706,79.631,8.854,79.644,9c0.026,0.294,0.167,0.572,0.403,0.769l7.229,6.043L57.98,47.769L24.535,35.463c-1.118-0.41-2.373-0.121-3.198,0.735l-20.5,21.333c-1.148,1.195-1.11,3.095,0.084,4.242c0.583,0.561,1.332,0.837,2.079,0.837c0.788,0,1.574-0.309,2.164-0.921l19.141-19.92L57.797,54.094z"
                  />
                </g>
              </g>
            </svg>
          </div>
          <div>
            <h1 class="font-bold text-lg text-white leading-tight">SEROB</h1>
            <p class="text-xs font-medium text-slate-400">Gestão de Estoque</p>
          </div>
        </div>

        <!-- Sidebar Navigation -->
        <nav class="p-4 space-y-1.5 flex-1 overflow-y-auto custom-scrollbar">
          <button
            onclick="App.navigate('dashboard')"
            id="nav-dashboard"
            class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold transition-all duration-200"
          >
            <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard
          </button>

          <!-- Menu Material (Com Submenu) -->
          <div>
            <button
              onclick="App.toggleSubmenu('submenu-material')"
              id="nav-material"
              class="w-full flex items-center justify-between px-4 py-3 rounded-xl text-sm font-semibold text-slate-400 hover:bg-slate-800 transition-all duration-200 group"
            >
              <div class="flex items-center gap-3">
                <i
                  data-lucide="package"
                  class="w-5 h-5 group-hover:text-brand-400 transition-colors"
                ></i>
                Material
              </div>
              <i
                data-lucide="chevron-down"
                id="arrow-material"
                class="w-4 h-4 text-slate-500 transition-transform duration-200"
              ></i>
            </button>
            <div id="submenu-material" class="hidden pl-4 pr-2 py-2 space-y-1">
              <button
                onclick="App.navigate('stock-search')"
                id="nav-stock-search"
                class="w-full flex items-center gap-2 px-4 py-2 rounded-lg text-xs font-medium text-slate-400 hover:text-brand-400 hover:bg-slate-800 transition-all"
              >
                Pesquisa de Estoque de Material
              </button>
              <button
                onclick="App.navigate('stock-move')"
                id="nav-stock-move"
                class="w-full flex items-center gap-2 px-4 py-2 rounded-lg text-xs font-medium text-slate-400 hover:text-brand-400 hover:bg-slate-800 transition-all"
              >
                Movimentação de Estoque
              </button>
              <button
                onclick="App.navigate('movement-search')"
                id="nav-mov-search"
                class="w-full flex items-center gap-2 px-4 py-2 rounded-lg text-xs font-medium text-slate-400 hover:text-brand-400 hover:bg-slate-800 transition-all"
              >
                Pesquisa de Movimentação
              </button>
              <button
                onclick="App.navigate('material-register')"
                id="nav-mat-register"
                class="w-full flex items-center gap-2 px-4 py-2 rounded-lg text-xs font-medium text-slate-400 hover:text-brand-400 hover:bg-slate-800 transition-all"
              >
                Cadastro de Material
              </button>
            </div>
          </div>
        </nav>

        <!-- Sidebar Footer (Profile) -->
        <div class="p-4 border-t border-dark-border space-y-4 bg-dark-bg/30">
          <!-- Profile Dropdown (Upward) -->
          <div class="relative group">
            <button
              class="w-full flex items-center gap-3 px-2 py-2 rounded-lg border border-transparent hover:border-slate-600 hover:bg-slate-800 transition-all cursor-pointer"
            >
              <div
                class="w-10 h-10 rounded-full bg-slate-700 border border-slate-600 flex items-center justify-center overflow-hidden"
                id="user-avatar"
              ></div>
              <div class="flex-1 overflow-hidden text-left">
                <p class="text-sm font-bold text-white truncate" id="user-name">
                  Usuário
                </p>
                <p class="text-xs text-slate-400 truncate" id="user-role">
                  Função
                </p>
                <!-- Status movido para cá -->
                <div class="flex items-center gap-1.5 mt-1">
                  <div
                    class="w-2 h-2 rounded-full bg-green-500 animate-pulse"
                  ></div>
                  <span class="text-[10px] font-medium text-slate-500"
                    >Online - Firebase</span
                  >
                </div>
              </div>
              <i data-lucide="chevron-up" class="w-4 h-4 text-slate-400"></i>
            </button>

            <!-- Dropdown Menu (Fixed padding bridge) -->
            <div
              class="absolute bottom-full left-0 w-full pb-2 hidden group-hover:block z-50"
            >
              <div
                class="bg-dark-surface rounded-xl shadow-xl border border-dark-border p-2 animate-scale-in origin-bottom"
              >
                <!-- Admin Only -->
                <div id="admin-tools" class="hidden">
                  <label
                    class="flex items-center gap-2 px-3 py-2 text-xs font-medium text-slate-300 hover:bg-slate-700 rounded-lg cursor-pointer transition-colors"
                  >
                    <i data-lucide="file-spreadsheet" class="w-3.5 h-3.5"></i>
                    Importar CSV
                    <input
                      type="file"
                      accept=".csv"
                      class="hidden"
                      onchange="App.handleFileUpload(event)"
                    />
                  </label>
                  <button
                    onclick="App.resetData()"
                    class="w-full flex items-center gap-2 px-3 py-2 text-xs font-medium text-red-400 hover:bg-red-900/20 rounded-lg transition-colors"
                  >
                    <i data-lucide="trash-2" class="w-3.5 h-3.5"></i> Resetar
                    Dados
                  </button>
                  <div class="border-t border-slate-700 my-1"></div>
                </div>

                <button
                  onclick="App.openPasswordModal()"
                  class="w-full flex items-center gap-2 px-3 py-2 text-xs font-medium text-slate-300 hover:bg-slate-700 rounded-lg transition-colors"
                >
                  <i data-lucide="key" class="w-3.5 h-3.5"></i> Alterar Senha
                </button>
                <button
                  onclick="App.logout()"
                  class="w-full flex items-center gap-2 px-3 py-2 text-xs font-medium text-red-400 hover:bg-red-900/20 rounded-lg transition-colors"
                >
                  <i data-lucide="log-out" class="w-3.5 h-3.5"></i> Sair
                </button>
              </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Main Content Area -->
      <main class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
        <!-- Mobile Header -->
        <header
          class="bg-dark-surface border-b border-dark-border p-4 flex items-center justify-between lg:hidden flex-shrink-0 z-10 shadow-sm"
        >
          <div class="flex items-center gap-3">
            <button
              onclick="App.toggleSidebar()"
              class="p-2 -ml-2 text-slate-300 hover:bg-slate-800 rounded-lg transition-colors"
            >
              <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
            <span class="font-bold text-white">Gestão de Estoque</span>
          </div>
          <div
            class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center overflow-hidden border border-slate-600"
            id="mobile-user-avatar"
          ></div>
        </header>

        <!-- Dynamic Content -->
        <div
          id="content-area"
          class="flex-1 overflow-y-auto p-4 lg:p-8 custom-scrollbar scroll-smooth text-slate-200"
        >
          <!-- Conteúdo injetado via JS -->
        </div>
      </main>
    </div>

    <!-- ================== MODALS ================== -->

    <!-- Modal Detalhes do Item -->
    <div
      id="modal-details"
      class="fixed inset-0 bg-black/70 z-50 hidden items-center justify-center p-4 backdrop-blur-sm transition-opacity opacity-0 pointer-events-none"
      aria-hidden="true"
    >
      <div
        class="bg-dark-surface rounded-2xl shadow-2xl max-w-2xl w-full p-6 transform scale-95 transition-all duration-300 border border-dark-border"
        id="modal-details-content"
      >
        <div
          class="flex justify-between items-start mb-6 pb-4 border-b border-slate-700"
        >
          <div>
            <h3
              class="text-xl font-bold text-white tracking-tight"
              id="detail-desc"
            >
              Nome do Material
            </h3>
            <p class="text-sm font-medium text-slate-400 mt-1" id="detail-cat">
              Categoria
            </p>
          </div>
          <button
            onclick="ModalManager.close('modal-details')"
            class="text-slate-400 hover:text-white hover:bg-slate-700 p-1.5 rounded-full transition-colors"
          >
            <i data-lucide="x" class="w-6 h-6"></i>
          </button>
        </div>
        <div class="grid grid-cols-12 gap-6">
          <!-- Box 1 -->
          <div class="col-span-12 md:col-span-6 space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <p
                  class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1"
                >
                  Código
                </p>
                <div
                  class="bg-dark-bg border border-dark-border rounded-lg px-3 py-2 text-sm font-mono text-slate-300"
                  id="detail-codigo"
                ></div>
              </div>
              <div>
                <p
                  class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1"
                >
                  Cód. Interno
                </p>
                <div
                  class="bg-dark-bg border border-dark-border rounded-lg px-3 py-2 text-sm font-mono text-slate-300"
                  id="detail-interno"
                ></div>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <p
                  class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1"
                >
                  Unid. Entrada
                </p>
                <div
                  class="bg-dark-bg border border-dark-border rounded-lg px-3 py-2 text-sm font-medium text-slate-300"
                  id="detail-uni-ent"
                ></div>
              </div>
              <div>
                <p
                  class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1"
                >
                  Unid. Saída
                </p>
                <div
                  class="bg-dark-bg border border-dark-border rounded-lg px-3 py-2 text-sm font-medium text-slate-300"
                  id="detail-uni-sai"
                ></div>
              </div>
            </div>
            <div>
              <p
                class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1"
              >
                Situação
              </p>
              <div
                class="flex items-center gap-4 bg-dark-bg border border-dark-border rounded-lg px-3 py-2"
              >
                <label
                  class="flex items-center gap-2 cursor-not-allowed opacity-75"
                >
                  <input
                    type="radio"
                    name="detail-status"
                    id="status-ativo"
                    disabled
                    class="accent-brand-600"
                  />
                  <span class="text-sm text-slate-300">Ativo</span>
                </label>
                <label
                  class="flex items-center gap-2 cursor-not-allowed opacity-75"
                >
                  <input
                    type="radio"
                    name="detail-status"
                    id="status-inativo"
                    disabled
                    class="accent-slate-500"
                  />
                  <span class="text-sm text-slate-300">Inativo</span>
                </label>
              </div>
            </div>
          </div>
          <!-- Box 2 -->
          <div class="col-span-12 md:col-span-6 space-y-4">
            <div>
              <p
                class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1"
              >
                Conversão de Saída
              </p>
              <div
                class="bg-dark-bg border border-dark-border rounded-lg px-3 py-2 text-sm font-mono text-slate-300 text-right"
                id="detail-conversao"
              ></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <p
                  class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1"
                >
                  Custo Sigmas
                </p>
                <div
                  class="bg-dark-bg border border-dark-border rounded-lg px-3 py-2 text-sm font-mono text-slate-300 text-right"
                  id="detail-custo-sigmas"
                ></div>
              </div>
              <div>
                <p
                  class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1"
                >
                  Custo Médio
                </p>
                <div
                  class="bg-dark-bg border border-dark-border rounded-lg px-3 py-2 text-sm font-mono text-slate-300 text-right"
                  id="detail-custo-medio"
                ></div>
              </div>
            </div>
          </div>
          <!-- Box 3 -->
          <div class="col-span-12 pt-4 border-t border-slate-700">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div
                class="bg-blue-900/20 border border-blue-800/50 p-3 rounded-xl text-center"
              >
                <p
                  class="text-[10px] font-bold text-blue-400 uppercase tracking-wider mb-1"
                >
                  Estoque Atual
                </p>
                <p
                  class="text-2xl font-bold text-blue-400 font-mono"
                  id="detail-est-atual"
                >
                  0
                </p>
              </div>
              <div
                class="bg-slate-800 border border-slate-700 p-3 rounded-xl text-center"
              >
                <p
                  class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1"
                >
                  Estoque Reuso
                </p>
                <p
                  class="text-xl font-bold text-slate-300 font-mono"
                  id="detail-est-reuso"
                >
                  0
                </p>
              </div>
              <div
                class="bg-purple-900/20 border border-purple-800/50 p-3 rounded-xl text-center"
              >
                <p
                  class="text-[10px] font-bold text-purple-400 uppercase tracking-wider mb-1"
                >
                  Estoque Total
                </p>
                <p
                  class="text-xl font-bold text-purple-400 font-mono"
                  id="detail-est-total"
                >
                  0
                </p>
              </div>
              <div
                class="bg-green-900/20 border border-green-800/50 p-3 rounded-xl text-center"
              >
                <p
                  class="text-[10px] font-bold text-green-400 uppercase tracking-wider mb-1"
                >
                  Custo Total
                </p>
                <p
                  class="text-xl font-bold text-green-400 font-mono"
                  id="detail-custo-total"
                >
                  R$ 0,00
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Senha -->
    <div
      id="modal-password"
      class="fixed inset-0 bg-black/70 z-50 hidden items-center justify-center p-4 backdrop-blur-sm transition-opacity opacity-0 pointer-events-none"
      aria-hidden="true"
    >
      <div
        class="bg-dark-surface rounded-2xl shadow-2xl max-w-md w-full p-6 transform scale-95 transition-all duration-300 border border-dark-border"
        id="modal-password-content"
      >
        <div class="flex justify-between items-start mb-6">
          <div>
            <h3 class="text-xl font-bold text-white tracking-tight">
              Alterar Senha
            </h3>
            <p class="text-sm text-slate-400 mt-1">
              Atualize suas credenciais de segurança
            </p>
          </div>
          <button
            onclick="ModalManager.close('modal-password')"
            class="text-slate-400 hover:text-white hover:bg-slate-700 p-1 rounded-full transition-colors"
          >
            <i data-lucide="x" class="w-6 h-6"></i>
          </button>
        </div>

        <form onsubmit="AuthController.changePassword(event)" class="space-y-4">
          <div>
            <label
              class="block text-xs font-bold text-slate-500 uppercase mb-1.5"
              >Senha Atual</label
            >
            <input
              type="password"
              id="pwd-current"
              class="w-full px-4 py-2.5 border border-dark-border bg-dark-bg text-white rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all"
              required
            />
          </div>
          <div>
            <label
              class="block text-xs font-bold text-slate-500 uppercase mb-1.5"
              >Nova Senha</label
            >
            <input
              type="password"
              id="pwd-new"
              class="w-full px-4 py-2.5 border border-dark-border bg-dark-bg text-white rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all"
              required
            />
          </div>
          <div>
            <label
              class="block text-xs font-bold text-slate-500 uppercase mb-1.5"
              >Confirmar Nova Senha</label
            >
            <input
              type="password"
              id="pwd-confirm"
              class="w-full px-4 py-2.5 border border-dark-border bg-dark-bg text-white rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all"
              required
            />
          </div>
          <div class="flex gap-3 pt-4">
            <button
              type="button"
              onclick="ModalManager.close('modal-password')"
              class="flex-1 px-4 py-2.5 rounded-xl font-semibold bg-dark-bg border border-dark-border text-slate-300 hover:bg-slate-800 transition-all"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="flex-1 px-4 py-2.5 rounded-xl font-bold bg-brand-600 text-white hover:bg-brand-500 shadow-md transition-all"
            >
              Salvar Alterações
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- ================== JAVASCRIPT ENGINE (MODULE) ================== -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        setDoc,
        doc,
        updateDoc,
        writeBatch,
        onSnapshot,
      } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
      import {
        getAuth,
        signInAnonymously,
      } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

      // Configuração fornecida pelo usuário
      const firebaseConfig = {
        apiKey: "AIzaSyDCu2wlBkSbD7wLvTmoZdz1ICjg5rpCzsM",
        authDomain: "gestao-de-estoque-20615.firebaseapp.com",
        projectId: "gestao-de-estoque-20615",
        storageBucket: "gestao-de-estoque-20615.firebasestorage.app",
        messagingSenderId: "925516712156",
        appId: "1:925516712156:web:4c8fa2f49982c03fca8c19",
      };

      // Inicialização Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // --- Dados Semente (Fallback e Migração) ---
      const DEFAULT_PASSWORD_HASH =
        "a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3";
      const SEED_USERS = [
        {
          name: "Jefferson de Araújo Silva",
          username: "jefferson",
          role: "admin",
          label: "Administrador",
          passwordHash: DEFAULT_PASSWORD_HASH,
        },
        {
          name: "Antônio Pinto Melo Sousa Júnior",
          username: "antonio",
          role: "user",
          label: "Usuário",
          passwordHash: DEFAULT_PASSWORD_HASH,
        },
        {
          name: "Jessé Souza dos Anjos",
          username: "jesse",
          role: "user",
          label: "Usuário",
          passwordHash: DEFAULT_PASSWORD_HASH,
        },
      ];

      const SEED_ITEMS = [
        // DEPÓSITO C4 - GÁS
        {
          id: 1,
          codigo: "B.16.04.007",
          codigoInterno: "39201",
          descricao: "GÁS 13 KG",
          categoria: "DEPÓSITO C4 - GÁS",
          unidade: "Unidade",
          estoque: 22,
          estoqueReuso: 0,
          estoqueMinimo: 5,
          qtdRessuprimento: 10,
          custoMedio: 45.0,
          unidadeEntrada: "Unidade",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 2,
          codigo: "B.16.04.006",
          codigoInterno: "39633",
          descricao: "BOTIJÃO DE GÁS P-13 (VASILHAME)",
          categoria: "DEPÓSITO C4 - GÁS",
          unidade: "Unidade",
          estoque: 30,
          estoqueReuso: 0,
          estoqueMinimo: 10,
          qtdRessuprimento: 15,
          custoMedio: 120.0,
          unidadeEntrada: "Unidade",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 3,
          codigo: "****",
          codigoInterno: "****",
          descricao: "GÁS EM USO",
          categoria: "DEPÓSITO C4 - GÁS",
          unidade: "Unidade",
          estoque: 4,
          estoqueReuso: 0,
          estoqueMinimo: 1,
          qtdRessuprimento: 2,
          custoMedio: 0.0,
          unidadeEntrada: "Unidade",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 4,
          codigo: "****",
          codigoInterno: "****",
          descricao: "BOTIJÃO VAZIO",
          categoria: "DEPÓSITO C4 - GÁS",
          unidade: "Unidade",
          estoque: 4,
          estoqueReuso: 0,
          estoqueMinimo: 1,
          qtdRessuprimento: 2,
          custoMedio: 0.0,
          unidadeEntrada: "Unidade",
          conversao: 1,
          situacao: "Ativo",
        },
        // DEPÓSITO 01 - IMPERMEABILIZAÇÃO
        {
          id: 5,
          codigo: "B.02.05.009",
          codigoInterno: "39630",
          descricao: "BOCAL PARA ARREMATES EM RALOS, D=100MM",
          categoria: "DEPÓSITO 01 - IMPERMEABILIZAÇÃO",
          unidade: "Peça",
          estoque: 28,
          estoqueReuso: 2,
          estoqueMinimo: 5,
          qtdRessuprimento: 10,
          custoMedio: 15.5,
          unidadeEntrada: "Caixa",
          conversao: 0.1,
          situacao: "Ativo",
        },
        {
          id: 6,
          codigo: "B.02.05.010",
          codigoInterno: "39631",
          descricao: "BOCAL PARA ARREMATES EM RALOS, D=150MM",
          categoria: "DEPÓSITO 01 - IMPERMEABILIZAÇÃO",
          unidade: "Peça",
          estoque: 10,
          estoqueReuso: 0,
          estoqueMinimo: 5,
          qtdRessuprimento: 10,
          custoMedio: 18.9,
          unidadeEntrada: "Caixa",
          conversao: 0.1,
          situacao: "Ativo",
        },
        {
          id: 7,
          codigo: "B.02.05.008",
          codigoInterno: "39632",
          descricao: "BOCAL PARA ARREMATES EM RALOS, D=75MM",
          categoria: "DEPÓSITO 01 - IMPERMEABILIZAÇÃO",
          unidade: "Peça",
          estoque: 25,
          estoqueReuso: 1,
          estoqueMinimo: 5,
          qtdRessuprimento: 10,
          custoMedio: 12.0,
          unidadeEntrada: "Caixa",
          conversao: 0.1,
          situacao: "Ativo",
        },
        {
          id: 8,
          codigo: "B.02.04.002",
          codigoInterno: "39787",
          descricao: "EMULSÃO ASFÁLTICA PARA IMPRIMAÇÃO (BASE ÁGUA)",
          categoria: "DEPÓSITO 01 - IMPERMEABILIZAÇÃO",
          unidade: "Balde",
          estoque: 4,
          estoqueReuso: 0,
          estoqueMinimo: 2,
          qtdRessuprimento: 5,
          custoMedio: 85.0,
          unidadeEntrada: "Balde",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 9,
          codigo: "B.02.03.001",
          codigoInterno: "20827",
          descricao: "IMPERMEABILIZANTE FLEXÍVEL BASE RESINA (5.000)",
          categoria: "DEPÓSITO 01 - IMPERMEABILIZAÇÃO",
          unidade: "Caixa",
          estoque: 95,
          estoqueReuso: 0,
          estoqueMinimo: 20,
          qtdRessuprimento: 50,
          custoMedio: 42.0,
          unidadeEntrada: "Pallet",
          conversao: 0.02,
          situacao: "Ativo",
        },
        {
          id: 10,
          codigo: "B.02.03.002",
          codigoInterno: "19437",
          descricao: "IMPERMEABILIZANTE SEMIFLEXÍVEL (1.000)",
          categoria: "DEPÓSITO 01 - IMPERMEABILIZAÇÃO",
          unidade: "Caixa",
          estoque: 93,
          estoqueReuso: 0,
          estoqueMinimo: 20,
          qtdRessuprimento: 50,
          custoMedio: 38.5,
          unidadeEntrada: "Pallet",
          conversao: 0.02,
          situacao: "Ativo",
        },
        {
          id: 11,
          codigo: "B.02.01.002",
          codigoInterno: "18389",
          descricao: "MANTA ANTIRAIZ",
          categoria: "DEPÓSITO 01 - IMPERMEABILIZAÇÃO",
          unidade: "m²",
          estoque: 110,
          estoqueReuso: 5,
          estoqueMinimo: 50,
          qtdRessuprimento: 100,
          custoMedio: 22.0,
          unidadeEntrada: "Rolo",
          conversao: 10,
          situacao: "Ativo",
        },
        {
          id: 12,
          codigo: "B.02.05.003",
          codigoInterno: "39789",
          descricao: "PAPEL KRAFT PARA IMPERMEABILIZAÇÃO",
          categoria: "DEPÓSITO 01 - IMPERMEABILIZAÇÃO",
          unidade: "Unidade",
          estoque: 300,
          estoqueReuso: 0,
          estoqueMinimo: 50,
          qtdRessuprimento: 100,
          custoMedio: 1.5,
          unidadeEntrada: "Fardo",
          conversao: 50,
          situacao: "Ativo",
        },
        {
          id: 13,
          codigo: "B.02.04.003",
          codigoInterno: "16493",
          descricao: "PRIMER ASFÁLTICO",
          categoria: "DEPÓSITO 01 - IMPERMEABILIZAÇÃO",
          unidade: "Galão",
          estoque: 10,
          estoqueReuso: 0,
          estoqueMinimo: 5,
          qtdRessuprimento: 10,
          custoMedio: 35.0,
          unidadeEntrada: "Galão",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 14,
          codigo: "B.02.02.003",
          codigoInterno: "27574",
          descricao: "SELANTE BRANCO",
          categoria: "DEPÓSITO 01 - IMPERMEABILIZAÇÃO",
          unidade: "Tubo",
          estoque: 336,
          estoqueReuso: 0,
          estoqueMinimo: 50,
          qtdRessuprimento: 100,
          custoMedio: 18.0,
          unidadeEntrada: "Caixa",
          conversao: 12,
          situacao: "Ativo",
        },
        {
          id: 15,
          codigo: "B.02.02.001",
          codigoInterno: "30314",
          descricao: "SELANTE CINZA",
          categoria: "DEPÓSITO 01 - IMPERMEABILIZAÇÃO",
          unidade: "Tubo",
          estoque: 444,
          estoqueReuso: 0,
          estoqueMinimo: 50,
          qtdRessuprimento: 100,
          custoMedio: 18.0,
          unidadeEntrada: "Caixa",
          conversao: 12,
          situacao: "Ativo",
        },
        {
          id: 16,
          codigo: "B.02.02.002",
          codigoInterno: "27575",
          descricao: "SELANTE PRETO",
          categoria: "DEPÓSITO 01 - IMPERMEABILIZAÇÃO",
          unidade: "Tubo",
          estoque: 144,
          estoqueReuso: 0,
          estoqueMinimo: 50,
          qtdRessuprimento: 100,
          custoMedio: 18.0,
          unidadeEntrada: "Caixa",
          conversao: 12,
          situacao: "Ativo",
        },
        {
          id: 17,
          codigo: "B.02.04.006",
          codigoInterno: "39685",
          descricao: "TINTA ASFÁLTICA ANTIRRAIZ",
          categoria: "DEPÓSITO 01 - IMPERMEABILIZAÇÃO",
          unidade: "Galão",
          estoque: 0,
          estoqueReuso: 0,
          estoqueMinimo: 5,
          qtdRessuprimento: 10,
          custoMedio: 45.0,
          unidadeEntrada: "Galão",
          conversao: 1,
          situacao: "Ativo",
        },
        // DEPÓSITO 02 - TINTA ESMALTE
        {
          id: 18,
          codigo: "B.10.03.003",
          codigoInterno: "25068",
          descricao: "FUNDO PARA AÇO GALVANIZADO",
          categoria: "DEPÓSITO 02 - TINTA ESMALTE",
          unidade: "Galão",
          estoque: 11,
          estoqueReuso: 0,
          estoqueMinimo: 5,
          qtdRessuprimento: 10,
          custoMedio: 55.0,
          unidadeEntrada: "Galão",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 19,
          codigo: "B.10.02.012",
          codigoInterno: "4121",
          descricao: "TINTA ESMALTE SINTÉTICO ACETINADO BRANCO GELO",
          categoria: "DEPÓSITO 02 - TINTA ESMALTE",
          unidade: "Galão",
          estoque: 31,
          estoqueReuso: 0,
          estoqueMinimo: 10,
          qtdRessuprimento: 15,
          custoMedio: 62.0,
          unidadeEntrada: "Galão",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 20,
          codigo: "B.10.02.011",
          codigoInterno: "4132",
          descricao: "TINTA ESMALTE SINTÉTICO ACETINADO BRANCO NEVE",
          categoria: "DEPÓSITO 02 - TINTA ESMALTE",
          unidade: "Galão",
          estoque: 11,
          estoqueReuso: 0,
          estoqueMinimo: 5,
          qtdRessuprimento: 10,
          custoMedio: 62.0,
          unidadeEntrada: "Galão",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 21,
          codigo: "B.10.02.006",
          codigoInterno: "4143",
          descricao: "TINTA ESMALTE SINTÉTICO ALTO BRILHO ALUMÍNIO",
          categoria: "DEPÓSITO 02 - TINTA ESMALTE",
          unidade: "Galão",
          estoque: 6,
          estoqueReuso: 0,
          estoqueMinimo: 2,
          qtdRessuprimento: 5,
          custoMedio: 58.0,
          unidadeEntrada: "Galão",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 22,
          codigo: "B.10.02.007",
          codigoInterno: "29091",
          descricao: "TINTA ESMALTE SINTÉTICO ALTO BRILHO AMARELO TRATOR",
          categoria: "DEPÓSITO 02 - TINTA ESMALTE",
          unidade: "Galão",
          estoque: 17,
          estoqueReuso: 0,
          estoqueMinimo: 5,
          qtdRessuprimento: 10,
          custoMedio: 60.0,
          unidadeEntrada: "Galão",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 23,
          codigo: "B.10.02.008",
          codigoInterno: "29094",
          descricao: "TINTA ESMALTE SINTÉTICO ALTO BRILHO AZUL MAR",
          categoria: "DEPÓSITO 02 - TINTA ESMALTE",
          unidade: "Galão",
          estoque: 9,
          estoqueReuso: 0,
          estoqueMinimo: 5,
          qtdRessuprimento: 10,
          custoMedio: 60.0,
          unidadeEntrada: "Galão",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 24,
          codigo: "B.10.02.002",
          codigoInterno: "4092",
          descricao: "TINTA ESMALTE SINTÉTICO ALTO BRILHO BRANCO",
          categoria: "DEPÓSITO 02 - TINTA ESMALTE",
          unidade: "Galão",
          estoque: 16,
          estoqueReuso: 0,
          estoqueMinimo: 5,
          qtdRessuprimento: 10,
          custoMedio: 55.0,
          unidadeEntrada: "Galão",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 25,
          codigo: "B.10.02.003",
          codigoInterno: "29090",
          descricao: "TINTA ESMALTE SINTÉTICO ALTO BRILHO BRANCO GELO",
          categoria: "DEPÓSITO 02 - TINTA ESMALTE",
          unidade: "Galão",
          estoque: 38,
          estoqueReuso: 0,
          estoqueMinimo: 10,
          qtdRessuprimento: 20,
          custoMedio: 55.0,
          unidadeEntrada: "Galão",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 26,
          codigo: "B.10.02.005",
          codigoInterno: "37914",
          descricao: "TINTA ESMALTE SINTÉTICO ALTO BRILHO CINZA MÉDIO",
          categoria: "DEPÓSITO 02 - TINTA ESMALTE",
          unidade: "Galão",
          estoque: 9,
          estoqueReuso: 0,
          estoqueMinimo: 5,
          qtdRessuprimento: 10,
          custoMedio: 58.0,
          unidadeEntrada: "Galão",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 27,
          codigo: "B.10.02.009",
          codigoInterno: "4128",
          descricao: "TINTA ESMALTE SINTÉTICO ALTO BRILHO PRETO",
          categoria: "DEPÓSITO 02 - TINTA ESMALTE",
          unidade: "Galão",
          estoque: 18,
          estoqueReuso: 0,
          estoqueMinimo: 5,
          qtdRessuprimento: 10,
          custoMedio: 58.0,
          unidadeEntrada: "Galão",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 28,
          codigo: "B.10.02.001",
          codigoInterno: "27439",
          descricao: "TINTA ESMALTE SINTÉTICO ALTO BRILHO VERDE COLONIAL",
          categoria: "DEPÓSITO 02 - TINTA ESMALTE",
          unidade: "Galão",
          estoque: 385,
          estoqueReuso: 10,
          estoqueMinimo: 50,
          qtdRessuprimento: 100,
          custoMedio: 58.0,
          unidadeEntrada: "Galão",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 29,
          codigo: "B.10.02.010",
          codigoInterno: "4071",
          descricao: "TINTA ESMALTE SINTÉTICO ALTO BRILHO VERMELHO",
          categoria: "DEPÓSITO 02 - TINTA ESMALTE",
          unidade: "Galão",
          estoque: 19,
          estoqueReuso: 0,
          estoqueMinimo: 5,
          qtdRessuprimento: 10,
          custoMedio: 60.0,
          unidadeEntrada: "Galão",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 30,
          codigo: "B.10.02.022",
          codigoInterno: "14790",
          descricao: "TINTA ESMALTE SINTÉTICO FOSCO PRETO",
          categoria: "DEPÓSITO 02 - TINTA ESMALTE",
          unidade: "Galão",
          estoque: 16,
          estoqueReuso: 0,
          estoqueMinimo: 5,
          qtdRessuprimento: 10,
          custoMedio: 55.0,
          unidadeEntrada: "Galão",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 31,
          codigo: "B.10.03.001",
          codigoInterno: "35974",
          descricao: "TINTA ESMALTE SINTÉTICO GRAFITE ESCURO",
          categoria: "DEPÓSITO 02 - TINTA ESMALTE",
          unidade: "Galão",
          estoque: 385,
          estoqueReuso: 5,
          estoqueMinimo: 50,
          qtdRessuprimento: 100,
          custoMedio: 60.0,
          unidadeEntrada: "Galão",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 32,
          codigo: "B.10.02.023",
          codigoInterno: "29096",
          descricao: "TINTA ESMALTE SINTÉTICO MARTELADO CINZA CLARO",
          categoria: "DEPÓSITO 02 - TINTA ESMALTE",
          unidade: "Galão",
          estoque: 5,
          estoqueReuso: 0,
          estoqueMinimo: 2,
          qtdRessuprimento: 5,
          custoMedio: 65.0,
          unidadeEntrada: "Galão",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 33,
          codigo: "B.10.03.006",
          codigoInterno: "20914",
          descricao: "TINTA SPRAY BRANCO",
          categoria: "DEPÓSITO 02 - TINTA ESMALTE",
          unidade: "Unidade",
          estoque: 420,
          estoqueReuso: 0,
          estoqueMinimo: 50,
          qtdRessuprimento: 100,
          custoMedio: 15.0,
          unidadeEntrada: "Caixa",
          conversao: 12,
          situacao: "Ativo",
        },
        {
          id: 34,
          codigo: "B.10.03.004",
          codigoInterno: "4159",
          descricao: "TINTA SPRAY PRETO FOSCO",
          categoria: "DEPÓSITO 02 - TINTA ESMALTE",
          unidade: "Unidade",
          estoque: 408,
          estoqueReuso: 0,
          estoqueMinimo: 50,
          qtdRessuprimento: 100,
          custoMedio: 15.0,
          unidadeEntrada: "Caixa",
          conversao: 12,
          situacao: "Ativo",
        },
        // DEPÓSITO 03 - COLA FÓRMICA
        {
          id: 35,
          codigo: "B.05.06.001",
          codigoInterno: "4617",
          descricao: "ADESIVO DE CONTATO - COLA FÓRMICA",
          categoria: "DEPÓSITO 03 - COLA FÓRMICA",
          unidade: "Galão",
          estoque: 956,
          estoqueReuso: 0,
          estoqueMinimo: 100,
          qtdRessuprimento: 200,
          custoMedio: 70.0,
          unidadeEntrada: "Galão",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 36,
          codigo: "B.16.04.008",
          codigoInterno: "27039",
          descricao: "GASOLINA COMUM",
          categoria: "DEPÓSITO 03 - COLA FÓRMICA",
          unidade: "Litro",
          estoque: 0,
          estoqueReuso: 0,
          estoqueMinimo: 10,
          qtdRessuprimento: 20,
          custoMedio: 5.8,
          unidadeEntrada: "Litro",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 37,
          codigo: "B.16.04.010",
          codigoInterno: "27040",
          descricao: "ÓLEO DIESEL",
          categoria: "DEPÓSITO 03 - COLA FÓRMICA",
          unidade: "Litro",
          estoque: 5,
          estoqueReuso: 0,
          estoqueMinimo: 10,
          qtdRessuprimento: 20,
          custoMedio: 4.5,
          unidadeEntrada: "Litro",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 38,
          codigo: "B.16.04.005",
          codigoInterno: "1544",
          descricao: "QUEROSENE 900 ML",
          categoria: "DEPÓSITO 03 - COLA FÓRMICA",
          unidade: "Lata",
          estoque: 83,
          estoqueReuso: 0,
          estoqueMinimo: 20,
          qtdRessuprimento: 40,
          custoMedio: 12.0,
          unidadeEntrada: "Lata",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 39,
          codigo: "B.05.06.002",
          codigoInterno: "1536",
          descricao: "SOLVENTE PARA ADESIVO DE CONTATO (REDUCOLA)",
          categoria: "DEPÓSITO 03 - COLA FÓRMICA",
          unidade: "Lata",
          estoque: 658,
          estoqueReuso: 0,
          estoqueMinimo: 50,
          qtdRessuprimento: 100,
          custoMedio: 25.0,
          unidadeEntrada: "Lata",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 40,
          codigo: "B.16.04.003",
          codigoInterno: "1538",
          descricao: "SOLVENTE THINNER",
          categoria: "DEPÓSITO 03 - COLA FÓRMICA",
          unidade: "Lata",
          estoque: 660,
          estoqueReuso: 0,
          estoqueMinimo: 50,
          qtdRessuprimento: 100,
          custoMedio: 18.0,
          unidadeEntrada: "Lata",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 41,
          codigo: "B.07.01.004",
          codigoInterno: "29098",
          descricao: "TINTA TRÁFEGO AMARELA",
          categoria: "DEPÓSITO 03 - COLA FÓRMICA",
          unidade: "Galão",
          estoque: 11,
          estoqueReuso: 0,
          estoqueMinimo: 5,
          qtdRessuprimento: 10,
          custoMedio: 80.0,
          unidadeEntrada: "Galão",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 42,
          codigo: "B.07.01.005",
          codigoInterno: "29097",
          descricao: "TINTA TRÁFEGO BRANCA",
          categoria: "DEPÓSITO 03 - COLA FÓRMICA",
          unidade: "Galão",
          estoque: 12,
          estoqueReuso: 0,
          estoqueMinimo: 5,
          qtdRessuprimento: 10,
          custoMedio: 80.0,
          unidadeEntrada: "Galão",
          conversao: 1,
          situacao: "Ativo",
        },
        // DEPÓSITO 04 - ÁLCOOL
        {
          id: 45,
          codigo: "B.16.04.001",
          codigoInterno: "5819",
          descricao: "ÁLCOOL",
          categoria: "DEPÓSITO 04 - ÁLCOOL",
          unidade: "Litro",
          estoque: 368,
          estoqueReuso: 0,
          estoqueMinimo: 100,
          qtdRessuprimento: 100,
          custoMedio: 8.5,
          unidadeEntrada: "Caixa",
          conversao: 12,
          situacao: "Ativo",
        },
        {
          id: 46,
          codigo: "B.16.04.002",
          codigoInterno: "37697",
          descricao: "ÁLCOOL EM GEL 2L",
          categoria: "DEPÓSITO 04 - ÁLCOOL",
          unidade: "Unidade",
          estoque: 102,
          estoqueReuso: 0,
          estoqueMinimo: 20,
          qtdRessuprimento: 50,
          custoMedio: 15.0,
          unidadeEntrada: "Caixa",
          conversao: 6,
          situacao: "Ativo",
        },
        // DEPÓSITO 12 - PISO VINÍLICO
        {
          id: 47,
          codigo: "B.18.01.001",
          codigoInterno: "39957",
          descricao: "PERFIL PARA ARREMATE DE CARPETE",
          categoria: "DEPÓSITO 12 - PISO VINÍLICO",
          unidade: "Metro",
          estoque: 111.0,
          estoqueReuso: 5.0,
          estoqueMinimo: 20,
          qtdRessuprimento: 50,
          custoMedio: 5.0,
          unidadeEntrada: "Barra",
          conversao: 3,
          situacao: "Ativo",
        },
        {
          id: 48,
          codigo: "B.08.01.010",
          codigoInterno: "13722",
          descricao: "PISO AZUL",
          categoria: "DEPÓSITO 12 - PISO VINÍLICO",
          unidade: "Caixa",
          estoque: 29.0,
          estoqueReuso: 0,
          estoqueMinimo: 10,
          qtdRessuprimento: 20,
          custoMedio: 120.0,
          unidadeEntrada: "Caixa",
          conversao: 5,
          situacao: "Ativo",
        },
        {
          id: 49,
          codigo: "B.08.01.007",
          codigoInterno: "3046",
          descricao: "PISO CINZA",
          categoria: "DEPÓSITO 12 - PISO VINÍLICO",
          unidade: "Caixa",
          estoque: 192.0,
          estoqueReuso: 2,
          estoqueMinimo: 50,
          qtdRessuprimento: 100,
          custoMedio: 120.0,
          unidadeEntrada: "Caixa",
          conversao: 5,
          situacao: "Ativo",
        },
        {
          id: 50,
          codigo: "B.08.01.009",
          codigoInterno: "3047",
          descricao: "PISO PRETO",
          categoria: "DEPÓSITO 12 - PISO VINÍLICO",
          unidade: "Caixa",
          estoque: 128.0,
          estoqueReuso: 0,
          estoqueMinimo: 20,
          qtdRessuprimento: 50,
          custoMedio: 120.0,
          unidadeEntrada: "Caixa",
          conversao: 5,
          situacao: "Ativo",
        },
        {
          id: 51,
          codigo: "B.08.01.003",
          codigoInterno: "35235",
          descricao: "PISO SEMIFLEXÍVEL MADEIRA",
          categoria: "DEPÓSITO 12 - PISO VINÍLICO",
          unidade: "m²",
          estoque: 393.8,
          estoqueReuso: 0,
          estoqueMinimo: 50,
          qtdRessuprimento: 100,
          custoMedio: 45.0,
          unidadeEntrada: "Caixa",
          conversao: 5,
          situacao: "Ativo",
        },
        {
          id: 52,
          codigo: "B.08.01.006",
          codigoInterno: "29864",
          descricao: "PISO VERDE-ITAMARATY",
          categoria: "DEPÓSITO 12 - PISO VINÍLICO",
          unidade: "m²",
          estoque: 672.0,
          estoqueReuso: 10.0,
          estoqueMinimo: 100,
          qtdRessuprimento: 200,
          custoMedio: 45.0,
          unidadeEntrada: "Caixa",
          conversao: 5,
          situacao: "Ativo",
        },
        {
          id: 53,
          codigo: "B.08.01.001",
          codigoInterno: "37736",
          descricao:
            "PISO VINÍLICO AUTOPORTANTE COR CINZA ESCURO 50 CM X 50 CM",
          categoria: "DEPÓSITO 12 - PISO VINÍLICO",
          unidade: "m²",
          estoque: 200.0,
          estoqueReuso: 0,
          estoqueMinimo: 50,
          qtdRessuprimento: 100,
          custoMedio: 80.0,
          unidadeEntrada: "Caixa",
          conversao: 4,
          situacao: "Ativo",
        },
        {
          id: 54,
          codigo: "B.08.01.004",
          codigoInterno: "35969",
          descricao: "RODAPÉ SEMIFLEXÍVEL",
          categoria: "DEPÓSITO 12 - PISO VINÍLICO",
          unidade: "Metro",
          estoque: 1094.4,
          estoqueReuso: 50.0,
          estoqueMinimo: 200,
          qtdRessuprimento: 500,
          custoMedio: 3.5,
          unidadeEntrada: "Rolo",
          conversao: 50,
          situacao: "Ativo",
        },
        // DEPÓSITO 25 - TINTA ACRÍLICA
        {
          id: 55,
          codigo: "B.16.10.001",
          codigoInterno: "25742",
          descricao: "FITA CREPE 25 MM X 50 M",
          categoria: "DEPÓSITO 25 - TINTA ACRÍLICA",
          unidade: "Rolo",
          estoque: 1104,
          estoqueReuso: 0,
          estoqueMinimo: 50,
          qtdRessuprimento: 100,
          custoMedio: 4.5,
          unidadeEntrada: "Caixa",
          conversao: 24,
          situacao: "Ativo",
        },
        {
          id: 56,
          codigo: "B.16.10.002",
          codigoInterno: "39894",
          descricao: "FITA CREPE 45 X 50M",
          categoria: "DEPÓSITO 25 - TINTA ACRÍLICA",
          unidade: "Unidade",
          estoque: 912,
          estoqueReuso: 0,
          estoqueMinimo: 50,
          qtdRessuprimento: 100,
          custoMedio: 7.0,
          unidadeEntrada: "Caixa",
          conversao: 24,
          situacao: "Ativo",
        },
        {
          id: 57,
          codigo: "B.10.06.001",
          codigoInterno: "35740",
          descricao: "GARFO PARA ROLO 23CM",
          categoria: "DEPÓSITO 25 - TINTA ACRÍLICA",
          unidade: "Peça",
          estoque: 216,
          estoqueReuso: 0,
          estoqueMinimo: 20,
          qtdRessuprimento: 50,
          custoMedio: 8.0,
          unidadeEntrada: "Caixa",
          conversao: 12,
          situacao: "Ativo",
        },
        {
          id: 58,
          codigo: "B.16.09.001",
          codigoInterno: "4636",
          descricao: "LIXA PARA MADEIRA Nº 60",
          categoria: "DEPÓSITO 25 - TINTA ACRÍLICA",
          unidade: "Unidade",
          estoque: 1050,
          estoqueReuso: 0,
          estoqueMinimo: 100,
          qtdRessuprimento: 200,
          custoMedio: 0.5,
          unidadeEntrada: "Pacote",
          conversao: 50,
          situacao: "Ativo",
        },
        {
          id: 59,
          codigo: "B.16.09.002",
          codigoInterno: "4637",
          descricao: "LIXA PARA MADEIRA Nº 80",
          categoria: "DEPÓSITO 25 - TINTA ACRÍLICA",
          unidade: "Unidade",
          estoque: 950,
          estoqueReuso: 0,
          estoqueMinimo: 100,
          qtdRessuprimento: 200,
          custoMedio: 0.5,
          unidadeEntrada: "Pacote",
          conversao: 50,
          situacao: "Ativo",
        },
        {
          id: 60,
          codigo: "B.16.09.003",
          codigoInterno: "4622",
          descricao: "LIXA PARA MADEIRA Nº 100",
          categoria: "DEPÓSITO 25 - TINTA ACRÍLICA",
          unidade: "Unidade",
          estoque: 1400,
          estoqueReuso: 0,
          estoqueMinimo: 100,
          qtdRessuprimento: 200,
          custoMedio: 0.5,
          unidadeEntrada: "Pacote",
          conversao: 50,
          situacao: "Ativo",
        },
        {
          id: 61,
          codigo: "B.16.09.004",
          codigoInterno: "4623",
          descricao: "LIXA PARA MADEIRA Nº 120",
          categoria: "DEPÓSITO 25 - TINTA ACRÍLICA",
          unidade: "Unidade",
          estoque: 4950,
          estoqueReuso: 0,
          estoqueMinimo: 100,
          qtdRessuprimento: 500,
          custoMedio: 0.5,
          unidadeEntrada: "Pacote",
          conversao: 50,
          situacao: "Ativo",
        },
        {
          id: 62,
          codigo: "B.16.09.005",
          codigoInterno: "4638",
          descricao: "LIXA PARA MADEIRA Nº 150",
          categoria: "DEPÓSITO 25 - TINTA ACRÍLICA",
          unidade: "Unidade",
          estoque: 750,
          estoqueReuso: 0,
          estoqueMinimo: 100,
          qtdRessuprimento: 200,
          custoMedio: 0.5,
          unidadeEntrada: "Pacote",
          conversao: 50,
          situacao: "Ativo",
        },
        {
          id: 63,
          codigo: "B.16.09.006",
          codigoInterno: "4624",
          descricao: "LIXA PARA MADEIRA Nº 180",
          categoria: "DEPÓSITO 25 - TINTA ACRÍLICA",
          unidade: "Unidade",
          estoque: 950,
          estoqueReuso: 0,
          estoqueMinimo: 100,
          qtdRessuprimento: 200,
          custoMedio: 0.5,
          unidadeEntrada: "Pacote",
          conversao: 50,
          situacao: "Ativo",
        },
        {
          id: 64,
          codigo: "B.16.09.007",
          codigoInterno: "35693",
          descricao: "LIXA PARA MADEIRA Nº 220",
          categoria: "DEPÓSITO 25 - TINTA ACRÍLICA",
          unidade: "Unidade",
          estoque: 200,
          estoqueReuso: 0,
          estoqueMinimo: 50,
          qtdRessuprimento: 100,
          custoMedio: 0.5,
          unidadeEntrada: "Pacote",
          conversao: 50,
          situacao: "Ativo",
        },
        {
          id: 65,
          codigo: "B.10.04.002",
          codigoInterno: "27573",
          descricao: "MASSA ACRÍLICA",
          categoria: "DEPÓSITO 25 - TINTA ACRÍLICA",
          unidade: "Lata",
          estoque: 6,
          estoqueReuso: 0,
          estoqueMinimo: 5,
          qtdRessuprimento: 10,
          custoMedio: 45.0,
          unidadeEntrada: "Lata",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 66,
          codigo: "B.10.04.001",
          codigoInterno: "19335",
          descricao: "MASSA CORRIDA",
          categoria: "DEPÓSITO 25 - TINTA ACRÍLICA",
          unidade: "Lata",
          estoque: 82,
          estoqueReuso: 5,
          estoqueMinimo: 10,
          qtdRessuprimento: 20,
          custoMedio: 35.0,
          unidadeEntrada: "Lata",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 67,
          codigo: "B.10.05.005",
          codigoInterno: "20664",
          descricao: "ROLO DE ESPUMA 15 CM",
          categoria: "DEPÓSITO 25 - TINTA ACRÍLICA",
          unidade: "Peça",
          estoque: 120,
          estoqueReuso: 10,
          estoqueMinimo: 20,
          qtdRessuprimento: 50,
          custoMedio: 5.5,
          unidadeEntrada: "Caixa",
          conversao: 24,
          situacao: "Ativo",
        },
        {
          id: 68,
          codigo: "B.10.05.007",
          codigoInterno: "20662",
          descricao: "ROLO DE ESPUMA 5 CM",
          categoria: "DEPÓSITO 25 - TINTA ACRÍLICA",
          unidade: "Peça",
          estoque: 288,
          estoqueReuso: 12,
          estoqueMinimo: 20,
          qtdRessuprimento: 50,
          custoMedio: 3.5,
          unidadeEntrada: "Caixa",
          conversao: 24,
          situacao: "Ativo",
        },
        {
          id: 69,
          codigo: "B.10.05.006",
          codigoInterno: "20663",
          descricao: "ROLO DE ESPUMA 9 CM",
          categoria: "DEPÓSITO 25 - TINTA ACRÍLICA",
          unidade: "Peça",
          estoque: 276,
          estoqueReuso: 0,
          estoqueMinimo: 20,
          qtdRessuprimento: 50,
          custoMedio: 4.5,
          unidadeEntrada: "Caixa",
          conversao: 24,
          situacao: "Ativo",
        },
        {
          id: 70,
          codigo: "B.10.05.003",
          codigoInterno: "35976",
          descricao: "ROLO DE LÃ 15 CM",
          categoria: "DEPÓSITO 25 - TINTA ACRÍLICA",
          unidade: "Peça",
          estoque: 192,
          estoqueReuso: 0,
          estoqueMinimo: 20,
          qtdRessuprimento: 50,
          custoMedio: 8.0,
          unidadeEntrada: "Caixa",
          conversao: 12,
          situacao: "Ativo",
        },
        {
          id: 71,
          codigo: "B.10.05.001",
          codigoInterno: "20665",
          descricao: "ROLO DE LÃ 23 CM PARA TETO (ANTI-GOTAS)",
          categoria: "DEPÓSITO 25 - TINTA ACRÍLICA",
          unidade: "Peça",
          estoque: 360,
          estoqueReuso: 0,
          estoqueMinimo: 20,
          qtdRessuprimento: 50,
          custoMedio: 15.0,
          unidadeEntrada: "Caixa",
          conversao: 12,
          situacao: "Ativo",
        },
        {
          id: 72,
          codigo: "B.10.05.004",
          codigoInterno: "26670",
          descricao: "ROLO DE LÃ 9 CM",
          categoria: "DEPÓSITO 25 - TINTA ACRÍLICA",
          unidade: "Peça",
          estoque: 540,
          estoqueReuso: 0,
          estoqueMinimo: 20,
          qtdRessuprimento: 100,
          custoMedio: 6.5,
          unidadeEntrada: "Caixa",
          conversao: 24,
          situacao: "Ativo",
        },
        {
          id: 73,
          codigo: "-",
          codigoInterno: "-",
          descricao:
            "ROLO DE LÃ EXTRA - PELE NOBRE DE CARNEIRO - 23 CM DE LARGURA E 25 MM DE ALTURA",
          categoria: "DEPÓSITO 25 - TINTA ACRÍLICA",
          unidade: "Peça",
          estoque: 6,
          estoqueReuso: 0,
          estoqueMinimo: 2,
          qtdRessuprimento: 10,
          custoMedio: 45.0,
          unidadeEntrada: "Unidade",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 74,
          codigo: "B.10.05.002",
          codigoInterno: "29101",
          descricao: "ROLO PARA PINTURA EPÓXI",
          categoria: "DEPÓSITO 25 - TINTA ACRÍLICA",
          unidade: "Peça",
          estoque: 60,
          estoqueReuso: 0,
          estoqueMinimo: 10,
          qtdRessuprimento: 20,
          custoMedio: 25.0,
          unidadeEntrada: "Caixa",
          conversao: 6,
          situacao: "Ativo",
        },
        {
          id: 75,
          codigo: "-",
          codigoInterno: "-",
          descricao: "SELADOR ACRILÍCO",
          categoria: "DEPÓSITO 25 - TINTA ACRÍLICA",
          unidade: "Lata",
          estoque: 3,
          estoqueReuso: 0,
          estoqueMinimo: 1,
          qtdRessuprimento: 5,
          custoMedio: 30.0,
          unidadeEntrada: "Lata",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 76,
          codigo: "B.10.01.001",
          codigoInterno: "27650",
          descricao: "TINTA ACRÍLICA FOSCA BRANCO NEVE",
          categoria: "DEPÓSITO 25 - TINTA ACRÍLICA",
          unidade: "Lata",
          estoque: 180,
          estoqueReuso: 0,
          estoqueMinimo: 20,
          qtdRessuprimento: 50,
          custoMedio: 220.0,
          unidadeEntrada: "Lata",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 77,
          codigo: "B.10.01.004",
          codigoInterno: "27651",
          descricao: "TINTA ACRÍLICA FOSCA CONCRETO",
          categoria: "DEPÓSITO 25 - TINTA ACRÍLICA",
          unidade: "Lata",
          estoque: 6,
          estoqueReuso: 0,
          estoqueMinimo: 2,
          qtdRessuprimento: 5,
          custoMedio: 220.0,
          unidadeEntrada: "Lata",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 78,
          codigo: "B.10.01.002",
          codigoInterno: "23150",
          descricao: "TINTA ACRÍLICA SEMIBRILHO BRANCO GELO 18 L",
          categoria: "DEPÓSITO 25 - TINTA ACRÍLICA",
          unidade: "Lata",
          estoque: 59,
          estoqueReuso: 0,
          estoqueMinimo: 10,
          qtdRessuprimento: 20,
          custoMedio: 280.0,
          unidadeEntrada: "Lata",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 79,
          codigo: "B.10.01.003",
          codigoInterno: "22924",
          descricao: "TINTA ACRÍLICA SEMIBRILHO BRANCO NEVE 18 L",
          categoria: "DEPÓSITO 25 - TINTA ACRÍLICA",
          unidade: "Lata",
          estoque: 39,
          estoqueReuso: 0,
          estoqueMinimo: 10,
          qtdRessuprimento: 10,
          custoMedio: 280.0,
          unidadeEntrada: "Lata",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 80,
          codigo: "B.10.01.005",
          codigoInterno: "19342",
          descricao: "TINTA LÁTEX ACRÍLICA PISO CINZA",
          categoria: "DEPÓSITO 25 - TINTA ACRÍLICA",
          unidade: "Lata",
          estoque: 11,
          estoqueReuso: 0,
          estoqueMinimo: 5,
          qtdRessuprimento: 5,
          custoMedio: 150.0,
          unidadeEntrada: "Lata",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 81,
          codigo: "B.10.01.006",
          codigoInterno: "19341",
          descricao: "TINTA LÁTEX ACRÍLICA PISO PRETO",
          categoria: "DEPÓSITO 25 - TINTA ACRÍLICA",
          unidade: "Lata",
          estoque: 4,
          estoqueReuso: 0,
          estoqueMinimo: 1,
          qtdRessuprimento: 5,
          custoMedio: 150.0,
          unidadeEntrada: "Lata",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 82,
          codigo: "B.10.05.009",
          codigoInterno: "4136",
          descricao: 'TRINCHA MACIA 1"',
          categoria: "DEPÓSITO 25 - TINTA ACRÍLICA",
          unidade: "Unidade",
          estoque: 300,
          estoqueReuso: 0,
          estoqueMinimo: 50,
          qtdRessuprimento: 100,
          custoMedio: 8.0,
          unidadeEntrada: "Caixa",
          conversao: 12,
          situacao: "Ativo",
        },
        {
          id: 83,
          codigo: "B.10.05.010",
          codigoInterno: "4134",
          descricao: 'TRINCHA MACIA 1.1/2"',
          categoria: "DEPÓSITO 25 - TINTA ACRÍLICA",
          unidade: "Unidade",
          estoque: 492,
          estoqueReuso: 0,
          estoqueMinimo: 50,
          qtdRessuprimento: 100,
          custoMedio: 10.0,
          unidadeEntrada: "Caixa",
          conversao: 12,
          situacao: "Ativo",
        },
        {
          id: 84,
          codigo: "B.10.05.011",
          codigoInterno: "4137",
          descricao: 'TRINCHA MACIA 2"',
          categoria: "DEPÓSITO 25 - TINTA ACRÍLICA",
          unidade: "Unidade",
          estoque: 492,
          estoqueReuso: 0,
          estoqueMinimo: 50,
          qtdRessuprimento: 100,
          custoMedio: 14.0,
          unidadeEntrada: "Caixa",
          conversao: 12,
          situacao: "Ativo",
        },
        {
          id: 85,
          codigo: "B.10.05.013",
          codigoInterno: "29102",
          descricao: 'TRINCHA PARA TINTA EPÓXI 3"',
          categoria: "DEPÓSITO 25 - TINTA ACRÍLICA",
          unidade: "Unidade",
          estoque: 252,
          estoqueReuso: 0,
          estoqueMinimo: 20,
          qtdRessuprimento: 50,
          custoMedio: 18.0,
          unidadeEntrada: "Caixa",
          conversao: 12,
          situacao: "Ativo",
        },
      ];

      // --- Serviços (Firestore) ---

      const FirestoreService = {
        users: [],
        items: [],
        history: [], // Add history array

        async init() {
          try {
            await signInAnonymously(auth);
            console.log("Conectado ao Firebase.");
            await this.syncUsers();

            await new Promise((resolve) => {
              this.setupRealtimeListener(resolve);
            });
          } catch (e) {
            console.error("Erro ao conectar Firebase:", e);
            alert("Erro ao conectar ao banco de dados. Verifique sua conexão.");
          }
        },

        async syncUsers() {
          const usersRef = collection(db, "users");
          const usersSnap = await getDocs(usersRef);

          if (usersSnap.empty) {
            const localUsers = JSON.parse(
              localStorage.getItem("serob_db_users"),
            );
            const usersToUpload = localUsers || SEED_USERS;
            const batch = writeBatch(db);
            for (const user of usersToUpload) {
              if (user.password && !user.passwordHash) {
                user.passwordHash = await SecurityUtils.hash(user.password);
                delete user.password;
              }
              const docRef = doc(db, "users", user.username);
              batch.set(docRef, user);
            }
            await batch.commit();
            this.users = usersToUpload;
          } else {
            this.users = usersSnap.docs.map((d) => d.data());
          }
        },

        setupRealtimeListener(onFirstLoad) {
          const itemsRef = collection(db, "items");

          // Listener for Items
          onSnapshot(itemsRef, async (snapshot) => {
            if (snapshot.empty) {
              document.getElementById("loading-text").innerText =
                "Criando banco de dados...";
              const localItems = JSON.parse(
                localStorage.getItem("serob_db_items"),
              );
              const itemsToUpload = localItems || SEED_ITEMS;
              const batch = writeBatch(db);
              itemsToUpload.forEach((item) => {
                const docRef = doc(db, "items", String(item.id));
                batch.set(docRef, item);
              });
              await batch.commit();
            } else {
              this.items = snapshot.docs
                .map((d) => d.data())
                .sort((a, b) => {
                  const catA = (a.categoria || "").toString();
                  const catB = (b.categoria || "").toString();
                  const diffCat = catA.localeCompare(catB, "pt-BR", {
                    numeric: true,
                    sensitivity: "base",
                  });
                  if (diffCat !== 0) return diffCat;
                  const descA = (a.descricao || "").toString();
                  const descB = (b.descricao || "").toString();
                  return descA.localeCompare(descB, "pt-BR", {
                    numeric: true,
                    sensitivity: "base",
                  });
                });

              this.checkAndMigrateItems();

              if (window.App && typeof window.App.refreshUI === "function") {
                window.App.refreshUI();
              }

              if (onFirstLoad) {
                onFirstLoad();
                onFirstLoad = null;
              }
            }
          });

          // Listener for History
          const historyRef = collection(db, "history");
          onSnapshot(historyRef, (snapshot) => {
            this.history = snapshot.docs
              .map((d) => d.data())
              .sort((a, b) => b.timestamp - a.timestamp);
            if (window.App && window.App.currentTab === "movement-search") {
              window.App.refreshUI();
            }
          });
        },

        checkAndMigrateItems() {
          const batch = writeBatch(db);
          let hasUpdates = false;

          this.items.forEach((item) => {
            const seed = SEED_ITEMS.find((s) => s.id === item.id);
            if (seed) {
              let updated = false;
              const fields = [
                "qtdRessuprimento",
                "estoqueMinimo",
                "custoMedio",
                "unidadeEntrada",
                "conversao",
                "situacao",
                "estoqueReuso",
              ];
              const updates = {};

              fields.forEach((field) => {
                if (item[field] === undefined) {
                  updates[field] = seed[field];
                  updated = true;
                }
              });

              if (updated) {
                const docRef = doc(db, "items", String(item.id));
                batch.update(docRef, updates);
                hasUpdates = true;
              }
            }
          });

          if (hasUpdates) {
            console.log("Sincronizando novos campos estendidos...");
            batch.commit();
          }
        },

        async updateStock(id, qty, type, username, motive) {
          const itemIndex = this.items.findIndex(
            (i) => String(i.id) === String(id),
          );

          if (itemIndex === -1) {
            console.error("Item não encontrado para o ID:", id);
            return false;
          }

          const item = this.items[itemIndex];
          let newStock = item.estoque;
          if (type === "entrada") newStock += qty;
          else newStock = Math.max(0, newStock - qty);

          try {
            const batch = writeBatch(db);

            // Update Item
            const itemRef = doc(db, "items", String(id));
            batch.update(itemRef, { estoque: newStock });

            // Add History Log
            const historyRef = doc(collection(db, "history"));
            batch.set(historyRef, {
              itemId: String(id),
              itemCode: item.codigo,
              itemDesc: item.descricao,
              type: type,
              quantity: qty,
              user: username,
              motive: motive || "",
              date: new Date().toISOString(),
              timestamp: Date.now(),
            });

            await batch.commit();
            return true;
          } catch (e) {
            console.error("Erro ao salvar no Firebase:", e);
            return false;
          }
        },

        async updateUserPassword(username, newHash) {
          try {
            const userRef = doc(db, "users", username);
            await updateDoc(userRef, { passwordHash: newHash });
            const userIndex = this.users.findIndex(
              (u) => u.username === username,
            );
            if (userIndex > -1) this.users[userIndex].passwordHash = newHash;
            return true;
          } catch (e) {
            console.error(e);
            return false;
          }
        },

        async importItems(newItems) {
          const batch = writeBatch(db);
          newItems.forEach((item) => {
            const docRef = doc(db, "items", String(item.id));
            batch.set(docRef, item);
          });
          await batch.commit();
          this.items = [...this.items, ...newItems];
          return true;
        },

        async addItem(newItem) {
          try {
            const newId = Date.now();
            const itemWithId = { ...newItem, id: newId };
            const docRef = doc(db, "items", String(newId));
            await setDoc(docRef, itemWithId);
            return true;
          } catch (e) {
            console.error("Erro ao adicionar item:", e);
            return false;
          }
        },
      };

      const SecurityUtils = {
        async hash(string) {
          const utf8 = new TextEncoder().encode(string);
          const hashBuffer = await crypto.subtle.digest("SHA-256", utf8);
          const hashArray = Array.from(new Uint8Array(hashBuffer));
          return hashArray.map((b) => b.toString(16).padStart(2, "0")).join("");
        },
      };

      const AuthService = {
        state: { currentUser: null },

        async login(username, password) {
          const users = FirestoreService.users;
          const targetUser = users.find(
            (u) => u.username === username.toLowerCase().trim(),
          );
          if (!targetUser) return false;
          const inputHash = await SecurityUtils.hash(password);
          if (targetUser.passwordHash === inputHash) {
            this.state.currentUser = targetUser;
            localStorage.setItem("serob_session", JSON.stringify(targetUser));
            return true;
          }
          return false;
        },

        logout() {
          this.state.currentUser = null;
          localStorage.removeItem("serob_session");
        },

        async changePassword(newPassword) {
          if (!this.state.currentUser) return false;
          const newHash = await SecurityUtils.hash(newPassword);
          if (
            await FirestoreService.updateUserPassword(
              this.state.currentUser.username,
              newHash,
            )
          ) {
            this.state.currentUser.passwordHash = newHash;
            localStorage.setItem(
              "serob_session",
              JSON.stringify(this.state.currentUser),
            );
            return true;
          }
          return false;
        },

        getCurrentUser() {
          return this.state.currentUser;
        },

        restoreSession() {
          const user = JSON.parse(localStorage.getItem("serob_session"));
          if (user) this.state.currentUser = user;
        },

        isAdmin() {
          return (
            this.state.currentUser && this.state.currentUser.role === "admin"
          );
        },
      };

      // --- UI Managers ---
      const ToastManager = {
        container: document.getElementById("toast-container"),
        show(message, type = "success") {
          const toast = document.createElement("div");
          const colors = type === "success" ? "bg-green-500" : "bg-red-500";
          const icon = type === "success" ? "check-circle" : "alert-circle";
          toast.className = `toast flex items-center gap-3 px-4 py-3 rounded-xl text-white ${colors} animate-scale-in`;
          toast.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5"></i><span class="font-medium text-sm">${message}</span>`;
          this.container.appendChild(toast);
          lucide.createIcons();
          setTimeout(() => {
            toast.style.opacity = "0";
            toast.style.transform = "translateY(-10px)";
            setTimeout(() => toast.remove(), 300);
          }, 3000);
        },
      };

      const ModalManager = {
        open(id) {
          const modal = document.getElementById(id);
          if (!modal) return;
          modal.classList.remove("hidden");
          modal.classList.add("flex");
          requestAnimationFrame(() => {
            modal.classList.remove("opacity-0", "pointer-events-none");
            modal
              .querySelector('div[id$="-content"]')
              ?.classList.remove("scale-95");
            modal
              .querySelector('div[id$="-content"]')
              ?.classList.add("scale-100");
          });
        },
        close(id) {
          const modal = document.getElementById(id);
          if (!modal) return;
          modal.classList.add("opacity-0", "pointer-events-none");
          modal
            .querySelector('div[id$="-content"]')
            ?.classList.remove("scale-100");
          modal.querySelector('div[id$="-content"]')?.classList.add("scale-95");
          setTimeout(() => {
            modal.classList.add("hidden");
            modal.classList.remove("flex");
          }, 300);
        },
      };

      // --- Controllers ---
      const AuthController = {
        async handleLogin(e) {
          e.preventDefault();
          const user = document.getElementById("login-username").value;
          const pass = document.getElementById("login-password").value;
          const btn = e.target.querySelector("button");
          const originalText = btn.innerHTML;

          btn.innerHTML = `<i data-lucide="loader" class="w-5 h-5 animate-spin"></i>`;
          lucide.createIcons();
          btn.disabled = true;

          try {
            if (await AuthService.login(user, pass)) {
              App.initLayout();
            } else {
              const err = document.getElementById("login-error");
              err.classList.remove("hidden");
              setTimeout(() => err.classList.add("hidden"), 3000);
            }
          } catch (err) {
            console.error(err);
            alert("Erro ao fazer login. Verifique o console.");
          } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
            lucide.createIcons();
          }
        },

        async changePassword(e) {
          e.preventDefault();
          const current = document.getElementById("pwd-current").value;
          const newPwd = document.getElementById("pwd-new").value;
          const confirm = document.getElementById("pwd-confirm").value;
          const currentUser = AuthService.getCurrentUser();

          const currentHash = await SecurityUtils.hash(current);
          if (currentHash !== currentUser.passwordHash) {
            ToastManager.show("Senha atual incorreta.", "error");
            return;
          }
          if (newPwd.length < 3) {
            ToastManager.show("Nova senha muito curta.", "error");
            return;
          }
          if (newPwd !== confirm) {
            ToastManager.show("Confirmação não coincide.", "error");
            return;
          }

          const btn = e.target.querySelector('button[type="submit"]');
          const originalText = btn.innerHTML;
          btn.innerHTML = "Salvando...";
          btn.disabled = true;

          if (await AuthService.changePassword(newPwd)) {
            ToastManager.show("Senha alterada com sucesso!");
            ModalManager.close("modal-password");
            e.target.reset();
          } else {
            ToastManager.show("Erro ao salvar senha.", "error");
          }

          btn.innerHTML = originalText;
          btn.disabled = false;
        },
      };

      const InventoryController = {
        state: {
          activeModalItem: null,
          activeModalType: "entrada",
          searchTerm: "",
          categoryFilter: "Todas",
          historySearchTerm: "",
        },

        openMovementModal(itemId, type) {
          const item = FirestoreService.items.find((i) => i.id === itemId);
          if (!item) return;
          this.state.activeModalItem = item;
          this.state.activeModalType = type;
          document.getElementById("modal-mov-title").innerText =
            type === "entrada" ? "Registrar Entrada" : "Registrar Saída";
          document.getElementById("modal-mov-item").innerText = item.descricao;
          document.getElementById("modal-mov-current").innerText = item.estoque;
          document.getElementById("modal-mov-qty").value = 1;
          const btn = document.getElementById("modal-mov-confirm");
          btn.className = `flex-1 px-4 py-3 rounded-xl font-bold text-white shadow-lg transition-all transform active:scale-95 ${type === "entrada" ? "bg-green-600 hover:bg-green-700 shadow-green-600/20" : "bg-red-600 hover:bg-red-700 shadow-red-600/20"}`;
          this.calculateNewStock();
          ModalManager.open("modal-movement");
        },

        calculateNewStock() {
          const qty =
            parseInt(document.getElementById("modal-mov-qty").value) || 0;
          const current = this.state.activeModalItem.estoque;
          let newVal = 0;
          const el = document.getElementById("modal-mov-new");
          if (this.state.activeModalType === "entrada") {
            newVal = current + qty;
            el.className = "text-2xl font-mono font-bold text-green-600";
          } else {
            newVal = Math.max(0, current - qty);
            el.className = "text-2xl font-mono font-bold text-red-600";
          }
          el.innerText = newVal;
        },

        adjustQty(delta) {
          const input = document.getElementById("modal-mov-qty");
          let val = parseInt(input.value) || 0;
          val = Math.max(1, val + delta);
          input.value = val;
          this.calculateNewStock();
        },

        async confirmMovement() {
          const qty =
            parseInt(document.getElementById("modal-mov-qty").value) || 0;
          if (qty <= 0) return;

          const btn = document.getElementById("modal-mov-confirm");
          const originalText = btn.innerText;
          btn.innerText = "Salvando...";
          btn.disabled = true;

          const user = AuthService.getCurrentUser();
          const motivo = "Movimentação rápida via tabela";

          if (
            await FirestoreService.updateStock(
              this.state.activeModalItem.id,
              qty,
              this.state.activeModalType,
              user.username,
              motivo,
            )
          ) {
            ToastManager.show(`Movimentação salva no Firebase!`);
            ModalManager.close("modal-movement");
          } else {
            ToastManager.show("Erro ao salvar.", "error");
          }

          btn.innerText = originalText;
          btn.disabled = false;
        },

        handleSearch(val) {
          this.state.searchTerm = val;
          App.renderTableRows();
        },

        handleHistorySearch(val) {
          this.state.historySearchTerm = val;
          App.renderHistoryRows();
        },

        handleAdvancedSearch() {
          const nameVal = document.getElementById("search-name").value;
          const codeVal = document.getElementById("search-code").value;
          this.state.searchTerm = nameVal || codeVal;
          App.renderTableRows();
        },

        handleCategory(val) {
          this.state.categoryFilter = val;
          App.renderTableRows();
        },

        async saveNewItem(e) {
          e.preventDefault();
          const btn = e.target.querySelector('button[type="submit"]');
          const originalText = btn.innerText;
          btn.innerText = "Salvando...";
          btn.disabled = true;

          const newItem = {
            codigo: document.getElementById("new-codigo").value,
            codigoInterno: document.getElementById("new-codigo-interno").value,
            descricao: document.getElementById("new-descricao").value,
            categoria: document.getElementById("new-categoria").value,
            unidade: document.getElementById("new-unidade").value,
            estoque:
              parseFloat(document.getElementById("new-estoque").value) || 0,
            estoqueMinimo:
              parseFloat(document.getElementById("new-minimo").value) || 0,
            qtdRessuprimento:
              parseFloat(document.getElementById("new-ressup").value) || 0,
          };

          const success = await FirestoreService.addItem(newItem);

          if (success) {
            ToastManager.show("Material cadastrado com sucesso!");
            e.target.reset();
          } else {
            ToastManager.show("Erro ao cadastrar material.", "error");
          }

          btn.innerText = originalText;
          btn.disabled = false;
        },

        onMaterialSelect(id) {
          const item = FirestoreService.items.find(
            (i) => String(i.id) === String(id),
          );
          const footer = document.getElementById("mov-footer-details");

          if (!item) {
            document.getElementById("mov-codigo").value = "";
            document.getElementById("mov-sigmas").value = "";
            document.getElementById("mov-uni-ent").value = "";
            document.getElementById("mov-uni-sai").value = "";
            document.getElementById("mov-fator").value = "";
            footer.classList.add("hidden");
            return;
          }

          document.getElementById("mov-codigo").value = item.codigo;
          document.getElementById("mov-sigmas").value =
            item.codigoInterno || "-";

          const uniEnt = item.unidadeEntrada || item.unidade;
          const uniSai = item.unidade;
          const fator = item.conversao || 1;

          document.getElementById("mov-uni-ent").value = uniEnt;
          document.getElementById("mov-uni-sai").value = uniSai;
          document.getElementById("mov-fator").value = fator;

          document.getElementById("info-est-atual").innerText = item.estoque;
          document.getElementById("info-est-reuso").innerText =
            item.estoqueReuso || 0;
          const custo = item.custoMedio || 0;
          document.getElementById("info-custo-medio").innerText =
            "R$ " + custo.toFixed(2);
          document.getElementById("info-custo-total").innerText =
            "R$ " +
            (custo * (item.estoque + (item.estoqueReuso || 0))).toFixed(2);

          footer.classList.remove("hidden");
        },

        calcConversion() {
          const qtdEnt =
            parseFloat(document.getElementById("mov-qtd-ent").value) || 0;
          const fator =
            parseFloat(document.getElementById("mov-fator").value) || 1;
          const total = qtdEnt * fator;
          document.getElementById("mov-qtd-sai").value = total > 0 ? total : "";
        },

        async handleMovementSubmit(e) {
          e.preventDefault();
          const materialId = document.getElementById("mov-material").value;
          const qtd = parseFloat(document.getElementById("mov-qtd-sai").value);
          const tipo = document.querySelector(
            'input[name="mov-tipo"]:checked',
          ).value;
          const senha = document.getElementById("mov-senha").value;
          const motivo = document.getElementById("mov-motivo").value;

          if (!materialId)
            return ToastManager.show("Selecione um material", "error");
          if (!qtd || qtd <= 0)
            return ToastManager.show("Quantidade inválida", "error");

          const user = AuthService.getCurrentUser();
          const passHash = await SecurityUtils.hash(senha);

          if (passHash !== user.passwordHash) {
            return ToastManager.show("Senha incorreta!", "error");
          }

          const btn = e.target.querySelector('button[type="submit"]');
          btn.innerHTML = "Processando...";
          btn.disabled = true;

          const success = await FirestoreService.updateStock(
            materialId,
            qtd,
            tipo,
            user.username,
            motivo,
          );

          if (success) {
            ToastManager.show("Movimentação realizada com sucesso!");
            e.target.reset();
            document
              .getElementById("mov-footer-details")
              .classList.add("hidden");
          } else {
            ToastManager.show("Erro ao movimentar estoque.", "error");
          }

          btn.innerHTML = `Confirmar Movimentação`;
          btn.disabled = false;
        },

        openStockDetailModal(itemId) {
          const item = FirestoreService.items.find((i) => i.id === itemId);
          if (!item) return;

          document.getElementById("detail-desc").innerText = item.descricao;
          document.getElementById("detail-cat").innerText = item.categoria;
          document.getElementById("detail-codigo").innerText = item.codigo;
          document.getElementById("detail-interno").innerText =
            item.codigoInterno || "-";

          document.getElementById("detail-uni-ent").innerText =
            item.unidadeEntrada || item.unidade;
          document.getElementById("detail-uni-sai").innerText = item.unidade;

          document.getElementById("status-ativo").checked =
            item.situacao !== "Inativo";
          document.getElementById("status-inativo").checked =
            item.situacao === "Inativo";

          document.getElementById("detail-conversao").innerText = item.conversao
            ? item.conversao.toFixed(3)
            : "1.000";

          const custo = item.custoMedio || 0;
          const estoque = item.estoque || 0;
          const reuso = item.estoqueReuso || 0;
          const total = estoque + reuso;

          document.getElementById("detail-custo-sigmas").innerText =
            "R$ " + (custo * 0.95).toFixed(2);
          document.getElementById("detail-custo-medio").innerText =
            "R$ " + custo.toFixed(2);

          document.getElementById("detail-est-atual").innerText = estoque;
          document.getElementById("detail-est-reuso").innerText = reuso;
          document.getElementById("detail-est-total").innerText = total;
          document.getElementById("detail-custo-total").innerText =
            "R$ " + (custo * total).toFixed(2);

          ModalManager.open("modal-details");
        },
      };

      // --- Aplicação Principal ---
      const App = {
        currentTab: "dashboard",

        async init() {
          AuthService.restoreSession();
          await FirestoreService.init();
          document.getElementById("loading-screen").classList.add("hidden");
          const loginForm = document.getElementById("login-form");
          if (loginForm)
            loginForm.addEventListener("submit", AuthController.handleLogin);

          if (AuthService.getCurrentUser()) {
            this.initLayout();
          } else {
            document.getElementById("login-layout").classList.remove("hidden");
          }
          lucide.createIcons();
        },

        refreshUI() {
          if (!AuthService.getCurrentUser()) return;

          if (this.currentTab === "dashboard") {
            this.renderDashboard();
          } else if (this.currentTab === "stock-search") {
            this.renderTableRows();
          } else if (this.currentTab === "stock-move") {
            const selectedMaterialId =
              document.getElementById("mov-material")?.value;
            if (selectedMaterialId) {
              InventoryController.onMaterialSelect(selectedMaterialId);
            }
          } else if (this.currentTab === "movement-search") {
            this.renderHistoryRows();
          }
        },

        resetData() {
          if (
            confirm(
              "ATENÇÃO: Isso irá apagar todos os dados no Firebase e restaurar os itens originais. Deseja continuar?",
            )
          ) {
            FirestoreService.resetData();
          }
        },

        initLayout() {
          document.getElementById("login-layout").classList.add("hidden");
          const appLayout = document.getElementById("app-layout");
          appLayout.classList.remove("hidden");
          appLayout.classList.add("animate-fade-in");
          appLayout.classList.add("flex");
          this.updateUserProfile();
          this.navigate(this.currentTab);
        },

        updateUserProfile() {
          const user = AuthService.getCurrentUser();
          if (!user) return;
          document.getElementById("user-name").innerText =
            user.name.split(" ")[0];
          document.getElementById("user-role").innerText = user.label;
          const iconHtml = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-full h-full p-1 fill-slate-600"><path d="M15.71,12.71a6,6,0,1,0-7.42,0,10,10,0,0,0-6.22,8.18,1,1,0,0,0,2,.22,8,8,0,0,1,15.9,0,1,1,0,0,0,1,.89h.11a1,1,0,0,0,.88-1.1A10,10,0,0,0,15.71,12.71ZM12,12a4,4,0,1,1,4-4A4,4,0,0,1,12,12Z"/></svg>`;
          document.getElementById("user-avatar").innerHTML = iconHtml;

          const adminTools = document.getElementById("admin-tools");
          if (AuthService.isAdmin()) adminTools.classList.remove("hidden");
          else adminTools.classList.add("hidden");
        },

        toggleSubmenu(id) {
          const el = document.getElementById(id);
          const arrow = document.getElementById("arrow-" + id.split("-")[1]);

          if (el.classList.contains("hidden")) {
            el.classList.remove("hidden");
            arrow.classList.add("rotate-180");
          } else {
            el.classList.add("hidden");
            arrow.classList.remove("rotate-180");
          }
        },

        navigate(tab) {
          this.currentTab = tab;

          document.querySelectorAll("nav button").forEach((b) => {
            if (b.id !== "nav-material") {
              if (b.parentElement.id === "submenu-material") {
                b.className =
                  "w-full flex items-center gap-2 px-4 py-2 rounded-lg text-xs font-medium text-slate-400 hover:text-brand-400 hover:bg-slate-800 transition-all";
              } else {
                b.className =
                  "w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold text-slate-400 hover:bg-slate-800 transition-all duration-200";
              }
            }
          });

          if (tab === "dashboard") {
            document.getElementById("nav-dashboard").className =
              "w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold bg-brand-500/10 text-brand-400 border border-brand-500/20 transition-all duration-200";
            this.renderDashboard();
          } else if (
            tab.startsWith("stock-") ||
            tab.startsWith("movement-") ||
            tab.startsWith("material-")
          ) {
            const sub = document.getElementById("submenu-material");
            if (sub.classList.contains("hidden"))
              this.toggleSubmenu("submenu-material");

            const activeSubClass =
              "w-full flex items-center gap-2 px-4 py-2 rounded-lg text-xs font-medium bg-brand-500/20 text-brand-400 font-bold transition-all border border-brand-500/10";

            if (tab === "stock-search") {
              document.getElementById("nav-stock-search").className =
                activeSubClass;
              this.renderStockSearch();
            } else if (tab === "stock-move") {
              document.getElementById("nav-stock-move").className =
                activeSubClass;
              this.renderStockMovement();
            } else if (tab === "movement-search") {
              document.getElementById("nav-mov-search").className =
                activeSubClass;
              this.renderHistoryLayout();
            } else if (tab === "material-register") {
              document.getElementById("nav-mat-register").className =
                activeSubClass;
              this.renderRegisterLayout();
            }
          }

          const sidebar = document.getElementById("sidebar");
          if (!sidebar.classList.contains("-translate-x-full"))
            this.toggleSidebar();
        },

        _createCard(title, value, icon, color) {
          const colorMap = {
            blue: {
              bg: "bg-blue-500/10",
              text: "text-blue-400",
              border: "border-blue-500/20",
            },
            red: {
              bg: "bg-red-500/10",
              text: "text-red-400",
              border: "border-red-500/20",
            },
            green: {
              bg: "bg-green-500/10",
              text: "text-green-400",
              border: "border-green-500/20",
            },
            purple: {
              bg: "bg-purple-500/10",
              text: "text-purple-400",
              border: "border-purple-500/20",
            },
          };
          const c = colorMap[color];
          return `
                    <div class="bg-dark-surface p-5 rounded-2xl shadow-sm border border-dark-border flex items-start justify-between hover:border-slate-600 transition-colors group">
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">${title}</p>
                            <h3 class="text-3xl font-bold text-white group-hover:scale-105 transition-transform origin-left">${value}</h3>
                        </div>
                        <div class="p-3 rounded-xl ${c.bg} ${c.text} ${c.border} border shadow-inner">
                            <i data-lucide="${icon}" class="w-6 h-6"></i>
                        </div>
                    </div>`;
        },

        renderStockSearch() {
          const container = document.getElementById("content-area");
          if (!AuthService.getCurrentUser()) return;

          container.innerHTML = `
                <div class="space-y-4 h-full flex flex-col animate-fade-in max-w-7xl mx-auto">
                    <div class="bg-dark-surface p-6 rounded-2xl border border-dark-border shadow-sm">
                        <div class="flex items-center gap-2 mb-4 pb-2 border-b border-dark-border">
                            <i data-lucide="search" class="w-5 h-5 text-brand-500"></i>
                            <h2 class="text-lg font-bold text-white">Pesquisa de Estoque</h2>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                            <div class="md:col-span-5">
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-1.5">Nome do Material</label>
                                <input type="text" id="search-name" class="w-full px-4 py-2.5 border border-dark-border bg-dark-bg text-white rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all placeholder-slate-600" placeholder="Digite o nome..." onkeyup="InventoryController.handleAdvancedSearch()">
                            </div>
                            <div class="md:col-span-4">
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-1.5">Código</label>
                                <input type="text" id="search-code" class="w-full px-4 py-2.5 border border-dark-border bg-dark-bg text-white rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all placeholder-slate-600" placeholder="Digite o código..." onkeyup="InventoryController.handleAdvancedSearch()">
                            </div>
                            <div class="md:col-span-3">
                                <button onclick="InventoryController.handleAdvancedSearch()" class="w-full px-4 py-2.5 bg-brand-600 text-white font-bold rounded-lg shadow-md hover:bg-brand-500 transition-all flex items-center justify-center gap-2 active:scale-95">
                                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> Atualiza Dados
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="w-full pt-2">
                        <div class="HTMLLabel" id="MakerLabel1" style="display: block; margin-bottom: 5px;">
                            <div style="vertical-align: middle;">
                                <div style="white-space: nowrap; text-decoration: none; font-weight: bold; font-size: 16px; color: #94a3b8; display: flex; items-align: center; gap: 8px;">
                                   <span class="w-1 h-5 bg-brand-500 rounded-full inline-block"></span>
                                   &nbsp;Dados&nbsp;do&nbsp;Material&nbsp;
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-dark-surface rounded-xl border border-dark-border overflow-hidden flex-1 flex flex-col shadow-sm">
                        <div class="overflow-auto flex-1 custom-scrollbar">
                            <table class="w-full text-sm text-left relative">
                                <thead class="bg-slate-800 text-slate-400 font-bold uppercase text-[11px] tracking-wider sticky top-0 z-10 border-b border-dark-border backdrop-blur-sm">
                                    <tr>
                                        <th class="px-4 py-3 w-28">Contrato</th>
                                        <th class="px-4 py-3 w-24">Cód. Int.</th>
                                        <th class="px-4 py-3 min-w-[200px]">Descrição</th>
                                        <th class="px-4 py-3 text-center w-20">Unid.</th>
                                        <th class="px-4 py-3 text-center w-24">Saldo</th>
                                        <th class="px-4 py-3 text-center w-20">Mín.</th>
                                        <th class="px-4 py-3 text-center w-20">Ressup.</th>
                                        <th class="px-4 py-3 text-center w-24">Status</th>
                                        <th class="px-4 py-3 text-right w-24">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="inventory-body" class="divide-y divide-dark-border bg-dark-surface"></tbody>
                            </table>
                        </div>
                        <div class="bg-slate-800 px-4 py-2 border-t border-dark-border text-xs text-slate-400 text-right">
                            Total de registros: <span id="total-records" class="font-bold text-white">0</span>
                        </div>
                    </div>
                </div>
            `;
          lucide.createIcons();
          this.renderTableRows();
        },

        renderStockMovement() {
          const container = document.getElementById("content-area");
          if (!AuthService.getCurrentUser()) return;

          const now = new Date();
          const dateStr =
            now.toLocaleDateString("pt-BR") +
            " " +
            now.toLocaleTimeString("pt-BR");
          const user = AuthService.getCurrentUser();

          container.innerHTML = `
                <div class="space-y-6 h-full flex flex-col animate-fade-in max-w-5xl mx-auto pb-10">
                    <div class="bg-slate-700 py-2 px-4 border border-slate-600 shadow-sm rounded-t-lg">
                        <h2 class="text-lg font-bold text-center text-white font-sans">Movimentação de Estoque</h2>
                    </div>
                    <div class="bg-dark-surface p-6 border border-dark-border shadow-inner relative -mt-6 pt-8 rounded-b-lg">
                        <form onsubmit="InventoryController.handleMovementSubmit(event)" class="space-y-5">
                            <div class="grid grid-cols-12 gap-4">
                                <div class="col-span-9">
                                    <label class="block text-xs font-bold text-slate-300 mb-1 font-sans">Selecione o Material <span class="text-red-500">*</span></label>
                                    <div class="relative">
                                        <select id="mov-material" onchange="InventoryController.onMaterialSelect(this.value)" class="w-full h-8 pl-2 pr-8 text-sm border border-dark-border rounded-sm focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none bg-dark-bg text-white shadow-sm" required>
                                            <option value="">Selecione...</option>
                                            ${FirestoreService.items.map((i) => `<option value="${i.id}">${i.descricao}</option>`).join("")}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-span-3">
                                    <label class="block text-xs font-bold text-slate-300 mb-1 font-sans">Código <span class="text-red-500">*</span></label>
                                    <input type="text" id="mov-codigo" class="w-full h-8 px-2 text-sm border border-dark-border rounded-sm bg-slate-700 text-slate-300" readonly placeholder="-" />
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-300 mb-1 font-sans">SIGMAS <span class="text-red-500">*</span></label>
                                <input type="text" id="mov-sigmas" class="w-full h-8 px-2 text-sm border border-dark-border rounded-sm bg-slate-700 text-slate-300" readonly placeholder="-" />
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                                <div class="col-span-4 border border-dark-border rounded-sm p-2 bg-dark-bg relative mt-2">
                                    <span class="absolute -top-2.5 left-2 bg-dark-surface px-1 text-xs text-slate-300">Tipo de Movimentação</span>
                                    <div class="flex gap-4 mt-1">
                                        <label class="flex items-center gap-1 cursor-pointer">
                                            <input type="radio" name="mov-tipo" value="entrada" checked class="accent-brand-600">
                                            <span class="text-sm text-slate-300">Entrada</span>
                                        </label>
                                        <label class="flex items-center gap-1 cursor-pointer">
                                            <input type="radio" name="mov-tipo" value="saida" class="accent-brand-600">
                                            <span class="text-sm text-slate-300">Saída</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-span-4 border border-dark-border rounded-sm p-2 bg-dark-bg relative mt-2">
                                    <span class="absolute -top-2.5 left-2 bg-dark-surface px-1 text-xs text-slate-300">Situação do Material</span>
                                    <div class="flex gap-4 mt-1">
                                        <label class="flex items-center gap-1 cursor-pointer">
                                            <input type="radio" name="mov-situacao" value="novo" checked class="accent-brand-600">
                                            <span class="text-sm text-slate-300">Novo</span>
                                        </label>
                                        <label class="flex items-center gap-1 cursor-pointer">
                                            <input type="radio" name="mov-situacao" value="reuso" class="accent-brand-600">
                                            <span class="text-sm text-slate-300">Reuso</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-span-4">
                                    <label class="block text-xs font-bold text-slate-300 mb-1 font-sans">Data da Movimentação <span class="text-red-500">*</span></label>
                                    <div class="relative">
                                        <input type="text" id="mov-data" value="${dateStr}" class="w-full h-8 px-2 text-sm border border-dark-border rounded-sm focus:border-brand-500 outline-none bg-dark-bg text-white" />
                                        <i data-lucide="calendar" class="absolute right-2 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-12 gap-4">
                                <div class="col-span-5">
                                    <label class="block text-xs text-slate-300 mb-1 font-sans">Unid. Entrada Estoque Serob</label>
                                    <input type="text" id="mov-uni-ent" class="w-full h-8 px-2 text-sm border border-dark-border rounded-sm bg-slate-700 text-slate-300" readonly />
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-xs text-slate-300 mb-1 font-sans">Fator Conv.</label>
                                    <input type="text" id="mov-fator" class="w-full h-8 px-2 text-sm border border-dark-border rounded-sm bg-slate-700 text-slate-300 text-right" readonly />
                                </div>
                                <div class="col-span-5">
                                    <label class="block text-xs text-slate-300 mb-1 font-sans">Unid. Saída Estoque Serob</label>
                                    <input type="text" id="mov-uni-sai" class="w-full h-8 px-2 text-sm border border-dark-border rounded-sm bg-slate-700 text-slate-300" readonly />
                                </div>
                            </div>
                            <div class="grid grid-cols-12 gap-4 items-end">
                                <div class="col-span-6 md:col-span-4 md:col-start-6">
                                     <label class="block text-xs text-slate-300 mb-1 font-sans">Quant. Unidade de Entrada</label>
                                     <input type="number" id="mov-qtd-ent" class="w-full h-8 px-2 text-sm border border-dark-border rounded-sm focus:border-brand-500 outline-none text-right bg-dark-bg text-white" oninput="InventoryController.calcConversion()" />
                                </div>
                                <div class="col-span-6 md:col-span-3">
                                     <label class="block text-xs font-bold text-slate-300 mb-1 font-sans">Quant. Unidade de Saída <span class="text-red-500">*</span></label>
                                     <input type="number" id="mov-qtd-sai" class="w-full h-8 px-2 text-sm border border-dark-border rounded-sm focus:border-brand-500 outline-none text-right font-bold bg-dark-bg text-white" required />
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-300 mb-1 font-sans">Motivo <span class="text-red-500">*</span></label>
                                <textarea id="mov-motivo" class="w-full h-20 px-2 py-1 text-sm border border-dark-border rounded-sm focus:border-brand-500 outline-none resize-none bg-dark-bg text-white" required></textarea>
                            </div>
                            <div class="mt-8 relative pt-4 border border-dark-border rounded-sm p-4 bg-slate-800/50">
                                <span class="absolute -top-2.5 left-1/2 -translate-x-1/2 bg-dark-surface px-2 text-sm font-bold text-slate-300">Dados da Operação</span>
                                <div class="flex flex-col md:flex-row justify-center gap-6 items-center">
                                    <div class="flex items-center gap-2">
                                        <label class="text-xs font-bold text-slate-300">Ponto:</label>
                                        <input type="text" value="${user.username}" readonly class="w-24 h-6 px-2 border border-dark-border rounded-sm bg-slate-700 text-xs text-slate-300 text-center">
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <label class="text-xs font-bold text-slate-300">Senha:</label>
                                        <input type="password" id="mov-senha" required class="w-32 h-8 px-2 border border-dark-border bg-dark-bg text-white rounded-sm focus:border-brand-500 outline-none text-sm">
                                    </div>
                                </div>
                            </div>
                            <div id="mov-footer-details" class="hidden">
                                <span id="info-est-atual"></span>
                                <span id="info-est-reuso"></span>
                                <span id="info-custo-total"></span>
                                <span id="info-custo-medio"></span>
                            </div>
                            <div class="flex justify-end pt-2">
                                <button type="submit" class="px-6 py-1.5 bg-slate-700 border border-slate-600 text-white font-bold text-sm hover:bg-slate-600 transition-all shadow-sm active:translate-y-0.5 rounded-sm">
                                    Confirmar Movimentação
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
          lucide.createIcons();
        },

        renderHistoryLayout() {
          const container = document.getElementById("content-area");
          if (!AuthService.getCurrentUser()) return;

          container.innerHTML = `
                <div class="space-y-4 h-full flex flex-col animate-fade-in max-w-7xl mx-auto">
                    <div class="bg-dark-surface p-6 rounded-2xl border border-dark-border shadow-sm">
                        <div class="flex items-center gap-2 mb-4 pb-2 border-b border-dark-border">
                            <i data-lucide="history" class="w-5 h-5 text-brand-500"></i>
                            <h2 class="text-lg font-bold text-white">Histórico de Movimentações</h2>
                        </div>
                        <div>
                             <input type="text" class="w-full px-4 py-2.5 border border-dark-border bg-dark-bg text-white rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all placeholder-slate-600" placeholder="Filtrar por item, usuário ou motivo..." onkeyup="InventoryController.handleHistorySearch(this.value)">
                        </div>
                    </div>

                    <div class="bg-dark-surface rounded-xl border border-dark-border overflow-hidden flex-1 flex flex-col shadow-sm">
                        <div class="overflow-auto flex-1 custom-scrollbar">
                            <table class="w-full text-sm text-left relative">
                                <thead class="bg-slate-800 text-slate-400 font-bold uppercase text-[11px] tracking-wider sticky top-0 z-10 border-b border-dark-border backdrop-blur-sm">
                                    <tr>
                                        <th class="px-4 py-3">Data</th>
                                        <th class="px-4 py-3">Item</th>
                                        <th class="px-4 py-3">Tipo</th>
                                        <th class="px-4 py-3 text-right">Qtd</th>
                                        <th class="px-4 py-3">Usuário</th>
                                        <th class="px-4 py-3">Motivo</th>
                                    </tr>
                                </thead>
                                <tbody id="history-body" class="divide-y divide-dark-border bg-dark-surface"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
          lucide.createIcons();
          this.renderHistoryRows();
        },

        renderHistoryRows() {
          const tbody = document.getElementById("history-body");
          if (!tbody) return;

          const term = (
            InventoryController.state.historySearchTerm || ""
          ).toLowerCase();
          const filtered = FirestoreService.history.filter(
            (h) =>
              (h.itemDesc || "").toLowerCase().includes(term) ||
              (h.user || "").toLowerCase().includes(term) ||
              (h.motive || "").toLowerCase().includes(term),
          );

          if (filtered.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-12 text-center text-slate-500">Nenhum registro encontrado.</td></tr>`;
          } else {
            tbody.innerHTML = filtered
              .map((h) => {
                const dateObj = new Date(h.timestamp);
                const dateStr =
                  dateObj.toLocaleDateString("pt-BR") +
                  " " +
                  dateObj.toLocaleTimeString("pt-BR");
                const isEntry = h.type === "entrada";
                const typeClass = isEntry
                  ? "text-green-400 bg-green-900/20 px-2 py-0.5 rounded text-xs border border-green-900/30"
                  : "text-red-400 bg-red-900/20 px-2 py-0.5 rounded text-xs border border-red-900/30";
                const qtyClass = isEntry ? "text-green-400" : "text-red-400";

                return `
                        <tr class="hover:bg-slate-800 transition-colors border-b border-dark-border last:border-0">
                            <td class="px-4 py-3 font-mono text-xs text-slate-400 whitespace-nowrap">${dateStr}</td>
                            <td class="px-4 py-3 font-medium text-white">${h.itemDesc || "-"}</td>
                            <td class="px-4 py-3"><span class="${typeClass}">${h.type.toUpperCase()}</span></td>
                            <td class="px-4 py-3 text-right font-mono font-bold ${qtyClass}">${h.quantity}</td>
                            <td class="px-4 py-3 text-slate-400 text-xs">${h.user}</td>
                            <td class="px-4 py-3 text-slate-500 text-xs max-w-xs truncate" title="${h.motive}">${h.motive}</td>
                        </tr>
                    `;
              })
              .join("");
          }
        },

        renderRegisterLayout() {
          const container = document.getElementById("content-area");
          container.innerHTML = `
                <div class="max-w-2xl mx-auto animate-fade-in">
                    <div class="bg-dark-surface rounded-2xl shadow-sm border border-dark-border p-8">
                        <div class="mb-8">
                            <h2 class="text-2xl font-bold text-white">Cadastro de Material</h2>
                            <p class="text-sm text-slate-400">Adicione um novo item ao estoque manualmente.</p>
                        </div>
                        
                        <form onsubmit="InventoryController.saveNewItem(event)" class="space-y-5">
                            <div class="grid grid-cols-2 gap-5">
                                <div>
                                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1.5">Código</label>
                                    <input type="text" id="new-codigo" class="w-full px-4 py-2.5 border border-dark-border bg-dark-bg text-white rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all" placeholder="Ex: B.01.01.001" required />
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1.5">Cód. Interno</label>
                                    <input type="text" id="new-codigo-interno" class="w-full px-4 py-2.5 border border-dark-border bg-dark-bg text-white rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all" placeholder="Opcional" />
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-1.5">Descrição do Material</label>
                                <input type="text" id="new-descricao" class="w-full px-4 py-2.5 border border-dark-border bg-dark-bg text-white rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all" placeholder="Nome completo do item" required />
                            </div>

                            <div class="grid grid-cols-2 gap-5">
                                <div>
                                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1.5">Categoria</label>
                                    <select id="new-categoria" class="w-full px-4 py-2.5 border border-dark-border bg-dark-bg text-white rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all">
                                        <option value="DEPÓSITO GERAL">DEPÓSITO GERAL</option>
                                        <option value="DEPÓSITO C4 - GÁS">DEPÓSITO C4 - GÁS</option>
                                        <option value="DEPÓSITO 01 - IMPERMEABILIZAÇÃO">DEPÓSITO 01 - IMPERMEABILIZAÇÃO</option>
                                        <option value="DEPÓSITO 02 - TINTA ESMALTE">DEPÓSITO 02 - TINTA ESMALTE</option>
                                        <option value="DEPÓSITO 25 - TINTA ACRÍLICA">DEPÓSITO 25 - TINTA ACRÍLICA</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1.5">Unidade</label>
                                    <input type="text" id="new-unidade" class="w-full px-4 py-2.5 border border-dark-border bg-dark-bg text-white rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all" placeholder="Ex: Unidade" required />
                                </div>
                            </div>

                            <div class="grid grid-cols-3 gap-5 border-t border-dark-border pt-5">
                                <div>
                                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1.5">Estoque Inicial</label>
                                    <input type="number" id="new-estoque" class="w-full px-4 py-2.5 border border-dark-border bg-dark-bg text-white rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all" value="0" />
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1.5">Mínimo</label>
                                    <input type="number" id="new-minimo" class="w-full px-4 py-2.5 border border-dark-border bg-dark-bg text-white rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all" value="5" />
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1.5">Ressuprimento</label>
                                    <input type="number" id="new-ressup" class="w-full px-4 py-2.5 border border-dark-border bg-dark-bg text-white rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all" value="10" />
                                </div>
                            </div>

                            <div class="flex justify-end pt-4">
                                <button type="submit" class="px-6 py-2.5 bg-brand-600 text-white font-bold rounded-lg shadow-md hover:bg-brand-500 transition-all">
                                    Cadastrar Item
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
          lucide.createIcons();
        },

        renderDashboard() {
          const container = document.getElementById("content-area");
          // Guard clause: if user is not logged in, do not attempt to render
          const user = AuthService.getCurrentUser();
          if (!user) return;

          const stats = {
            totalItems: FirestoreService.items.length,
            lowStock: FirestoreService.items.filter(
              (i) => i.estoque <= i.estoqueMinimo,
            ).length,
            totalStock: FirestoreService.items.reduce(
              (acc, curr) => acc + curr.estoque,
              0,
            ),
            categories: [
              ...new Set(FirestoreService.items.map((i) => i.categoria)),
            ].length,
          };

          const h = new Date().getHours();
          const greeting =
            h < 12 ? "Bom dia" : h < 18 ? "Boa tarde" : "Boa noite";

          // Filtra itens com alerta (40% de margem acima do mínimo) ou críticos
          const alertItems = FirestoreService.items
            .filter((i) => i.estoque <= i.estoqueMinimo * 1.4)
            .sort(
              (a, b) =>
                a.estoque / a.estoqueMinimo - b.estoque / b.estoqueMinimo,
            );

          container.innerHTML = `
                    <div class="space-y-8 animate-fade-in pb-10 max-w-7xl mx-auto">
                        <div class="flex justify-between items-end">
                            <div>
                                <h2 class="text-3xl font-bold text-white tracking-tight">${greeting}, ${user.name.split(" ")[0]}!</h2>
                                <p class="text-slate-400 mt-1">Aqui está o panorama atual do almoxarifado (Online).</p>
                            </div>
                            <div class="hidden md:block text-right">
                                <p class="text-xs font-bold uppercase text-slate-500 tracking-wider">Última atualização</p>
                                <p class="text-sm font-mono text-slate-300">${new Date().toLocaleTimeString()}</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
                            ${this._createCard("Total de Itens", stats.totalItems, "package", "blue")}
                            ${this._createCard("Itens Críticos", stats.lowStock, "alert-triangle", "red")}
                            ${this._createCard("Estoque Físico", stats.totalStock, "trending-up", "green")}
                            ${this._createCard("Depósitos Ativos", stats.categories, "layout-dashboard", "purple")}
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 bg-dark-surface rounded-2xl shadow-sm border border-dark-border overflow-hidden flex flex-col">
                                <div class="p-6 border-b border-dark-border flex justify-between items-center bg-dark-surface sticky top-0">
                                    <h3 class="font-bold text-white flex items-center gap-2">
                                        <i data-lucide="bell-ring" class="w-4 h-4 text-brand-500"></i>
                                        Alertas de Reposição
                                    </h3>
                                    <button onclick="App.navigate('stock-search')" class="text-xs font-semibold text-brand-400 bg-brand-500/10 px-3 py-1.5 rounded-lg hover:bg-brand-500/20 transition-colors">Ver Estoque</button>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm text-left">
                                        <thead class="bg-slate-800 text-slate-400 font-semibold uppercase text-[10px] tracking-wider">
                                            <tr>
                                                <th class="px-6 py-4">Item</th>
                                                <th class="px-6 py-4 text-right">Saldo</th>
                                                <th class="px-6 py-4 text-right">Mínimo</th>
                                                <th class="px-6 py-4 text-center">Ressuprimento</th>
                                                <th class="px-6 py-4 text-center">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-slate-700">
                                            ${
                                              alertItems
                                                .slice(0, 5)
                                                .map((item) => {
                                                  const isCritical =
                                                    item.estoque <=
                                                    item.estoqueMinimo;
                                                  const statusClass = isCritical
                                                    ? "bg-red-900/20 text-red-400 border-red-900/30"
                                                    : "bg-yellow-900/20 text-yellow-400 border-yellow-900/30";
                                                  const statusText = isCritical
                                                    ? "Crítico"
                                                    : "Alerta";
                                                  const stockClass = isCritical
                                                    ? "text-red-400"
                                                    : "text-yellow-400";

                                                  return `
                                                <tr class="hover:bg-slate-800 transition-colors group">
                                                    <td class="px-6 py-4">
                                                        <div class="font-medium text-white group-hover:text-brand-400 transition-colors">${item.descricao}</div>
                                                        <div class="text-xs text-slate-500">${item.categoria}</div>
                                                    </td>
                                                    <td class="px-6 py-4 text-right font-mono font-bold ${stockClass}">${item.estoque}</td>
                                                    <td class="px-6 py-4 text-right font-mono text-slate-400">${item.estoqueMinimo}</td>
                                                    <td class="px-6 py-4 text-center font-mono text-slate-400 font-bold">${item.qtdRessuprimento || "-"}</td>
                                                    <td class="px-6 py-4 text-center">
                                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${statusClass}">${statusText}</span>
                                                    </td>
                                                </tr>`;
                                                })
                                                .join("") ||
                                              `<tr><td colspan="5" class="px-6 py-12 text-center text-slate-500 italic">Tudo em ordem! Nenhum alerta.</td></tr>`
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="bg-dark-surface rounded-2xl shadow-sm border border-dark-border p-6 flex flex-col">
                                <h3 class="font-bold text-white mb-6">Top Depósitos</h3>
                                <div class="space-y-5 overflow-y-auto custom-scrollbar flex-1 pr-2">
                                    ${[
                                      ...new Set(
                                        FirestoreService.items.map(
                                          (i) => i.categoria,
                                        ),
                                      ),
                                    ]
                                      .slice(0, 6)
                                      .map((cat) => {
                                        const count =
                                          FirestoreService.items.filter(
                                            (i) => i.categoria === cat,
                                          ).length;
                                        const percent = Math.min(
                                          100,
                                          (count / stats.totalItems) * 100 * 3,
                                        );
                                        return `
                                            <div>
                                                <div class="flex justify-between text-xs mb-1.5 font-medium">
                                                    <span class="text-slate-300 truncate w-3/4" title="${cat}">${cat.replace(/DEPÓSITO |DEP\. /, "")}</span>
                                                    <span class="text-slate-500">${count}</span>
                                                </div>
                                                <div class="w-full bg-slate-700 rounded-full h-2 overflow-hidden">
                                                    <div class="bg-brand-500 h-2 rounded-full transition-all duration-1000" style="width: ${percent}%"></div>
                                                </div>
                                            </div>`;
                                      })
                                      .join("")}
                                </div>
                            </div>
                        </div>
                    </div>`;
          lucide.createIcons();
        },

        renderTableRows() {
          const tbody = document.getElementById("inventory-body");
          if (!tbody) return;

          const { searchTerm, categoryFilter } = InventoryController.state;
          const items = FirestoreService.items;
          const isMovementTab = this.currentTab === "stock-move";

          const normalizeText = (text) => {
            return text
              ? text
                  .normalize("NFD")
                  .replace(/[\u0300-\u036f]/g, "")
                  .toLowerCase()
              : "";
          };

          const searchNormalized = normalizeText(searchTerm);

          const filtered = items.filter((item) => {
            const descNormalized = normalizeText(item.descricao);
            const codeNormalized = normalizeText(item.codigo);
            const internalCodeNormalized = normalizeText(item.codigoInterno);

            const matchesSearch =
              descNormalized.includes(searchNormalized) ||
              codeNormalized.includes(searchNormalized) ||
              internalCodeNormalized.includes(searchNormalized);

            const matchesCategory =
              categoryFilter === "Todas" || item.categoria === categoryFilter;

            return matchesSearch && matchesCategory;
          });

          const colSpan = isMovementTab ? 9 : 8;

          if (filtered.length === 0) {
            tbody.innerHTML = `<tr><td colspan="${colSpan}" class="px-6 py-20 text-center flex flex-col items-center justify-center text-slate-500"><div class="bg-slate-800 p-4 rounded-full mb-3"><i data-lucide="search-x" class="w-8 h-8"></i></div><span class="font-medium">Nenhum item encontrado</span><span class="text-xs mt-1">Tente ajustar os filtros de busca</span></td></tr>`;
          } else {
            tbody.innerHTML = filtered
              .map((item) => {
                const min = item.estoqueMinimo || 0;
                const alertThreshold = min * 1.4;
                let statusHtml = "";
                let rowClass =
                  "hover:bg-slate-800 transition-colors group border-l-4 border-transparent";

                if (item.estoque <= min) {
                  statusHtml =
                    '<span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-red-900/20 text-red-400 border border-red-900/30">Crítico</span>';
                  rowClass += " hover:border-red-500";
                } else if (item.estoque <= alertThreshold) {
                  statusHtml =
                    '<span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-yellow-900/20 text-yellow-400 border border-yellow-900/30">Alerta</span>';
                  rowClass += " hover:border-yellow-500";
                } else {
                  statusHtml =
                    '<span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-green-900/20 text-green-400 border border-green-900/30">Normal</span>';
                  rowClass += " hover:border-brand-500";
                }

                let actionsCell = "";
                if (isMovementTab) {
                  // Botões de Movimentação
                  actionsCell = `
                    <td class="px-4 py-4 text-right">
                        <div class="flex items-center justify-end gap-2 opacity-80 group-hover:opacity-100 transition-opacity">
                            <button onclick="InventoryController.openMovementModal(${item.id}, 'entrada')" class="p-1.5 text-green-400 bg-green-900/20 hover:bg-green-900/40 border border-green-900/50 rounded-lg transition-all shadow-sm hover:shadow active:scale-95" title="Entrada"><i data-lucide="plus" class="w-3.5 h-3.5"></i></button>
                            <button onclick="InventoryController.openMovementModal(${item.id}, 'saida')" class="p-1.5 text-red-400 bg-red-900/20 hover:bg-red-900/40 border border-red-900/50 rounded-lg transition-all shadow-sm hover:shadow active:scale-95" title="Saída"><i data-lucide="minus" class="w-3.5 h-3.5"></i></button>
                        </div>
                    </td>`;
                } else {
                  // Botão de Detalhes (Olho) para a Pesquisa
                  actionsCell = `
                    <td class="px-4 py-4 text-right">
                        <div class="flex items-center justify-end gap-2 opacity-80 group-hover:opacity-100 transition-opacity">
                            <button onclick="InventoryController.openStockDetailModal(${item.id})" class="p-1.5 text-brand-400 bg-brand-900/20 hover:bg-brand-900/40 border border-brand-900/50 rounded-lg transition-all shadow-sm hover:shadow active:scale-95" title="Ver Detalhes">
                                <i data-lucide="eye" class="w-3.5 h-3.5"></i>
                            </button>
                        </div>
                    </td>`;
                }

                return `
                        <tr class="${rowClass}">
                            <td class="px-4 py-4 font-mono text-xs text-slate-400">${item.codigo}</td>
                            <td class="px-4 py-4 font-mono text-xs text-slate-400">${item.codigoInterno || "-"}</td>
                            <td class="px-4 py-4">
                                <div class="font-semibold text-slate-200 text-sm mb-0.5">${item.descricao}</div>
                                <div class="text-[10px] text-slate-500 uppercase tracking-wide truncate max-w-[200px]" title="${item.categoria}">${item.categoria.replace(/DEPÓSITO |DEP\. /, "")}</div>
                            </td>
                            <td class="px-4 py-4 text-center text-xs text-slate-400">${item.unidade}</td>
                            <td class="px-4 py-4 text-center">
                                <span class="font-mono text-base font-bold ${item.estoque <= min ? "text-red-400" : item.estoque <= alertThreshold ? "text-yellow-400" : "text-slate-300"}">${item.estoque}</span>
                            </td>
                            <td class="px-4 py-4 text-center font-mono text-xs text-slate-500">${min}</td>
                            <td class="px-4 py-4 text-center font-mono text-xs text-slate-500">${item.qtdRessuprimento || "-"}</td>
                            <td class="px-4 py-4 text-center">
                                ${statusHtml}
                            </td>
                            ${actionsCell}
                        </tr>`;
              })
              .join("");
          }
          lucide.createIcons();
        },

        async handleFileUpload(event) {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (e) => {
            const text = e.target.result;
            const lines = text.split("\n");
            const newItems = [];
            let currentCategory = "Importado";

            if (file.name.includes("DEP.")) {
              const parts = file.name.split(".");
              if (parts.length > 1) currentCategory = parts[0] + " " + parts[1];
            }

            lines.forEach((line, index) => {
              if (line.length < 10 || line.includes("CÓDIGO DO CONTRATO"))
                return;
              const cols = line.split(",");
              const codigo = cols.find(
                (c) => c && c.match(/B\.\d{2}\.\d{2}\.\d{3}/),
              );

              if (codigo) {
                const descIndex = cols.findIndex(
                  (c) => c.length > 10 && !c.match(/B\.\d{2}/),
                );
                const descricao =
                  cols[descIndex]?.replace(/"/g, "") || "Item importado";
                const numbers = cols
                  .map((c) => parseFloat(c))
                  .filter((n) => !isNaN(n));
                let codigoInterno = "";
                for (let i = 0; i < cols.length; i++) {
                  const val = cols[i].trim();
                  if (!isNaN(val) && val.length >= 4 && val !== codigo) {
                    codigoInterno = val;
                    break;
                  }
                }
                const estoque =
                  numbers.length > 0 ? numbers[numbers.length - 1] : 0;
                // Valor padrão para novos itens importados
                const estoqueMinimo = 10;

                newItems.push({
                  id: Date.now() + index + Math.random(),
                  codigo: codigo,
                  codigoInterno: codigoInterno,
                  descricao: descricao,
                  categoria: currentCategory,
                  unidade: "UN",
                  estoque: estoque,
                  estoqueMinimo: estoqueMinimo,
                  qtdRessuprimento: estoqueMinimo * 2, // Padrão simples
                });
              }
            });

            if (newItems.length > 0) {
              // Importar para Firestore
              const btn =
                document.querySelector('input[type="file"]').parentElement;

              btn.innerHTML = `<div class="flex flex-col items-center justify-center py-1"><i data-lucide="loader" class="w-5 h-5 text-brand-500 animate-spin mb-1"></i><span class="text-[10px] font-medium text-slate-500">Processando...</span></div>`;
              lucide.createIcons();

              FirestoreService.importItems(newItems).then(() => {
                ToastManager.show(
                  `${newItems.length} itens importados para o Firebase!`,
                  "success",
                );
                if (App.currentTab === "dashboard") App.renderDashboard();
                else if (App.currentTab === "stock-search")
                  App.renderStockSearch();

                // Reset UI com o novo design avançado
                btn.innerHTML = `
                    <div class="flex items-center justify-center gap-3 transition-transform group-hover:-translate-y-0.5 duration-300">
                      <div class="p-1.5 bg-slate-700 rounded-lg border border-slate-600 shadow-sm group-hover:border-brand-500 text-slate-400 group-hover:text-brand-400 transition-colors">
                        <i data-lucide="file-spreadsheet" class="w-4 h-4"></i>
                      </div>
                      <div class="flex flex-col text-left">
                        <span class="text-[10px] font-semibold text-slate-300 group-hover:text-brand-400 transition-colors">Importar CSV</span>
                        <span class="text-[8px] text-slate-500 group-hover:text-brand-600 transition-colors">Clique para enviar</span>
                      </div>
                    </div>
                    <input type="file" accept=".csv" class="hidden" onchange="App.handleFileUpload(event)" />
                  `;
                lucide.createIcons();
              });
            } else {
              ToastManager.show(
                "Formato de arquivo inválido ou sem dados.",
                "error",
              );
            }
          };
          reader.readAsText(file);
          event.target.value = "";
        },
      };

      // --- Main Exports (Expose to Window) ---
      window.App = App;
      window.AuthController = AuthController;
      window.InventoryController = InventoryController;
      window.ModalManager = ModalManager;
      window.FirestoreService = FirestoreService;

      // --- Bootstrap ---
      document.addEventListener("DOMContentLoaded", () => App.init());
    </script>
  </body>
</html>
