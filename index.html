<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestão de Estoque - COENG | DETEC</title>

    <!-- Favicon & Apple Touch Icon (Logótipo Azul) -->
    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml,%3Csvg version='1.1' id='Capa_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' viewBox='0 0 101.968 101.968' style='enable-background:new 0 0 101.968 101.968;' xml:space='preserve' fill='%232563eb'%3E%3Cg%3E%3Cg%3E%3Cpath d='M24.715,47.432L7.968,64.86v29.406c0,0.828,0.671,1.5,1.5,1.5h20.334c0.828,0,1.5-0.672,1.5-1.5V49.158l-4.69-1.726H24.715z'/%3E%3Cpath d='M66.135,61.1H45.801c-0.828,0-1.5,0.672-1.5,1.5v31.666c0,0.828,0.672,1.5,1.5,1.5h20.334c0.829,0,1.5-0.672,1.5-1.5V62.6C67.635,61.772,66.964,61.1,66.135,61.1z'/%3E%3Cpath d='M101.724,29.49c-0.777,0.406-1.652,0.621-2.53,0.621c-1.276,0-2.521-0.45-3.5-1.27l-3.694-3.088l-13.365,14.58v53.934c0,0.828,0.672,1.5,1.5,1.5h20.334c0.829,0,1.5-0.672,1.5-1.5v-64.93C101.885,29.387,101.81,29.445,101.724,29.49z'/%3E%3Cpath d='M57.797,54.094c1.144,0.419,2.424,0.108,3.248-0.788l30.839-33.643l7.217,6.032c0.353,0.294,0.847,0.349,1.254,0.136c0.407-0.214,0.646-0.648,0.605-1.107L99.396,7.235c-0.055-0.625-0.606-1.086-1.231-1.029l-17.49,1.563c-0.458,0.041-0.846,0.354-0.982,0.791C79.646,8.706,79.631,8.854,79.644,9c0.026,0.294,0.167,0.572,0.403,0.769l7.229,6.043L57.98,47.769L24.535,35.463c-1.118-0.41-2.373-0.121-3.198,0.735l-20.5,21.333c-1.148,1.195-1.11,3.095,0.084,4.242c0.583,0.561,1.332,0.837,2.079,0.837c0.788,0,1.574-0.309,2.164-0.921l19.141-19.92L57.797,54.094z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"
    />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts: Inter -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Configurações Tailwind -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ["Inter", "sans-serif"] },
            colors: {
              brand: {
                50: "#eff6ff",
                100: "#dbeafe",
                500: "#3b82f6",
                600: "#2563eb",
                700: "#1d4ed8",
                900: "#1e3a8a",
              },
            },
          },
        },
      };
    </script>

    <style>
      /* CSS Base e Utilitários */
      body {
        font-family: "Inter", sans-serif;
        -webkit-font-smoothing: antialiased;
      }

      /* Animações */
      .animate-fade-in {
        animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      }
      .animate-slide-up {
        animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      }
      .animate-scale-in {
        animation: scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      }
      .animate-spin-slow {
        animation: spin 2s linear infinite;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes scaleIn {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      /* Scrollbar Customizada */
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      /* Toast Notifications Container */
      #toast-container {
        position: fixed;
        top: 1.5rem;
        right: 1.5rem;
        z-index: 100;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        pointer-events: none;
      }
      .toast {
        pointer-events: auto;
        box-shadow:
          0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
      }
    </style>
  </head>
  <body
    class="bg-slate-100 text-slate-800 h-screen overflow-hidden selection:bg-brand-100 selection:text-brand-900"
  >
    <!-- Container de Notificações (Toasts) -->
    <div id="toast-container"></div>

    <!-- Tela de Carregamento Inicial -->
    <div
      id="loading-screen"
      class="fixed inset-0 bg-white z-[60] flex flex-col items-center justify-center"
    >
      <div class="relative w-16 h-16 mb-4">
        <div
          class="absolute inset-0 rounded-full border-4 border-slate-100"
        ></div>
        <div
          class="absolute inset-0 rounded-full border-4 border-brand-600 border-t-transparent animate-spin"
        ></div>
      </div>
      <h2 class="text-lg font-bold text-slate-900">
        Conectando ao Firebase...
      </h2>
      <p class="text-sm text-slate-500 mt-2" id="loading-text">
        Sincronizando dados em tempo real
      </p>
    </div>

    <!-- ================== TELA DE LOGIN ================== -->
    <div
      id="login-layout"
      class="hidden flex h-full w-full items-center justify-center bg-slate-100 p-4"
    >
      <div
        class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8 animate-slide-up border border-slate-200"
      >
        <div class="text-center mb-8">
          <div
            class="bg-brand-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-brand-600/20 transform transition-transform hover:scale-105 duration-300"
          >
            <!-- SVG Personalizado: Increasing Stocks -->
            <svg
              class="w-8 h-8 text-white fill-current"
              version="1.1"
              id="Capa_1"
              xmlns="http://www.w3.org/2000/svg"
              xmlns:xlink="http://www.w3.org/1999/xlink"
              x="0px"
              y="0px"
              width="101.968px"
              height="101.968px"
              viewBox="0 0 101.968 101.968"
              style="enable-background: new 0 0 101.968 101.968"
              xml:space="preserve"
            >
              <g>
                <g>
                  <path
                    d="M24.715,47.432L7.968,64.86v29.406c0,0.828,0.671,1.5,1.5,1.5h20.334c0.828,0,1.5-0.672,1.5-1.5V49.158l-4.69-1.726H24.715z"
                  />
                  <path
                    d="M66.135,61.1H45.801c-0.828,0-1.5,0.672-1.5,1.5v31.666c0,0.828,0.672,1.5,1.5,1.5h20.334c0.829,0,1.5-0.672,1.5-1.5V62.6C67.635,61.772,66.964,61.1,66.135,61.1z"
                  />
                  <path
                    d="M101.724,29.49c-0.777,0.406-1.652,0.621-2.53,0.621c-1.276,0-2.521-0.45-3.5-1.27l-3.694-3.088l-13.365,14.58v53.934c0,0.828,0.672,1.5,1.5,1.5h20.334c0.829,0,1.5-0.672,1.5-1.5v-64.93C101.885,29.387,101.81,29.445,101.724,29.49z"
                  />
                  <path
                    d="M57.797,54.094c1.144,0.419,2.424,0.108,3.248-0.788l30.839-33.643l7.217,6.032c0.353,0.294,0.847,0.349,1.254,0.136c0.407-0.214,0.646-0.648,0.605-1.107L99.396,7.235c-0.055-0.625-0.606-1.086-1.231-1.029l-17.49,1.563c-0.458,0.041-0.846,0.354-0.982,0.791C79.646,8.706,79.631,8.854,79.644,9c0.026,0.294,0.167,0.572,0.403,0.769l7.229,6.043L57.98,47.769L24.535,35.463c-1.118-0.41-2.373-0.121-3.198,0.735l-20.5,21.333c-1.148,1.195-1.11,3.095,0.084,4.242c0.583,0.561,1.332,0.837,2.079,0.837c0.788,0,1.574-0.309,2.164-0.921l19.141-19.92L57.797,54.094z"
                  />
                </g>
              </g>
            </svg>
          </div>
          <div>
            <h1 class="font-bold text-lg text-slate-900 leading-tight">
              SEROB
            </h1>
            <p class="text-xs font-medium text-slate-500">Gestão de Estoque</p>
          </div>
        </div>

        <!-- Sidebar Navigation -->
        <nav class="p-4 space-y-1.5 flex-1 overflow-y-auto custom-scrollbar">
          <button
            onclick="App.navigate('dashboard')"
            id="nav-dashboard"
            class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold transition-all duration-200"
          >
            <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard
          </button>

          <!-- Menu Material (Com Submenu) -->
          <div>
            <button
              onclick="App.toggleSubmenu('submenu-material')"
              id="nav-material"
              class="w-full flex items-center justify-between px-4 py-3 rounded-xl text-sm font-semibold text-slate-600 hover:bg-slate-50 transition-all duration-200 group"
            >
              <div class="flex items-center gap-3">
                <i
                  data-lucide="package"
                  class="w-5 h-5 group-hover:text-brand-600 transition-colors"
                ></i>
                Material
              </div>
              <i
                data-lucide="chevron-down"
                id="arrow-material"
                class="w-4 h-4 text-slate-400 transition-transform duration-200"
              ></i>
            </button>
            <div id="submenu-material" class="hidden pl-4 pr-2 py-2 space-y-1">
              <button
                onclick="App.navigate('stock-search')"
                id="nav-stock-search"
                class="w-full flex items-center gap-2 px-4 py-2 rounded-lg text-xs font-medium text-slate-600 hover:text-brand-600 hover:bg-brand-50 transition-all"
              >
                Pesquisa de Estoque de Material
              </button>
              <button
                onclick="App.navigate('stock-move')"
                id="nav-stock-move"
                class="w-full flex items-center gap-2 px-4 py-2 rounded-lg text-xs font-medium text-slate-600 hover:text-brand-600 hover:bg-brand-50 transition-all"
              >
                Movimentação de Estoque
              </button>
              <button
                onclick="App.navigate('movement-search')"
                id="nav-mov-search"
                class="w-full flex items-center gap-2 px-4 py-2 rounded-lg text-xs font-medium text-slate-600 hover:text-brand-600 hover:bg-brand-50 transition-all"
              >
                Pesquisa de Movimentação
              </button>
              <button
                onclick="App.navigate('material-register')"
                id="nav-mat-register"
                class="w-full flex items-center gap-2 px-4 py-2 rounded-lg text-xs font-medium text-slate-600 hover:text-brand-600 hover:bg-brand-50 transition-all"
              >
                Cadastro de Material
              </button>
            </div>
          </div>
        </nav>

        <!-- Sidebar Footer (Profile) -->
        <div class="p-4 border-t border-slate-100 space-y-4 bg-slate-50/30">
          <!-- Status -->
          <div class="flex items-center justify-center gap-1.5 pb-2">
            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
            <span class="text-[10px] font-medium text-slate-500"
              >Online - Firebase</span
            >
          </div>

          <!-- Profile Dropdown (Upward) -->
          <div class="relative group">
            <button
              class="w-full flex items-center gap-3 px-2 py-2 rounded-lg border border-transparent hover:border-slate-200 hover:bg-white transition-all cursor-pointer"
            >
              <div
                class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center overflow-hidden"
                id="user-avatar"
              ></div>
              <div class="flex-1 overflow-hidden text-left">
                <p
                  class="text-sm font-bold text-slate-900 truncate"
                  id="user-name"
                >
                  Usuário
                </p>
                <p class="text-xs text-slate-500 truncate" id="user-role">
                  Função
                </p>
              </div>
              <i data-lucide="chevron-up" class="w-4 h-4 text-slate-400"></i>
            </button>

            <!-- Dropdown Menu (Fixed padding bridge) -->
            <div
              class="absolute bottom-full left-0 w-full pb-2 hidden group-hover:block z-50"
            >
              <div
                class="bg-white rounded-xl shadow-xl border border-slate-100 p-2 animate-scale-in origin-bottom"
              >
                <!-- Admin Only -->
                <div id="admin-tools" class="hidden">
                  <label
                    class="flex items-center gap-2 px-3 py-2 text-xs font-medium text-slate-600 hover:bg-slate-50 rounded-lg cursor-pointer transition-colors"
                  >
                    <i data-lucide="file-spreadsheet" class="w-3.5 h-3.5"></i>
                    Importar CSV
                    <input
                      type="file"
                      accept=".csv"
                      class="hidden"
                      onchange="App.handleFileUpload(event)"
                    />
                  </label>
                  <button
                    onclick="App.resetData()"
                    class="w-full flex items-center gap-2 px-3 py-2 text-xs font-medium text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                  >
                    <i data-lucide="trash-2" class="w-3.5 h-3.5"></i> Resetar
                    Dados
                  </button>
                  <div class="border-t border-slate-50 my-1"></div>
                </div>

                <button
                  onclick="App.openPasswordModal()"
                  class="w-full flex items-center gap-2 px-3 py-2 text-xs font-medium text-slate-600 hover:bg-slate-50 rounded-lg transition-colors"
                >
                  <i data-lucide="key" class="w-3.5 h-3.5"></i> Alterar Senha
                </button>
                <button
                  onclick="App.logout()"
                  class="w-full flex items-center gap-2 px-3 py-2 text-xs font-medium text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                >
                  <i data-lucide="log-out" class="w-3.5 h-3.5"></i> Sair
                </button>
              </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Main Content Area -->
      <main class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
        <!-- Mobile Header -->
        <header
          class="bg-white border-b border-slate-200 p-4 flex items-center justify-between lg:hidden flex-shrink-0 z-10 shadow-sm"
        >
          <div class="flex items-center gap-3">
            <button
              onclick="App.toggleSidebar()"
              class="p-2 -ml-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors"
            >
              <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
            <span class="font-bold text-slate-900">Gestão de Estoque</span>
          </div>
          <div
            class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center overflow-hidden border border-slate-300"
            id="mobile-user-avatar"
          ></div>
        </header>

        <!-- Dynamic Content -->
        <div
          id="content-area"
          class="flex-1 overflow-y-auto p-4 lg:p-8 custom-scrollbar scroll-smooth"
        >
          <!-- Conteúdo injetado via JS -->
        </div>
      </main>
    </div>

    <!-- ================== MODALS ================== -->

    <!-- Modal Movimentação -->
    <div
      id="modal-movement"
      class="fixed inset-0 bg-slate-900/60 z-50 hidden items-center justify-center p-4 backdrop-blur-sm transition-opacity opacity-0 pointer-events-none"
      aria-hidden="true"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 transform scale-95 transition-all duration-300"
        id="modal-movement-content"
      >
        <div class="flex justify-between items-start mb-6">
          <div>
            <h3
              id="modal-mov-title"
              class="text-xl font-bold text-slate-900 tracking-tight"
            >
              Registrar Entrada
            </h3>
            <p
              id="modal-mov-item"
              class="text-sm font-medium text-slate-500 mt-1"
            >
              Nome do Item
            </p>
          </div>
          <button
            onclick="ModalManager.close('modal-movement')"
            class="text-slate-400 hover:text-slate-600 hover:bg-slate-100 p-1 rounded-full transition-colors"
          >
            <i data-lucide="x" class="w-6 h-6"></i>
          </button>
        </div>

        <div
          class="bg-slate-50 p-5 rounded-xl mb-6 border border-slate-100 flex justify-between items-center shadow-inner"
        >
          <div>
            <p
              class="text-[10px] font-bold text-slate-400 uppercase tracking-wider"
            >
              Estoque Atual
            </p>
            <p
              id="modal-mov-current"
              class="text-2xl font-mono text-slate-700 font-semibold"
            >
              0
            </p>
          </div>
          <div class="h-8 w-px bg-slate-200"></div>
          <div class="text-right">
            <p
              class="text-[10px] font-bold text-slate-400 uppercase tracking-wider"
            >
              Novo Saldo
            </p>
            <p
              id="modal-mov-new"
              class="text-2xl font-mono font-bold text-slate-900"
            >
              0
            </p>
          </div>
        </div>

        <div class="mb-8">
          <label class="block text-sm font-semibold text-slate-700 mb-2"
            >Quantidade</label
          >
          <div class="relative">
            <input
              type="number"
              id="modal-mov-qty"
              min="1"
              value="1"
              oninput="InventoryController.calculateNewStock()"
              class="w-full px-4 py-3 text-lg font-medium border border-slate-300 rounded-xl focus:ring-2 focus:ring-brand-500 focus:border-transparent outline-none transition-shadow"
              placeholder="0"
            />
            <div
              class="absolute right-3 top-1/2 -translate-y-1/2 flex flex-col"
            >
              <button
                onclick="InventoryController.adjustQty(1)"
                class="text-slate-400 hover:text-brand-600"
              >
                <i data-lucide="chevron-up" class="w-4 h-4"></i>
              </button>
              <button
                onclick="InventoryController.adjustQty(-1)"
                class="text-slate-400 hover:text-brand-600"
              >
                <i data-lucide="chevron-down" class="w-4 h-4"></i>
              </button>
            </div>
          </div>
        </div>

        <div class="flex gap-3">
          <button
            onclick="ModalManager.close('modal-movement')"
            class="flex-1 px-4 py-3 rounded-xl font-semibold bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 hover:border-slate-300 transition-all"
          >
            Cancelar
          </button>
          <button
            id="modal-mov-confirm"
            onclick="InventoryController.confirmMovement()"
            class="flex-1 px-4 py-3 rounded-xl font-bold text-white shadow-lg transition-all transform active:scale-95"
          >
            Confirmar
          </button>
        </div>
      </div>
    </div>

    <!-- Modal Detalhes do Item (Estilo Visual Personalizado) -->
    <div
      id="modal-details"
      class="fixed inset-0 bg-slate-900/60 z-50 hidden items-center justify-center p-4 backdrop-blur-sm transition-opacity opacity-0 pointer-events-none"
      aria-hidden="true"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-6 transform scale-95 transition-all duration-300"
        id="modal-details-content"
      >
        <div
          class="flex justify-between items-start mb-6 pb-4 border-b border-slate-100"
        >
          <div>
            <h3
              class="text-xl font-bold text-slate-900 tracking-tight"
              id="detail-desc"
            >
              Nome do Material
            </h3>
            <p class="text-sm font-medium text-slate-500 mt-1" id="detail-cat">
              Categoria
            </p>
          </div>
          <button
            onclick="ModalManager.close('modal-details')"
            class="text-slate-400 hover:text-slate-600 hover:bg-slate-100 p-1.5 rounded-full transition-colors"
          >
            <i data-lucide="x" class="w-6 h-6"></i>
          </button>
        </div>

        <div class="grid grid-cols-12 gap-6">
          <!-- Box 1: Info Básica -->
          <div class="col-span-12 md:col-span-6 space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <p
                  class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1"
                >
                  Código
                </p>
                <div
                  class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-mono text-slate-700"
                  id="detail-codigo"
                ></div>
              </div>
              <div>
                <p
                  class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1"
                >
                  Cód. Interno
                </p>
                <div
                  class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-mono text-slate-700"
                  id="detail-interno"
                ></div>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <p
                  class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1"
                >
                  Unid. Entrada
                </p>
                <div
                  class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-medium text-slate-700"
                  id="detail-uni-ent"
                ></div>
              </div>
              <div>
                <p
                  class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1"
                >
                  Unid. Saída
                </p>
                <div
                  class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-medium text-slate-700"
                  id="detail-uni-sai"
                ></div>
              </div>
            </div>
            <div>
              <p
                class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1"
              >
                Situação
              </p>
              <div
                class="flex items-center gap-4 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2"
              >
                <label
                  class="flex items-center gap-2 cursor-not-allowed opacity-75"
                >
                  <input
                    type="radio"
                    name="detail-status"
                    id="status-ativo"
                    disabled
                    class="text-brand-600 focus:ring-brand-500"
                  />
                  <span class="text-sm text-slate-700">Ativo</span>
                </label>
                <label
                  class="flex items-center gap-2 cursor-not-allowed opacity-75"
                >
                  <input
                    type="radio"
                    name="detail-status"
                    id="status-inativo"
                    disabled
                    class="text-slate-400 focus:ring-slate-400"
                  />
                  <span class="text-sm text-slate-700">Inativo</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Box 2: Custos e Conversão -->
          <div class="col-span-12 md:col-span-6 space-y-4">
            <div>
              <p
                class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1"
              >
                Conversão de Saída
              </p>
              <div
                class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-mono text-slate-700 text-right"
                id="detail-conversao"
              ></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <p
                  class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1"
                >
                  Custo Sigmas
                </p>
                <div
                  class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-mono text-slate-700 text-right"
                  id="detail-custo-sigmas"
                ></div>
              </div>
              <div>
                <p
                  class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1"
                >
                  Custo Médio
                </p>
                <div
                  class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-mono text-slate-700 text-right"
                  id="detail-custo-medio"
                ></div>
              </div>
            </div>
          </div>

          <!-- Box 3: Estoques (Full Width) -->
          <div class="col-span-12 pt-4 border-t border-slate-100">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div
                class="bg-blue-50 border border-blue-100 p-3 rounded-xl text-center"
              >
                <p
                  class="text-[10px] font-bold text-blue-400 uppercase tracking-wider mb-1"
                >
                  Estoque Atual
                </p>
                <p
                  class="text-2xl font-bold text-blue-700 font-mono"
                  id="detail-est-atual"
                >
                  0
                </p>
              </div>
              <div
                class="bg-slate-50 border border-slate-200 p-3 rounded-xl text-center"
              >
                <p
                  class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1"
                >
                  Estoque Reuso
                </p>
                <p
                  class="text-xl font-bold text-slate-600 font-mono"
                  id="detail-est-reuso"
                >
                  0
                </p>
              </div>
              <div
                class="bg-purple-50 border border-purple-100 p-3 rounded-xl text-center"
              >
                <p
                  class="text-[10px] font-bold text-purple-400 uppercase tracking-wider mb-1"
                >
                  Estoque Total
                </p>
                <p
                  class="text-xl font-bold text-purple-700 font-mono"
                  id="detail-est-total"
                >
                  0
                </p>
              </div>
              <div
                class="bg-green-50 border border-green-100 p-3 rounded-xl text-center"
              >
                <p
                  class="text-[10px] font-bold text-green-600 uppercase tracking-wider mb-1"
                >
                  Custo Total
                </p>
                <p
                  class="text-xl font-bold text-green-700 font-mono"
                  id="detail-custo-total"
                >
                  R$ 0,00
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Senha -->
    <div
      id="modal-password"
      class="fixed inset-0 bg-slate-900/60 z-50 hidden items-center justify-center p-4 backdrop-blur-sm transition-opacity opacity-0 pointer-events-none"
      aria-hidden="true"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 transform scale-95 transition-all duration-300"
        id="modal-password-content"
      >
        <div class="flex justify-between items-start mb-6">
          <div>
            <h3 class="text-xl font-bold text-slate-900 tracking-tight">
              Alterar Senha
            </h3>
            <p class="text-sm text-slate-500 mt-1">
              Atualize suas credenciais de segurança
            </p>
          </div>
          <button
            onclick="ModalManager.close('modal-password')"
            class="text-slate-400 hover:text-slate-600 hover:bg-slate-100 p-1 rounded-full transition-colors"
          >
            <i data-lucide="x" class="w-6 h-6"></i>
          </button>
        </div>

        <form onsubmit="AuthController.changePassword(event)" class="space-y-4">
          <div>
            <label
              class="block text-xs font-bold text-slate-500 uppercase mb-1.5"
              >Senha Atual</label
            >
            <input
              type="password"
              id="pwd-current"
              class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all"
              required
            />
          </div>
          <div>
            <label
              class="block text-xs font-bold text-slate-500 uppercase mb-1.5"
              >Nova Senha</label
            >
            <input
              type="password"
              id="pwd-new"
              class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all"
              required
            />
          </div>
          <div>
            <label
              class="block text-xs font-bold text-slate-500 uppercase mb-1.5"
              >Confirmar Nova Senha</label
            >
            <input
              type="password"
              id="pwd-confirm"
              class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all"
              required
            />
          </div>
          <div class="flex gap-3 pt-4">
            <button
              type="button"
              onclick="ModalManager.close('modal-password')"
              class="flex-1 px-4 py-2.5 rounded-xl font-semibold bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 transition-all"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="flex-1 px-4 py-2.5 rounded-xl font-bold bg-brand-600 text-white hover:bg-brand-700 shadow-md transition-all"
            >
              Salvar Alterações
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- ================== JAVASCRIPT ENGINE (MODULE) ================== -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        setDoc,
        doc,
        updateDoc,
        writeBatch,
        onSnapshot,
      } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
      import {
        getAuth,
        signInAnonymously,
      } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

      // Configuração fornecida pelo usuário
      const firebaseConfig = {
        apiKey: "AIzaSyDCu2wlBkSbD7wLvTmoZdz1ICjg5rpCzsM",
        authDomain: "gestao-de-estoque-20615.firebaseapp.com",
        projectId: "gestao-de-estoque-20615",
        storageBucket: "gestao-de-estoque-20615.firebasestorage.app",
        messagingSenderId: "925516712156",
        appId: "1:925516712156:web:4c8fa2f49982c03fca8c19",
      };

      // Inicialização Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // --- Dados Semente (Fallback e Migração) ---
      const DEFAULT_PASSWORD_HASH =
        "a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3";
      const SEED_USERS = [
        {
          name: "Jefferson de Araújo Silva",
          username: "jefferson",
          role: "admin",
          label: "Administrador",
          passwordHash: DEFAULT_PASSWORD_HASH,
        },
        {
          name: "Antônio Pinto Melo Sousa Júnior",
          username: "antonio",
          role: "user",
          label: "Usuário",
          passwordHash: DEFAULT_PASSWORD_HASH,
        },
        {
          name: "Jessé Souza dos Anjos",
          username: "jesse",
          role: "user",
          label: "Usuário",
          passwordHash: DEFAULT_PASSWORD_HASH,
        },
      ];

      const SEED_ITEMS = [
        // DEPÓSITO C4 - GÁS
        {
          id: 1,
          codigo: "B.16.04.007",
          codigoInterno: "39201",
          descricao: "GÁS 13 KG",
          categoria: "DEPÓSITO C4 - GÁS",
          unidade: "Unidade",
          estoque: 22,
          estoqueReuso: 0,
          estoqueMinimo: 5,
          qtdRessuprimento: 10,
          custoMedio: 45.0,
          unidadeEntrada: "Unidade",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 2,
          codigo: "B.16.04.006",
          codigoInterno: "39633",
          descricao: "BOTIJÃO DE GÁS P-13 (VASILHAME)",
          categoria: "DEPÓSITO C4 - GÁS",
          unidade: "Unidade",
          estoque: 30,
          estoqueReuso: 0,
          estoqueMinimo: 10,
          qtdRessuprimento: 15,
          custoMedio: 120.0,
          unidadeEntrada: "Unidade",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 3,
          codigo: "****",
          codigoInterno: "****",
          descricao: "GÁS EM USO",
          categoria: "DEPÓSITO C4 - GÁS",
          unidade: "Unidade",
          estoque: 4,
          estoqueReuso: 0,
          estoqueMinimo: 1,
          qtdRessuprimento: 2,
          custoMedio: 0.0,
          unidadeEntrada: "Unidade",
          conversao: 1,
          situacao: "Ativo",
        },
        {
          id: 4,
          codigo: "****",
          codigoInterno: "****",
          descricao: "BOTIJÃO VAZIO",
          categoria: "DEPÓSITO C4 - GÁS",
          unidade: "Unidade",
          estoque: 4,
          estoqueReuso: 0,
          estoqueMinimo: 1,
          qtdRessuprimento: 2,
          custoMedio: 0.0,
          unidadeEntrada: "Unidade",
          conversao: 1,
          situacao: "Ativo",
        },
        // Itens de exemplo para garantir funcionamento. A lista completa é carregada do DB.
      ];

      // --- Serviços (Firestore) ---

      const FirestoreService = {
        users: [],
        items: [],

        async init() {
          try {
            // Autenticação Anônima para acessar o Firestore
            await signInAnonymously(auth);
            console.log("Conectado ao Firebase.");

            // Carrega usuários (uma vez é suficiente para auth)
            await this.syncUsers();

            // Inicia Listener em Tempo Real para Itens
            // Retorna uma promessa que resolve apenas quando os primeiros dados chegarem
            await new Promise((resolve) => {
              this.setupRealtimeListener(resolve);
            });
          } catch (e) {
            console.error("Erro ao conectar Firebase:", e);
            alert("Erro ao conectar ao banco de dados. Verifique sua conexão.");
          }
        },

        async syncUsers() {
          const usersRef = collection(db, "users");
          const usersSnap = await getDocs(usersRef);

          if (usersSnap.empty) {
            const localUsers = JSON.parse(
              localStorage.getItem("serob_db_users"),
            );
            const usersToUpload = localUsers || SEED_USERS;
            const batch = writeBatch(db);
            for (const user of usersToUpload) {
              if (user.password && !user.passwordHash) {
                user.passwordHash = await SecurityUtils.hash(user.password);
                delete user.password;
              }
              const docRef = doc(db, "users", user.username);
              batch.set(docRef, user);
            }
            await batch.commit();
            this.users = usersToUpload;
          } else {
            this.users = usersSnap.docs.map((d) => d.data());
          }
        },

        setupRealtimeListener(onFirstLoad) {
          const itemsRef = collection(db, "items");

          // onSnapshot escuta mudanças em tempo real
          onSnapshot(itemsRef, async (snapshot) => {
            if (snapshot.empty) {
              // Se vazio, faz o seed inicial
              document.getElementById("loading-text").innerText =
                "Criando banco de dados...";
              const localItems = JSON.parse(
                localStorage.getItem("serob_db_items"),
              );
              const itemsToUpload = localItems || SEED_ITEMS;
              const batch = writeBatch(db);
              itemsToUpload.forEach((item) => {
                const docRef = doc(db, "items", String(item.id));
                batch.set(docRef, item);
              });
              await batch.commit();
              // O snapshot vai disparar novamente com os dados inseridos
            } else {
              // Atualiza a lista local com os dados novos do Firebase
              // Classificação aprimorada: Depósito (Categoria) -> Descrição
              this.items = snapshot.docs
                .map((d) => d.data())
                .sort((a, b) => {
                  const catA = (a.categoria || "").toString();
                  const catB = (b.categoria || "").toString();

                  // Ordenação numérica natural (ex: Depósito 2 vem antes de Depósito 10)
                  const diffCat = catA.localeCompare(catB, "pt-BR", {
                    numeric: true,
                    sensitivity: "base",
                  });

                  if (diffCat !== 0) return diffCat;

                  const descA = (a.descricao || "").toString();
                  const descB = (b.descricao || "").toString();
                  return descA.localeCompare(descB, "pt-BR", {
                    numeric: true,
                    sensitivity: "base",
                  });
                });

              // Verifica migração de campos novos (Ressuprimento/Mínimo)
              this.checkAndMigrateItems();

              // Atualiza a interface do usuário imediatamente
              if (window.App && typeof window.App.refreshUI === "function") {
                window.App.refreshUI();
              }

              // Se for a primeira carga, resolve a promessa do init
              if (onFirstLoad) {
                onFirstLoad();
                onFirstLoad = null; // Garante que só chama uma vez
              }
            }
          });
        },

        checkAndMigrateItems() {
          // Lógica de migração simplificada
          const batch = writeBatch(db);
          let hasUpdates = false;

          this.items.forEach((item) => {
            const seed = SEED_ITEMS.find((s) => s.id === item.id);
            if (seed) {
              let updated = false;
              const fields = [
                "qtdRessuprimento",
                "estoqueMinimo",
                "custoMedio",
                "unidadeEntrada",
                "conversao",
                "situacao",
                "estoqueReuso",
              ];
              const updates = {};
              fields.forEach((field) => {
                if (item[field] === undefined) {
                  updates[field] = seed[field];
                  updated = true;
                }
              });
              if (updated) {
                const docRef = doc(db, "items", String(item.id));
                batch.update(docRef, updates);
                hasUpdates = true;
              }
            }
          });

          if (hasUpdates) batch.commit();
        },

        async updateStock(id, qty, type) {
          const itemIndex = this.items.findIndex((i) => i.id === id);
          if (itemIndex === -1) return false;

          const item = this.items[itemIndex];
          let newStock = item.estoque;
          if (type === "entrada") newStock += qty;
          else newStock = Math.max(0, newStock - qty);

          try {
            const itemRef = doc(db, "items", String(id));
            await updateDoc(itemRef, { estoque: newStock });
            return true;
          } catch (e) {
            console.error("Erro ao salvar no Firebase:", e);
            return false;
          }
        },

        async updateUserPassword(username, newHash) {
          try {
            const userRef = doc(db, "users", username);
            await updateDoc(userRef, { passwordHash: newHash });

            // Atualiza local
            const userIndex = this.users.findIndex(
              (u) => u.username === username,
            );
            if (userIndex > -1) this.users[userIndex].passwordHash = newHash;

            return true;
          } catch (e) {
            console.error(e);
            return false;
          }
        },

        async importItems(newItems) {
          const batch = writeBatch(db);
          newItems.forEach((item) => {
            const docRef = doc(db, "items", String(item.id));
            batch.set(docRef, item);
          });
          await batch.commit();

          // Recarrega memória
          this.items = [...this.items, ...newItems];
          return true;
        },

        async addItem(newItem) {
          try {
            const newId = Date.now();
            const itemWithId = { ...newItem, id: newId };

            const docRef = doc(db, "items", String(newId));
            await setDoc(docRef, itemWithId);
            return true;
          } catch (e) {
            console.error("Erro ao adicionar item:", e);
            return false;
          }
        },

        async resetData() {
          const batch = writeBatch(db);
          this.items.forEach((item) => {
            const docRef = doc(db, "items", String(item.id));
            batch.delete(docRef);
          });
          await batch.commit();
          localStorage.removeItem("serob_db_items");
          location.reload();
        },
      };

      const SecurityUtils = {
        async hash(string) {
          const utf8 = new TextEncoder().encode(string);
          const hashBuffer = await crypto.subtle.digest("SHA-256", utf8);
          const hashArray = Array.from(new Uint8Array(hashBuffer));
          return hashArray.map((b) => b.toString(16).padStart(2, "0")).join("");
        },
      };

      const AuthService = {
        state: { currentUser: null },

        async login(username, password) {
          // Busca dos usuários carregados na memória pelo FirestoreService
          const users = FirestoreService.users;
          const targetUser = users.find(
            (u) => u.username === username.toLowerCase().trim(),
          );

          if (!targetUser) return false;

          const inputHash = await SecurityUtils.hash(password);

          if (targetUser.passwordHash === inputHash) {
            this.state.currentUser = targetUser;
            localStorage.setItem("serob_session", JSON.stringify(targetUser));
            return true;
          }
          return false;
        },

        logout() {
          this.state.currentUser = null;
          localStorage.removeItem("serob_session");
        },

        async changePassword(newPassword) {
          if (!this.state.currentUser) return false;
          const newHash = await SecurityUtils.hash(newPassword);

          if (
            await FirestoreService.updateUserPassword(
              this.state.currentUser.username,
              newHash,
            )
          ) {
            this.state.currentUser.passwordHash = newHash;
            localStorage.setItem(
              "serob_session",
              JSON.stringify(this.state.currentUser),
            );
            return true;
          }
          return false;
        },

        getCurrentUser() {
          return this.state.currentUser;
        },

        restoreSession() {
          const user = JSON.parse(localStorage.getItem("serob_session"));
          if (user) this.state.currentUser = user;
        },

        isAdmin() {
          return (
            this.state.currentUser && this.state.currentUser.role === "admin"
          );
        },
      };

      // --- UI Managers ---
      const ToastManager = {
        container: document.getElementById("toast-container"),
        show(message, type = "success") {
          const toast = document.createElement("div");
          const colors = type === "success" ? "bg-green-500" : "bg-red-500";
          const icon = type === "success" ? "check-circle" : "alert-circle";
          toast.className = `toast flex items-center gap-3 px-4 py-3 rounded-xl text-white ${colors} animate-scale-in`;
          toast.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5"></i><span class="font-medium text-sm">${message}</span>`;
          this.container.appendChild(toast);
          lucide.createIcons();
          setTimeout(() => {
            toast.style.opacity = "0";
            toast.style.transform = "translateY(-10px)";
            setTimeout(() => toast.remove(), 300);
          }, 3000);
        },
      };

      const ModalManager = {
        open(id) {
          const modal = document.getElementById(id);
          if (!modal) return;
          modal.classList.remove("hidden");
          modal.classList.add("flex");
          requestAnimationFrame(() => {
            modal.classList.remove("opacity-0", "pointer-events-none");
            modal
              .querySelector('div[id$="-content"]')
              ?.classList.remove("scale-95");
            modal
              .querySelector('div[id$="-content"]')
              ?.classList.add("scale-100");
          });
        },
        close(id) {
          const modal = document.getElementById(id);
          if (!modal) return;
          modal.classList.add("opacity-0", "pointer-events-none");
          modal
            .querySelector('div[id$="-content"]')
            ?.classList.remove("scale-100");
          modal.querySelector('div[id$="-content"]')?.classList.add("scale-95");
          setTimeout(() => {
            modal.classList.add("hidden");
            modal.classList.remove("flex");
          }, 300);
        },
      };

      // --- Controllers ---
      const AuthController = {
        async handleLogin(e) {
          e.preventDefault();
          const user = document.getElementById("login-username").value;
          const pass = document.getElementById("login-password").value;
          const btn = e.target.querySelector("button");
          const originalText = btn.innerHTML;

          btn.innerHTML = `<i data-lucide="loader" class="w-5 h-5 animate-spin"></i>`;
          lucide.createIcons();
          btn.disabled = true;

          try {
            if (await AuthService.login(user, pass)) {
              App.initLayout();
            } else {
              const err = document.getElementById("login-error");
              err.classList.remove("hidden");
              setTimeout(() => err.classList.add("hidden"), 3000);
            }
          } catch (err) {
            console.error(err);
            alert("Erro ao fazer login. Verifique o console.");
          } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
            lucide.createIcons();
          }
        },

        async changePassword(e) {
          e.preventDefault();
          const current = document.getElementById("pwd-current").value;
          const newPwd = document.getElementById("pwd-new").value;
          const confirm = document.getElementById("pwd-confirm").value;
          const currentUser = AuthService.getCurrentUser();

          const currentHash = await SecurityUtils.hash(current);
          if (currentHash !== currentUser.passwordHash) {
            ToastManager.show("Senha atual incorreta.", "error");
            return;
          }
          if (newPwd.length < 3) {
            ToastManager.show("Nova senha muito curta.", "error");
            return;
          }
          if (newPwd !== confirm) {
            ToastManager.show("Confirmação não coincide.", "error");
            return;
          }

          const btn = e.target.querySelector('button[type="submit"]');
          const originalText = btn.innerHTML;
          btn.innerHTML = "Salvando...";
          btn.disabled = true;

          if (await AuthService.changePassword(newPwd)) {
            ToastManager.show("Senha alterada com sucesso!");
            ModalManager.close("modal-password");
            e.target.reset();
          } else {
            ToastManager.show("Erro ao salvar senha.", "error");
          }

          btn.innerHTML = originalText;
          btn.disabled = false;
        },
      };

      const InventoryController = {
        state: {
          activeModalItem: null,
          activeModalType: "entrada",
          searchTerm: "",
          categoryFilter: "Todas",
        },

        openMovementModal(itemId, type) {
          const item = FirestoreService.items.find((i) => i.id === itemId);
          if (!item) return;
          this.state.activeModalItem = item;
          this.state.activeModalType = type;
          document.getElementById("modal-mov-title").innerText =
            type === "entrada" ? "Registrar Entrada" : "Registrar Saída";
          document.getElementById("modal-mov-item").innerText = item.descricao;
          document.getElementById("modal-mov-current").innerText = item.estoque;
          document.getElementById("modal-mov-qty").value = 1;
          const btn = document.getElementById("modal-mov-confirm");
          btn.className = `flex-1 px-4 py-3 rounded-xl font-bold text-white shadow-lg transition-all transform active:scale-95 ${type === "entrada" ? "bg-green-600 hover:bg-green-700 shadow-green-600/20" : "bg-red-600 hover:bg-red-700 shadow-red-600/20"}`;
          this.calculateNewStock();
          ModalManager.open("modal-movement");
        },

        calculateNewStock() {
          const qty =
            parseInt(document.getElementById("modal-mov-qty").value) || 0;
          const current = this.state.activeModalItem.estoque;
          let newVal = 0;
          const el = document.getElementById("modal-mov-new");
          if (this.state.activeModalType === "entrada") {
            newVal = current + qty;
            el.className = "text-2xl font-mono font-bold text-green-600";
          } else {
            newVal = Math.max(0, current - qty);
            el.className = "text-2xl font-mono font-bold text-red-600";
          }
          el.innerText = newVal;
        },

        adjustQty(delta) {
          const input = document.getElementById("modal-mov-qty");
          let val = parseInt(input.value) || 0;
          val = Math.max(1, val + delta);
          input.value = val;
          this.calculateNewStock();
        },

        async confirmMovement() {
          const qty =
            parseInt(document.getElementById("modal-mov-qty").value) || 0;
          if (qty <= 0) return;

          const btn = document.getElementById("modal-mov-confirm");
          const originalText = btn.innerText;
          btn.innerText = "Salvando...";
          btn.disabled = true;

          if (
            await FirestoreService.updateStock(
              this.state.activeModalItem.id,
              qty,
              this.state.activeModalType,
            )
          ) {
            ToastManager.show(`Movimentação salva no Firebase!`);
            ModalManager.close("modal-movement");
            // No direct refresh call needed due to listener, but keeping consistent UX flow
          } else {
            ToastManager.show("Erro ao salvar.", "error");
          }

          btn.innerText = originalText;
          btn.disabled = false;
        },

        handleSearch(val) {
          this.state.searchTerm = val;
          App.renderTableRows();
        },

        handleAdvancedSearch() {
          const nameVal = document.getElementById("search-name").value;
          const codeVal = document.getElementById("search-code").value;

          this.state.searchTerm = nameVal || codeVal;
          App.renderTableRows();
        },

        handleCategory(val) {
          this.state.categoryFilter = val;
          App.renderTableRows();
        },

        // --- Novas Funções para Cadastro ---
        async saveNewItem(e) {
          e.preventDefault();

          // 1. Obter valores
          const codigo = document.getElementById("new-codigo").value.trim();
          const codigoInterno = document
            .getElementById("new-codigo-interno")
            .value.trim();
          const descricao = document
            .getElementById("new-descricao")
            .value.trim();

          // 2. Validação de Duplicidade
          const duplicado = FirestoreService.items.find((item) => {
            const mesmoCodigo =
              item.codigo &&
              item.codigo.trim().toUpperCase() === codigo.toUpperCase();
            const mesmaDescricao =
              item.descricao &&
              item.descricao.trim().toUpperCase() === descricao.toUpperCase();
            const mesmoInterno =
              codigoInterno &&
              item.codigoInterno &&
              item.codigoInterno.toString().trim() === codigoInterno;

            return mesmoCodigo || mesmaDescricao || mesmoInterno;
          });

          if (duplicado) {
            let msg = "Material já cadastrado!";
            if (
              duplicado.codigo.trim().toUpperCase() === codigo.toUpperCase()
            ) {
              msg += ` (Código ${duplicado.codigo} já existe)`;
            } else if (
              duplicado.descricao.trim().toUpperCase() ===
              descricao.toUpperCase()
            ) {
              msg += ` (Descrição idêntica encontrada)`;
            }
            ToastManager.show(msg, "error");
            return;
          }

          const btn = e.target.querySelector('button[type="submit"]');
          const originalText = btn.innerText;
          btn.innerText = "Salvando...";
          btn.disabled = true;

          const newItem = {
            codigo: codigo,
            codigoInterno: codigoInterno,
            descricao: descricao,
            categoria: document.getElementById("new-categoria").value,
            unidade: document.getElementById("new-unidade").value,
            estoque:
              parseFloat(document.getElementById("new-estoque").value) || 0,
            estoqueMinimo:
              parseFloat(document.getElementById("new-minimo").value) || 0,
            qtdRessuprimento:
              parseFloat(document.getElementById("new-ressup").value) || 0,
          };

          const success = await FirestoreService.addItem(newItem);

          if (success) {
            ToastManager.show("Material cadastrado com sucesso!");
            e.target.reset();
            // Opcional: Redirecionar para a tabela
            // App.navigate('stock-search');
          } else {
            ToastManager.show("Erro ao cadastrar material.", "error");
          }

          btn.innerText = originalText;
          btn.disabled = false;
        },

        openStockDetailModal(itemId) {
          const item = FirestoreService.items.find((i) => i.id === itemId);
          if (!item) return;

          document.getElementById("detail-desc").innerText = item.descricao;
          document.getElementById("detail-cat").innerText = item.categoria;
          document.getElementById("detail-codigo").innerText = item.codigo;
          document.getElementById("detail-interno").innerText =
            item.codigoInterno || "-";

          document.getElementById("detail-uni-ent").innerText =
            item.unidadeEntrada || item.unidade;
          document.getElementById("detail-uni-sai").innerText = item.unidade;

          // Radio Buttons
          document.getElementById("status-ativo").checked =
            item.situacao !== "Inativo";
          document.getElementById("status-inativo").checked =
            item.situacao === "Inativo";

          document.getElementById("detail-conversao").innerText = item.conversao
            ? item.conversao.toFixed(3)
            : "1.000";

          const custo = item.custoMedio || 0;
          const estoque = item.estoque || 0;
          const reuso = item.estoqueReuso || 0;
          const total = estoque + reuso;

          document.getElementById("detail-custo-sigmas").innerText =
            "R$ " + (custo * 0.95).toFixed(2); // Simulado
          document.getElementById("detail-custo-medio").innerText =
            "R$ " + custo.toFixed(2);

          document.getElementById("detail-est-atual").innerText = estoque;
          document.getElementById("detail-est-reuso").innerText = reuso;
          document.getElementById("detail-est-total").innerText = total;
          document.getElementById("detail-custo-total").innerText =
            "R$ " + (custo * total).toFixed(2);

          ModalManager.open("modal-details");
        },
      };

      // --- Aplicação Principal ---
      const App = {
        currentTab: "dashboard",

        async init() {
          // Restore session FIRST so currentUser is available if logged in
          AuthService.restoreSession();

          // Inicializa Firebase
          await FirestoreService.init();

          // Remove tela de loading
          document.getElementById("loading-screen").classList.add("hidden");

          const loginForm = document.getElementById("login-form");
          if (loginForm)
            loginForm.addEventListener("submit", AuthController.handleLogin);

          if (AuthService.getCurrentUser()) {
            this.initLayout();
          } else {
            document.getElementById("login-layout").classList.remove("hidden");
          }
          lucide.createIcons();
        },

        refreshUI() {
          // Only refresh if user is logged in
          if (!AuthService.getCurrentUser()) return;

          // Re-renderiza a tela atual com os dados novos se necessário
          if (this.currentTab === "dashboard") {
            this.renderDashboard();
          } else if (
            this.currentTab === "stock-search" ||
            this.currentTab === "stock-move"
          ) {
            this.renderTableRows();
          }
        },

        resetData() {
          if (
            confirm(
              "ATENÇÃO: Isso irá apagar todos os dados no Firebase e restaurar os itens originais. Deseja continuar?",
            )
          ) {
            FirestoreService.resetData();
          }
        },

        initLayout() {
          document.getElementById("login-layout").classList.add("hidden");
          const appLayout = document.getElementById("app-layout");
          appLayout.classList.remove("hidden");
          appLayout.classList.add("animate-fade-in");
          appLayout.classList.add("flex");
          this.updateUserProfile();
          this.navigate(this.currentTab);
        },

        updateUserProfile() {
          const user = AuthService.getCurrentUser();
          if (!user) return;
          document.getElementById("user-name").innerText =
            user.name.split(" ")[0];
          document.getElementById("user-role").innerText = user.label;
          const iconHtml = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-full h-full p-1 fill-slate-600"><path d="M15.71,12.71a6,6,0,1,0-7.42,0,10,10,0,0,0-6.22,8.18,1,1,0,0,0,2,.22,8,8,0,0,1,15.9,0,1,1,0,0,0,1,.89h.11a1,1,0,0,0,.88-1.1A10,10,0,0,0,15.71,12.71ZM12,12a4,4,0,1,1,4-4A4,4,0,0,1,12,12Z"/></svg>`;
          document.getElementById("user-avatar").innerHTML = iconHtml;
          document.getElementById("mobile-user-avatar").innerHTML = iconHtml;

          const adminTools = document.getElementById("admin-tools");
          if (AuthService.isAdmin()) adminTools.classList.remove("hidden");
          else adminTools.classList.add("hidden");
        },

        toggleSubmenu(id) {
          const el = document.getElementById(id);
          const arrow = document.getElementById("arrow-" + id.split("-")[1]);

          if (el.classList.contains("hidden")) {
            el.classList.remove("hidden");
            arrow.classList.add("rotate-180");
          } else {
            el.classList.add("hidden");
            arrow.classList.remove("rotate-180");
          }
        },

        navigate(tab) {
          this.currentTab = tab;

          // Reset styles
          document.querySelectorAll("nav button").forEach((b) => {
            if (b.id !== "nav-material") {
              // Reset submenu items to standard style (text-slate-600 for contrast)
              if (b.parentElement.id === "submenu-material") {
                b.className =
                  "w-full flex items-center gap-2 px-4 py-2 rounded-lg text-xs font-medium text-slate-600 hover:text-brand-600 hover:bg-brand-50 transition-all";
              } else {
                // Reset main menu items
                b.className =
                  "w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold text-slate-600 hover:bg-slate-50 transition-all duration-200";
              }
            }
          });

          // Apply active styles based on tab
          if (tab === "dashboard") {
            document.getElementById("nav-dashboard").className =
              "w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold bg-brand-50 text-brand-600 transition-all duration-200";
            this.renderDashboard();
          } else if (
            tab.startsWith("stock-") ||
            tab.startsWith("movement-") ||
            tab.startsWith("material-")
          ) {
            // Ensure submenu is open
            const sub = document.getElementById("submenu-material");
            if (sub.classList.contains("hidden"))
              this.toggleSubmenu("submenu-material");

            // Highlight specific sub-item
            const activeSubClass =
              "w-full flex items-center gap-2 px-4 py-2 rounded-lg text-xs font-medium bg-brand-100 text-brand-700 font-bold transition-all";

            if (tab === "stock-search") {
              document.getElementById("nav-stock-search").className =
                activeSubClass;
              this.renderStockSearch();
            } else if (tab === "stock-move") {
              document.getElementById("nav-stock-move").className =
                activeSubClass;
              this.renderMovementsLayout("Movimentação de Estoque");
            } else if (tab === "movement-search") {
              document.getElementById("nav-mov-search").className =
                activeSubClass;
              this.renderHistoryLayout();
            } else if (tab === "material-register") {
              document.getElementById("nav-mat-register").className =
                activeSubClass;
              this.renderRegisterLayout();
            }
          }

          // Mobile: close sidebar on navigate
          const sidebar = document.getElementById("sidebar");
          if (!sidebar.classList.contains("-translate-x-full"))
            this.toggleSidebar();
        },

        toggleSidebar() {
          const sidebar = document.getElementById("sidebar");
          const overlay = document.getElementById("mobile-overlay");
          sidebar.classList.toggle("-translate-x-full");
          overlay.classList.toggle("hidden");
          overlay.classList.toggle("opacity-0");
        },

        logout() {
          AuthService.logout();
          location.reload();
        },

        openPasswordModal() {
          document.getElementById("pwd-current").value = "";
          document.getElementById("pwd-new").value = "";
          document.getElementById("pwd-confirm").value = "";
          ModalManager.open("modal-password");
        },

        // --- Renderers ---
        renderStockSearch() {
          const container = document.getElementById("content-area");
          if (!AuthService.getCurrentUser()) return;

          container.innerHTML = `
                <div class="space-y-4 h-full flex flex-col animate-fade-in max-w-7xl mx-auto">
                    
                    <!-- Painel de Filtros (Janela de Pesquisa) -->
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <div class="flex items-center gap-2 mb-4 pb-2 border-b border-slate-100">
                            <i data-lucide="search" class="w-5 h-5 text-brand-600"></i>
                            <h2 class="text-lg font-bold text-slate-800">Pesquisa de Estoque</h2>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                            <div class="md:col-span-5">
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Nome do Material</label>
                                <input type="text" id="search-name" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all" placeholder="Digite o nome..." onkeyup="InventoryController.handleAdvancedSearch()">
                            </div>
                            <div class="md:col-span-4">
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Código</label>
                                <input type="text" id="search-code" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all" placeholder="Digite o código..." onkeyup="InventoryController.handleAdvancedSearch()">
                            </div>
                            <div class="md:col-span-3">
                                <button onclick="InventoryController.handleAdvancedSearch()" class="w-full px-4 py-2.5 bg-brand-600 text-white font-bold rounded-lg shadow-md hover:bg-brand-700 transition-all flex items-center justify-center gap-2 active:scale-95">
                                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> Atualiza Dados
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Label Específico "Dados do Material" -->
                    <div class="w-full pt-2">
                        <div class="HTMLLabel" id="MakerLabel1" style="display: block; margin-bottom: 5px;">
                            <div style="vertical-align: middle;">
                                <div style="white-space: nowrap; text-decoration: none; font-weight: bold; font-size: 16px; color: #334155; display: flex; items-align: center; gap: 8px;">
                                   <span class="w-1 h-5 bg-brand-500 rounded-full inline-block"></span>
                                   &nbsp;Dados&nbsp;do&nbsp;Material&nbsp;
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabela de Resultados -->
                    <div class="bg-white rounded-xl border border-slate-200 overflow-hidden flex-1 flex flex-col shadow-sm">
                        <div class="overflow-auto flex-1 custom-scrollbar">
                            <table class="w-full text-sm text-left relative">
                                <thead class="bg-slate-50 text-slate-600 font-bold uppercase text-[11px] tracking-wider sticky top-0 z-10 border-b border-slate-200 backdrop-blur-sm">
                                    <tr>
                                        <th class="px-4 py-3 w-28">Contrato</th>
                                        <th class="px-4 py-3 w-24">Cód. Int.</th>
                                        <th class="px-4 py-3 min-w-[200px]">Descrição</th>
                                        <th class="px-4 py-3 text-center w-20">Unid.</th>
                                        <th class="px-4 py-3 text-center w-24">Saldo</th>
                                        <th class="px-4 py-3 text-center w-20">Mín.</th>
                                        <th class="px-4 py-3 text-center w-20">Ressup.</th>
                                        <th class="px-4 py-3 text-center w-24">Status</th>
                                        <th class="px-4 py-3 text-right w-16"></th>
                                    </tr>
                                </thead>
                                <tbody id="inventory-body" class="divide-y divide-slate-100 bg-white"></tbody>
                            </table>
                        </div>
                        <div class="bg-slate-50 px-4 py-2 border-t border-slate-200 text-xs text-slate-500 text-right">
                            Total de registros: <span id="total-records" class="font-bold">0</span>
                        </div>
                    </div>
                </div>
            `;
          lucide.createIcons();
          // Carrega tabela inicial
          this.renderTableRows();
        },

        renderDashboard() {
          const container = document.getElementById("content-area");
          // Guard clause: if user is not logged in, do not attempt to render
          const user = AuthService.getCurrentUser();
          if (!user) return;

          const stats = {
            totalItems: FirestoreService.items.length,
            lowStock: FirestoreService.items.filter(
              (i) => i.estoque <= i.estoqueMinimo,
            ).length,
            totalStock: FirestoreService.items.reduce(
              (acc, curr) => acc + curr.estoque,
              0,
            ),
            categories: [
              ...new Set(FirestoreService.items.map((i) => i.categoria)),
            ].length,
          };

          const h = new Date().getHours();
          const greeting =
            h < 12 ? "Bom dia" : h < 18 ? "Boa tarde" : "Boa noite";

          // Filtra itens com alerta (40% de margem acima do mínimo) ou críticos
          const alertItems = FirestoreService.items
            .filter((i) => i.estoque <= i.estoqueMinimo * 1.4)
            .sort(
              (a, b) =>
                a.estoque / a.estoqueMinimo - b.estoque / b.estoqueMinimo,
            );

          container.innerHTML = `
                    <div class="space-y-8 animate-fade-in pb-10 max-w-7xl mx-auto">
                        <div class="flex justify-between items-end">
                            <div>
                                <h2 class="text-3xl font-bold text-slate-900 tracking-tight">${greeting}, ${user.name.split(" ")[0]}!</h2>
                                <p class="text-slate-500 mt-1">Aqui está o panorama atual do almoxarifado (Online).</p>
                            </div>
                            <div class="hidden md:block text-right">
                                <p class="text-xs font-bold uppercase text-slate-400 tracking-wider">Última atualização</p>
                                <p class="text-sm font-mono text-slate-600">${new Date().toLocaleTimeString()}</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
                            ${this._createCard("Total de Itens", stats.totalItems, "package", "blue")}
                            ${this._createCard("Itens Críticos", stats.lowStock, "alert-triangle", "red")}
                            ${this._createCard("Estoque Físico", stats.totalStock, "trending-up", "green")}
                            ${this._createCard("Depósitos Ativos", stats.categories, "layout-dashboard", "purple")}
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col">
                                <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0">
                                    <h3 class="font-bold text-slate-900 flex items-center gap-2">
                                        <i data-lucide="bell-ring" class="w-4 h-4 text-brand-500"></i>
                                        Alertas de Reposição
                                    </h3>
                                    <button onclick="App.navigate('stock-search')" class="text-xs font-semibold text-brand-600 bg-brand-50 px-3 py-1.5 rounded-lg hover:bg-brand-100 transition-colors">Ver Estoque</button>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm text-left">
                                        <thead class="bg-slate-50 text-slate-500 font-semibold uppercase text-[10px] tracking-wider">
                                            <tr>
                                                <th class="px-6 py-4">Item</th>
                                                <th class="px-6 py-4 text-right">Saldo</th>
                                                <th class="px-6 py-4 text-right">Mínimo</th>
                                                <th class="px-6 py-4 text-center">Ressuprimento</th>
                                                <th class="px-6 py-4 text-center">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-slate-100">
                                            ${
                                              alertItems
                                                .slice(0, 5)
                                                .map((item) => {
                                                  const isCritical =
                                                    item.estoque <=
                                                    item.estoqueMinimo;
                                                  const statusClass = isCritical
                                                    ? "bg-red-100 text-red-800 border-red-200"
                                                    : "bg-yellow-100 text-yellow-800 border-yellow-200";
                                                  const statusText = isCritical
                                                    ? "Crítico"
                                                    : "Alerta";
                                                  const stockClass = isCritical
                                                    ? "text-red-600"
                                                    : "text-yellow-600";

                                                  return `
                                                <tr class="hover:bg-slate-50 transition-colors group">
                                                    <td class="px-6 py-4">
                                                        <div class="font-medium text-slate-900 group-hover:text-brand-600 transition-colors">${item.descricao}</div>
                                                        <div class="text-xs text-slate-400">${item.categoria}</div>
                                                    </td>
                                                    <td class="px-6 py-4 text-right font-mono font-bold ${stockClass}">${item.estoque}</td>
                                                    <td class="px-6 py-4 text-right font-mono text-slate-500">${item.estoqueMinimo}</td>
                                                    <td class="px-6 py-4 text-center font-mono text-slate-500 font-bold">${item.qtdRessuprimento || "-"}</td>
                                                    <td class="px-6 py-4 text-center">
                                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${statusClass}">${statusText}</span>
                                                    </td>
                                                </tr>`;
                                                })
                                                .join("") ||
                                              `<tr><td colspan="5" class="px-6 py-12 text-center text-slate-400 italic">Tudo em ordem! Nenhum alerta.</td></tr>`
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 flex flex-col">
                                <h3 class="font-bold text-slate-900 mb-6">Top Depósitos</h3>
                                <div class="space-y-5 overflow-y-auto custom-scrollbar flex-1 pr-2">
                                    ${[
                                      ...new Set(
                                        FirestoreService.items.map(
                                          (i) => i.categoria,
                                        ),
                                      ),
                                    ]
                                      .slice(0, 6)
                                      .map((cat) => {
                                        const count =
                                          FirestoreService.items.filter(
                                            (i) => i.categoria === cat,
                                          ).length;
                                        const percent = Math.min(
                                          100,
                                          (count / stats.totalItems) * 100 * 3,
                                        );
                                        return `
                                            <div>
                                                <div class="flex justify-between text-xs mb-1.5 font-medium">
                                                    <span class="text-slate-700 truncate w-3/4" title="${cat}">${cat.replace(/DEPÓSITO |DEP\. /, "")}</span>
                                                    <span class="text-slate-400">${count}</span>
                                                </div>
                                                <div class="w-full bg-slate-100 rounded-full h-2 overflow-hidden">
                                                    <div class="bg-brand-500 h-2 rounded-full transition-all duration-1000" style="width: ${percent}%"></div>
                                                </div>
                                            </div>`;
                                      })
                                      .join("")}
                                </div>
                            </div>
                        </div>
                    </div>`;
          lucide.createIcons();
        },

        _createCard(title, value, icon, color) {
          const colorMap = {
            blue: {
              bg: "bg-blue-50",
              text: "text-blue-600",
              border: "border-blue-100",
            },
            red: {
              bg: "bg-red-50",
              text: "text-red-600",
              border: "border-red-100",
            },
            green: {
              bg: "bg-green-50",
              text: "text-green-600",
              border: "border-green-100",
            },
            purple: {
              bg: "bg-purple-50",
              text: "text-purple-600",
              border: "border-purple-100",
            },
          };
          const c = colorMap[color];
          return `
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 flex items-start justify-between hover:shadow-md transition-shadow group">
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">${title}</p>
                            <h3 class="text-3xl font-bold text-slate-900 group-hover:scale-105 transition-transform origin-left">${value}</h3>
                        </div>
                        <div class="p-3 rounded-xl ${c.bg} ${c.text} ${c.border} border shadow-inner">
                            <i data-lucide="${icon}" class="w-6 h-6"></i>
                        </div>
                    </div>`;
        },

        renderMovementsLayout(title) {
          const container = document.getElementById("content-area");
          if (!AuthService.getCurrentUser()) return;

          const categories = [
            "Todas",
            "DEPÓSITO C4 - GÁS",
            "DEPÓSITO 01 - IMPERMEABILIZAÇÃO",
            "DEPÓSITO 02 - TINTA ESMALTE",
            "DEPÓSITO 03 - COLA FÓRMICA",
            "DEPÓSITO 04 - ÁLCOOL",
            "DEPÓSITO 12 - PISO VINÍLICO",
            "DEPÓSITO 25 - TINTA ACRÍLICA",
            "DEMAP - 01 ao 11",
          ];

          // Determina se é a aba de movimentação para mostrar/esconder ações
          const isMovementTab = this.currentTab === "stock-move";

          if (!title) {
            title = "Movimentação de Estoque";
          }
          const subtitle = "Gerenciar entradas e saídas do estoque";
          const actionsHeader =
            '<th class="px-4 py-4 text-right w-24">Ações</th>';

          container.innerHTML = `
                    <div class="space-y-6 h-full flex flex-col animate-fade-in max-w-[1600px] mx-auto">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 bg-white p-4 rounded-2xl border border-slate-200 shadow-sm sticky top-0 z-10">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-900">${title}</h2>
                                <p class="text-sm text-slate-500">${subtitle}</p>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-3">
                                <div class="relative group">
                                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 group-focus-within:text-brand-500 transition-colors"></i>
                                    <input type="text" placeholder="Buscar código, nome..." value="${InventoryController.state.searchTerm}" oninput="InventoryController.handleSearch(this.value)" class="w-full sm:w-64 pl-10 pr-4 py-2.5 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent text-sm bg-slate-50 focus:bg-white transition-all">
                                </div>
                                <div class="relative">
                                    <select onchange="InventoryController.handleCategory(this.value)" class="appearance-none w-full sm:w-64 bg-white border border-slate-300 text-slate-700 py-2.5 pl-4 pr-10 rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent text-sm cursor-pointer shadow-sm hover:border-brand-400 transition-colors">
                                        ${categories.map((cat) => `<option value="${cat}" ${InventoryController.state.categoryFilter === cat ? "selected" : ""}>${cat}</option>`).join("")}
                                    </select>
                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-500">
                                        <i data-lucide="chevron-down" class="w-4 h-4"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex-1 flex flex-col">
                            <div class="overflow-auto flex-1 custom-scrollbar">
                                <table class="w-full text-sm text-left relative">
                                    <thead class="bg-slate-50 text-slate-500 font-semibold uppercase text-[10px] tracking-wider sticky top-0 z-10 backdrop-blur-sm border-b border-slate-200">
                                        <tr>
                                            <th class="px-4 py-4 w-28">Contrato</th>
                                            <th class="px-4 py-4 w-24">Cód. Int.</th>
                                            <th class="px-4 py-4 min-w-[200px]">Descrição</th>
                                            <th class="px-4 py-4 text-center w-20">Unid.</th>
                                            <th class="px-4 py-4 text-center w-24">Saldo</th>
                                            <th class="px-4 py-4 text-center w-20">Mín.</th>
                                            <th class="px-4 py-4 text-center w-20">Ressup.</th>
                                            <th class="px-4 py-4 text-center w-24">Status</th>
                                            ${actionsHeader}
                                        </tr>
                                    </thead>
                                    <tbody id="inventory-body" class="divide-y divide-slate-100"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
          this.renderTableRows();
        },

        renderTableRows() {
          const tbody = document.getElementById("inventory-body");
          if (!tbody) return;

          const { searchTerm, categoryFilter } = InventoryController.state;
          const items = FirestoreService.items;
          const isMovementTab = this.currentTab === "stock-move";

          const normalizeText = (text) => {
            return text
              ? text
                  .normalize("NFD")
                  .replace(/[\u0300-\u036f]/g, "")
                  .toLowerCase()
              : "";
          };

          const searchNormalized = normalizeText(searchTerm);

          // Filtragem básica por texto e categoria
          const filtered = items.filter((item) => {
            const descNormalized = normalizeText(item.descricao);
            const codeNormalized = normalizeText(item.codigo);
            const internalCodeNormalized = normalizeText(item.codigoInterno);

            const matchesSearch =
              descNormalized.includes(searchNormalized) ||
              codeNormalized.includes(searchNormalized) ||
              internalCodeNormalized.includes(searchNormalized);

            const matchesCategory =
              categoryFilter === "Todas" || item.categoria === categoryFilter;

            return matchesSearch && matchesCategory;
          });

          // --- DEDUPLICAÇÃO VISUAL ---
          const uniqueItems = [];
          const seenKeys = new Set();

          filtered.forEach((item) => {
            // Cria uma chave única baseada em CÓDIGO (se existir e for real) ou DESCRIÇÃO
            // Normaliza para maiúsculo para evitar duplicatas por case sensitive
            let key = "";
            if (
              item.codigo &&
              item.codigo.length > 3 &&
              !item.codigo.includes("****")
            ) {
              key = "CODE:" + item.codigo.trim().toUpperCase();
            } else {
              key = "DESC:" + item.descricao.trim().toUpperCase();
            }

            if (!seenKeys.has(key)) {
              seenKeys.add(key);
              uniqueItems.push(item);
            }
          });
          // ---------------------------

          const colSpan = isMovementTab ? 9 : 9;

          if (uniqueItems.length === 0) {
            tbody.innerHTML = `<tr><td colspan="${colSpan}" class="px-6 py-20 text-center flex flex-col items-center justify-center text-slate-400"><div class="bg-slate-50 p-4 rounded-full mb-3"><i data-lucide="search-x" class="w-8 h-8"></i></div><span class="font-medium">Nenhum item encontrado</span><span class="text-xs mt-1">Tente ajustar os filtros de busca</span></td></tr>`;
          } else {
            tbody.innerHTML = uniqueItems
              .map((item) => {
                const min = item.estoqueMinimo || 0;
                const alertThreshold = min * 1.4;
                let statusHtml = "";
                let rowClass =
                  "hover:bg-slate-50 transition-colors group border-l-4 border-transparent";

                if (item.estoque <= min) {
                  statusHtml =
                    '<span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-red-50 text-red-700 border border-red-100 ring-1 ring-red-500/10">Crítico</span>';
                  rowClass += " hover:border-red-500";
                } else if (item.estoque <= alertThreshold) {
                  statusHtml =
                    '<span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-yellow-50 text-yellow-700 border border-yellow-100 ring-1 ring-yellow-500/10">Alerta</span>';
                  rowClass += " hover:border-yellow-500";
                } else {
                  statusHtml =
                    '<span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-green-50 text-green-700 border border-green-100 ring-1 ring-green-500/10">Normal</span>';
                  rowClass += " hover:border-brand-500";
                }

                let actionsCell = "";
                if (isMovementTab) {
                  // Botões de Movimentação
                  actionsCell = `
                    <td class="px-4 py-4 text-right">
                        <div class="flex items-center justify-end gap-2 opacity-80 group-hover:opacity-100 transition-opacity">
                            <button onclick="InventoryController.openMovementModal(${item.id}, 'entrada')" class="p-1.5 text-green-600 bg-green-50 hover:bg-green-100 border border-green-200 rounded-lg transition-all shadow-sm hover:shadow active:scale-95" title="Entrada"><i data-lucide="plus" class="w-3.5 h-3.5"></i></button>
                            <button onclick="InventoryController.openMovementModal(${item.id}, 'saida')" class="p-1.5 text-red-600 bg-red-50 hover:bg-red-100 border border-red-200 rounded-lg transition-all shadow-sm hover:shadow active:scale-95" title="Saída"><i data-lucide="minus" class="w-3.5 h-3.5"></i></button>
                        </div>
                    </td>`;
                } else {
                  // Botão de Detalhes (Olho) para a Pesquisa
                  actionsCell = `
                    <td class="px-4 py-4 text-right">
                        <div class="flex items-center justify-end gap-2 opacity-80 group-hover:opacity-100 transition-opacity">
                            <button onclick="InventoryController.openStockDetailModal(${item.id})" class="p-1.5 text-brand-600 bg-brand-50 hover:bg-brand-100 border border-brand-200 rounded-lg transition-all shadow-sm hover:shadow active:scale-95" title="Ver Detalhes">
                                <i data-lucide="eye" class="w-3.5 h-3.5"></i>
                            </button>
                        </div>
                    </td>`;
                }

                return `
                        <tr class="${rowClass}">
                            <td class="px-4 py-4 font-mono text-xs text-slate-500">${item.codigo}</td>
                            <td class="px-4 py-4 font-mono text-xs text-slate-500">${item.codigoInterno || "-"}</td>
                            <td class="px-4 py-4">
                                <div class="font-semibold text-slate-800 text-sm mb-0.5">${item.descricao}</div>
                                <div class="text-[10px] text-slate-400 uppercase tracking-wide truncate max-w-[200px]" title="${item.categoria}">${item.categoria.replace(/DEPÓSITO |DEP\. /, "")}</div>
                            </td>
                            <td class="px-4 py-4 text-center text-xs text-slate-500">${item.unidade}</td>
                            <td class="px-4 py-4 text-center">
                                <span class="font-mono text-base font-bold ${item.estoque <= min ? "text-red-600" : item.estoque <= alertThreshold ? "text-yellow-600" : "text-slate-700"}">${item.estoque}</span>
                            </td>
                            <td class="px-4 py-4 text-center font-mono text-xs text-slate-500">${min}</td>
                            <td class="px-4 py-4 text-center font-mono text-xs text-slate-500">${item.qtdRessuprimento || "-"}</td>
                            <td class="px-4 py-4 text-center">
                                ${statusHtml}
                            </td>
                            ${actionsCell}
                        </tr>`;
              })
              .join("");
          }
          // Atualiza contador se existir
          const counter = document.getElementById("total-records");
          if (counter) counter.innerText = uniqueItems.length;

          lucide.createIcons();
        },

        async handleFileUpload(event) {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (e) => {
            const text = e.target.result;
            const lines = text.split("\n");
            const newItems = [];
            let currentCategory = "Importado";

            if (file.name.includes("DEP.")) {
              const parts = file.name.split(".");
              if (parts.length > 1) currentCategory = parts[0] + " " + parts[1];
            }

            lines.forEach((line, index) => {
              if (line.length < 10 || line.includes("CÓDIGO DO CONTRATO"))
                return;
              const cols = line.split(",");
              const codigo = cols.find(
                (c) => c && c.match(/B\.\d{2}\.\d{2}\.\d{3}/),
              );

              if (codigo) {
                const descIndex = cols.findIndex(
                  (c) => c.length > 10 && !c.match(/B\.\d{2}/),
                );
                const descricao =
                  cols[descIndex]?.replace(/"/g, "") || "Item importado";
                const numbers = cols
                  .map((c) => parseFloat(c))
                  .filter((n) => !isNaN(n));
                let codigoInterno = "";
                for (let i = 0; i < cols.length; i++) {
                  const val = cols[i].trim();
                  if (!isNaN(val) && val.length >= 4 && val !== codigo) {
                    codigoInterno = val;
                    break;
                  }
                }
                const estoque =
                  numbers.length > 0 ? numbers[numbers.length - 1] : 0;
                // Valor padrão para novos itens importados
                const estoqueMinimo = 10;

                newItems.push({
                  id: Date.now() + index + Math.random(),
                  codigo: codigo,
                  codigoInterno: codigoInterno,
                  descricao: descricao,
                  categoria: currentCategory,
                  unidade: "UN",
                  estoque: estoque,
                  estoqueMinimo: estoqueMinimo,
                  qtdRessuprimento: estoqueMinimo * 2, // Padrão simples
                });
              }
            });

            if (newItems.length > 0) {
              // Importar para Firestore
              const btn =
                document.querySelector('input[type="file"]').parentElement;

              btn.innerHTML = `<div class="flex flex-col items-center justify-center py-1"><i data-lucide="loader" class="w-5 h-5 text-brand-500 animate-spin mb-1"></i><span class="text-[10px] font-medium text-slate-500">Processando...</span></div>`;
              lucide.createIcons();

              FirestoreService.importItems(newItems).then(() => {
                ToastManager.show(
                  `${newItems.length} itens importados para o Firebase!`,
                  "success",
                );
                if (App.currentTab === "dashboard") App.renderDashboard();
                else App.renderMovementsLayout();

                // Reset UI com o novo design avançado
                btn.innerHTML = `
                    <div class="flex items-center justify-center gap-3 transition-transform group-hover:-translate-y-0.5 duration-300">
                      <div class="p-1.5 bg-white rounded-lg border border-slate-200 shadow-sm group-hover:border-brand-200 text-slate-400 group-hover:text-brand-600 transition-colors">
                        <i data-lucide="file-spreadsheet" class="w-4 h-4"></i>
                      </div>
                      <div class="flex flex-col text-left">
                        <span class="text-[10px] font-semibold text-slate-600 group-hover:text-brand-700 transition-colors">Importar CSV</span>
                        <span class="text-[8px] text-slate-400 group-hover:text-brand-500 transition-colors">Clique para enviar</span>
                      </div>
                    </div>
                    <input type="file" accept=".csv" class="hidden" onchange="App.handleFileUpload(event)" />
                  `;
                lucide.createIcons();
              });
            } else {
              ToastManager.show(
                "Formato de arquivo inválido ou sem dados.",
                "error",
              );
            }
          };
          reader.readAsText(file);
          event.target.value = "";
        },

        renderHistoryLayout() {
          const container = document.getElementById("content-area");
          container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-slate-400 animate-fade-in">
                    <div class="bg-slate-50 p-6 rounded-full mb-4">
                        <i data-lucide="history" class="w-12 h-12 text-slate-300"></i>
                    </div>
                    <h3 class="text-lg font-bold text-slate-600 mb-1">Pesquisa de Movimentação</h3>
                    <p class="text-sm">Funcionalidade de histórico detalhado em desenvolvimento.</p>
                </div>
            `;
          lucide.createIcons();
        },

        renderRegisterLayout() {
          const container = document.getElementById("content-area");
          container.innerHTML = `
                <div class="max-w-2xl mx-auto animate-fade-in">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8">
                        <div class="mb-8">
                            <h2 class="text-2xl font-bold text-slate-900">Cadastro de Material</h2>
                            <p class="text-sm text-slate-500">Adicione um novo item ao estoque manualmente.</p>
                        </div>
                        
                        <form onsubmit="InventoryController.saveNewItem(event)" class="space-y-5">
                            <div class="grid grid-cols-2 gap-5">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Código</label>
                                    <input type="text" id="new-codigo" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all" placeholder="Ex: B.01.01.001" required />
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Cód. Interno</label>
                                    <input type="text" id="new-codigo-interno" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all" placeholder="Opcional" />
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Descrição do Material</label>
                                <input type="text" id="new-descricao" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all" placeholder="Nome completo do item" required />
                            </div>

                            <div class="grid grid-cols-2 gap-5">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Categoria</label>
                                    <select id="new-categoria" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all bg-white">
                                        <option value="DEPÓSITO GERAL">DEPÓSITO GERAL</option>
                                        <option value="DEPÓSITO C4 - GÁS">DEPÓSITO C4 - GÁS</option>
                                        <option value="DEPÓSITO 01 - IMPERMEABILIZAÇÃO">DEPÓSITO 01 - IMPERMEABILIZAÇÃO</option>
                                        <option value="DEPÓSITO 02 - TINTA ESMALTE">DEPÓSITO 02 - TINTA ESMALTE</option>
                                        <option value="DEPÓSITO 25 - TINTA ACRÍLICA">DEPÓSITO 25 - TINTA ACRÍLICA</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Unidade</label>
                                    <input type="text" id="new-unidade" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all" placeholder="Ex: Unidade" required />
                                </div>
                            </div>

                            <div class="grid grid-cols-3 gap-5 border-t border-slate-100 pt-5">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Estoque Inicial</label>
                                    <input type="number" id="new-estoque" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all" value="0" />
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Mínimo</label>
                                    <input type="number" id="new-minimo" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all" value="5" />
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Ressuprimento</label>
                                    <input type="number" id="new-ressup" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all" value="10" />
                                </div>
                            </div>

                            <div class="flex justify-end pt-4">
                                <button type="submit" class="px-6 py-2.5 bg-brand-600 text-white font-bold rounded-lg shadow-md hover:bg-brand-700 transition-all">
                                    Cadastrar Item
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
          lucide.createIcons();
        },
      };

      // --- Main Exports (Expose to Window) ---
      window.App = App;
      window.AuthController = AuthController;
      window.InventoryController = InventoryController;
      window.ModalManager = ModalManager;
      window.FirestoreService = FirestoreService;

      // --- Bootstrap ---
      document.addEventListener("DOMContentLoaded", () => App.init());
    </script>
  </body>
</html>